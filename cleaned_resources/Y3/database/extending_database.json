{
  "title": "extending",
  "language": "cpp",
  "topics": [
    "machine_learning",
    "web_dev",
    "fundamentals",
    "algorithms",
    "data_structures",
    "networking",
    "database"
  ],
  "purpose": "2.1.1 ASimpleExample .",
  "code": "2.1.4 TheModule\u2019sMethodTableandInitializationFunction . . . . . . . . . . . . . . . . . . 9\n2.1.5 CompilationandLinkage . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 11\n2.1.6 CallingPythonFunctionsfromC . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 11\n2.1.7 ExtractingParametersinExtensionFunctions . . . . . . . . . . . . . . . . . . . . . . . 13\n2.1.8 KeywordParametersforExtensionFunctions . . . . . . . . . . . . . . . . . . . . . . . . 14\n2.1.9 BuildingArbitraryValues . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 16\n2.1.10 ReferenceCounts . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 16\n2.1.11 WritingExtensionsinC++ . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 20\n2.1.12 ProvidingaCAPIforanExtensionModule . . . . . . . . . . . . . . . . . . . . . . . . 20\n2.2 DefiningExtensionTypes: Tutorial. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 23\n2.2.1 TheBasics . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 23\n2.2.2 AddingdataandmethodstotheBasicexample . . . . . . . . . . . . . . . . . . . . . . . 27\n2.2.3 Providingfinercontroloverdataattributes . . . . . . . . . . . . . . . . . . . . . . . . . 34\n2.2.4 Supportingcyclicgarbagecollection . . . . . . . . . . . . . . . . . . . . . . . . . . . . 39\n2.2.5 Subclassingothertypes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 44\n2.3 DefiningExtensionTypes: AssortedTopics . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 46\n2.3.1 FinalizationandDe-allocation. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 49\n2.3.2 ObjectPresentation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 50\n2.3.3 AttributeManagement . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 51\n2.3.4 ObjectComparison . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 53\n2.3.5 AbstractProtocolSupport . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 53\n2.3.6 WeakReferenceSupport . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 55\n2.3.7 MoreSuggestions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 55\n2.4 BuildingCandC++Extensions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 56\n2.4.1 BuildingCandC++Extensionswithsetuptools. . . . . . . . . . . . . . . . . . . . . . . 56\n2.5 BuildingCandC++ExtensionsonWindows. . . . . . . . . . . . . . . . . . . . . . . . . . . . . 56\n2.5.1 ACookbookApproach . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 57\n2.5.2 DifferencesBetweenUnixandWindows . . . . . . . . . . . . . . . . . . . . . . . . . . 57\n2.5.3 UsingDLLsinPractice . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 58\n3 EmbeddingtheCPythonruntimeinalargerapplication 59\n3.1 EmbeddingPythoninAnotherApplication . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 59\n3.1.1 VeryHighLevelEmbedding . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 59\n3.1.2 BeyondVeryHighLevelEmbedding: Anoverview . . . . . . . . . . . . . . . . . . . . . 60\n3.1.3 PureEmbedding. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 61\n3.1.4 ExtendingEmbeddedPython . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 63\n3.1.5 EmbeddingPythoninC++ . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 64\ni\n3.1.6 CompilingandLinkingunderUnix-likesystems . . . . . . . . . . . . . . . . . . . . . . 64\nA Glossary 67\nB Aboutthisdocumentation 85\nB.1 ContributorstothePythondocumentation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 85\nC HistoryandLicense 87\nC.1 Historyofthesoftware . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 87\nC.2 TermsandconditionsforaccessingorotherwiseusingPython . . . . . . . . . . . . . . . . . . . . 88\nC.2.1 PYTHONSOFTWAREFOUNDATIONLICENSEVERSION2 . . . . . . . . . . . . . 88\nC.2.2 BEOPEN.COMLICENSEAGREEMENTFORPYTHON2.0 . . . . . . . . . . . . . . 89\nC.2.3 CNRILICENSEAGREEMENTFORPYTHON1.6.1 . . . . . . . . . . . . . . . . . . 89\nC.2.4 CWILICENSEAGREEMENTFORPYTHON0.9.0THROUGH1.2 . . . . . . . . . . 90\nC.2.5 ZERO-CLAUSEBSDLICENSEFORCODEINTHEPYTHONDOCUMENTATION . 91\nC.3 LicensesandAcknowledgementsforIncorporatedSoftware . . . . . . . . . . . . . . . . . . . . . 91\nC.3.1 MersenneTwister . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 91\nC.3.2 Sockets . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 92\nC.3.3 Asynchronoussocketservices . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 93\nC.3.4 Cookiemanagement. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 93\nC.3.5 Executiontracing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 93\nC.3.6 UUencodeandUUdecodefunctions . . . . . . . . . . . . . . . . . . . . . . . . . . . . 94\nC.3.7 XMLRemoteProcedureCalls . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 95\nC.3.8 test_epoll . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 95\nC.3.9 Selectkqueue . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 96\nC.3.10 SipHash24 . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 96\nC.3.11 strtodanddtoa. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 97\nC.3.12 OpenSSL . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 97\nC.3.13 expat. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 100\nC.3.14 libffi . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 101\nC.3.15 zlib . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 101\nC.3.16 cfuhash . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 102\nC.3.17 libmpdec . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 102\nC.3.18 W3CC14Ntestsuite . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 103\nC.3.19 mimalloc . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 104\nC.3.20 asyncio . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 104\nC.3.21 GlobalUnboundedSequences(GUS) . . . . . . . . . . . . . . . . . . . . . . . . . . . . 104\nD Copyright 107\nIndex 109\nii\nExtendingandEmbeddingPython,Release3.13.3\nThis document describes how to write modules in C or C++ to extend the Python interpreter with new modules.\nThosemodulescannotonlydefinenewfunctionsbutalsonewobjecttypesandtheirmethods. Thedocumentalso\ndescribes how to embed the Python interpreter in another application, for use as an extension language. Finally,\nitshowshowtocompileandlinkextensionmodulessothattheycanbeloadeddynamically(atruntime)intothe\ninterpreter,iftheunderlyingoperatingsystemsupportsthisfeature.\nThisdocumentassumesbasicknowledgeaboutPython. Foraninformalintroductiontothelanguage,seetutorial-\nindex. reference-indexgivesamoreformaldefinitionofthelanguage. library-indexdocumentstheexistingobject\ntypes,functionsandmodules(bothbuilt-inandwritteninPython)thatgivethelanguageitswideapplicationrange.\nForadetaileddescriptionofthewholePython/CAPI,seetheseparatec-api-index.\nCONTENTS 1\nExtendingandEmbeddingPython,Release3.13.3\n2 CONTENTS\nCHAPTER\nONE\nRECOMMENDED THIRD PARTY TOOLS\nThisguideonlycoversthebasictoolsforcreatingextensionsprovidedaspartofthisversionofCPython. Thirdparty\ntoolslikeCython, cffi, SWIGandNumbaofferbothsimplerandmoresophisticatedapproachestocreatingCand\nC++extensionsforPython.\n(cid:181) Seealso\nPythonPackagingUserGuide: BinaryExtensions\nThePythonPackagingUserGuidenotonlycoversseveralavailabletoolsthatsimplifythecreationofbinary\nextensions, butalsodiscussesthevariousreasonswhycreatinganextensionmodulemaybedesirablein\nthefirstplace.\n3\nExtendingandEmbeddingPython,Release3.13.3\n4 Chapter1. Recommendedthirdpartytools\nCHAPTER\nTWO\nCREATING EXTENSIONS WITHOUT THIRD PARTY TOOLS\nThissectionoftheguidecoverscreatingCandC++extensionswithoutassistancefromthirdpartytools. Itisintended\nprimarilyforcreatorsofthosetools,ratherthanbeingarecommendedwaytocreateyourownCextensions.\n2.1 Extending Python with C or C++\nItisquiteeasytoaddnewbuilt-inmodulestoPython,ifyouknowhowtoprograminC.Suchextensionmodulescan\ndotwothingsthatcan\u2019tbedonedirectlyinPython: theycanimplementnewbuilt-inobjecttypes,andtheycancall\nClibraryfunctionsandsystemcalls.\nTosupportextensions,thePythonAPI(ApplicationProgrammersInterface)definesasetoffunctions,macrosand\nvariablesthatprovideaccesstomostaspectsofthePythonrun-timesystem. ThePythonAPIisincorporatedinaC\nsourcefilebyincludingtheheader\"Python.h\".\nThecompilationofanextensionmoduledependsonitsintendeduseaswellasonyoursystemsetup;detailsaregiven\ninlaterchapters.\n(cid:174) Note\nTheCextensioninterfaceisspecifictoCPython,andextensionmodulesdonotworkonotherPythonimplemen-\ntations. Inmanycases,itispossibletoavoidwritingCextensionsandpreserveportabilitytootherimplementa-\ntions. Forexample,ifyourusecaseiscallingClibraryfunctionsorsystemcalls,youshouldconsiderusingthe\nctypesmoduleorthecffilibraryratherthanwritingcustomCcode. ThesemodulesletyouwritePythoncode\ntointerfacewithCcodeandaremoreportablebetweenimplementationsofPythonthanwritingandcompiling\naCextensionmodule.\n2.1.1 A Simple Example\nLet\u2019screateanextensionmodulecalledspam(thefavoritefoodofMontyPythonfans\u2026)andlet\u2019ssaywewantto\ncreateaPythoninterfacetotheClibraryfunctionsystem()1. Thisfunctiontakesanull-terminatedcharacterstring\nasargumentandreturnsaninteger. WewantthisfunctiontobecallablefromPythonasfollows:\n>>> import spam\n>>> status = spam.system(\"ls -l\")\nBeginbycreatingafilespammodule.c. (Historically,ifamoduleiscalledspam,theCfilecontainingitsimple-\nmentationiscalledspammodule.c;ifthemodulenameisverylong,likespammify,themodulenamecanbejust\nspammify.c.)\nThefirsttwolinesofourfilecanbe:\n#define PY_SSIZE_T_CLEAN\n#include <Python.h>\n1Aninterfaceforthisfunctionalreadyexistsinthestandardmoduleos\u2014itwaschosenasasimpleandstraightforwardexample.\n5\nExtendingandEmbeddingPython,Release3.13.3\nwhichpullsinthePythonAPI(youcanaddacommentdescribingthepurposeofthemoduleandacopyrightnotice\nifyoulike).\n(cid:174) Note\nSincePythonmaydefinesomepre-processordefinitionswhichaffectthestandardheadersonsomesystems,you\nmustincludePython.hbeforeanystandardheadersareincluded.\n#define PY_SSIZE_T_CLEAN was used to indicatethat Py_ssize_t shouldbe used insomeAPIs instead\nofint. ItisnotnecessarysincePython3.13,butwekeepithereforbackwardcompatibility. Seearg-parsing-\nstring-and-buffersforadescriptionofthismacro.\nAlluser-visiblesymbolsdefinedby Python.h havea prefixof Py or PY,exceptthosedefinedinstandardheader\nfiles. Forconvenience, andsincetheyareusedextensivelybythePythoninterpreter, \"Python.h\"includesafew\nstandardheaderfiles: <stdio.h>,<string.h>,<errno.h>,and<stdlib.h>. Ifthelatterheaderfiledoesnot\nexistonyoursystem,itdeclaresthefunctionsmalloc(),free()andrealloc()directly.\nThe next thing we add to our module file is the C function that will be called when the Python expression spam.\nsystem(string)isevaluated(we\u2019llseeshortlyhowitendsupbeingcalled):\nstatic PyObject *\nspam_system(PyObject *self, PyObject *args)\n{\nconst char *command;\nint sts;\nif (!PyArg_ParseTuple(args, \"s\", &command))\nreturn NULL;\nsts = system(command);\nreturn PyLong_FromLong(sts);\n}\nThereisastraightforwardtranslationfromtheargumentlistinPython(forexample,thesingleexpression\"ls -l\")\ntotheargumentspassedtotheCfunction. TheCfunctionalwayshastwoarguments,conventionallynamedselfand\nargs.\nTheself argumentpointstothemoduleobjectformodule-levelfunctions;foramethoditwouldpointtotheobject\ninstance.\nThe args argument will be a pointer to a Python tuple object containing the arguments. Each item of the tuple\ncorrespondstoanargumentinthecall\u2019sargumentlist. TheargumentsarePythonobjects\u2014inordertodoanything\nwiththeminourCfunctionwehavetoconvertthemtoCvalues. ThefunctionPyArg_ParseTuple()inthePython\nAPIcheckstheargumenttypesandconvertsthemtoCvalues. Itusesatemplatestringtodeterminetherequired\ntypesoftheargumentsaswellasthetypesoftheCvariablesintowhichtostoretheconvertedvalues. Moreabout\nthislater.\nPyArg_ParseTuple() returnstrue (nonzero)if allargumentshave therighttype anditscomponents havebeen\nstoredinthevariableswhoseaddressesarepassed. Itreturnsfalse(zero)ifaninvalidargumentlistwaspassed. In\nthelattercaseitalsoraisesanappropriateexceptionsothecallingfunctioncanreturnNULLimmediately(aswesaw\nintheexample).\n2.1.2 Intermezzo: Errors and Exceptions\nAnimportantconventionthroughoutthePythoninterpreteristhefollowing: whenafunctionfails,itshouldsetan\nexception condition and return an error value (usually -1 or a NULL pointer). Exception information is stored in\nthree members of the interpreter\u2019s thread state. These are NULL if there is no exception. Otherwise they are the\nC equivalents of the members of the Python tuple returned by sys.exc_info(). These are the exception type,\nexceptioninstance,andatracebackobject. Itisimportanttoknowaboutthemtounderstandhowerrorsarepassed\naround.\n6 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\nThePythonAPIdefinesanumberoffunctionstosetvarioustypesofexceptions.\nThemostcommononeisPyErr_SetString(). ItsargumentsareanexceptionobjectandaCstring. Theexception\nobjectisusuallyapredefinedobjectlikePyExc_ZeroDivisionError. TheCstringindicatesthecauseoftheerror\nandisconvertedtoaPythonstringobjectandstoredasthe\u201cassociatedvalue\u201doftheexception.\nAnotherusefulfunctionisPyErr_SetFromErrno(),whichonlytakesanexceptionargumentandconstructsthe\nassociatedvaluebyinspectionoftheglobalvariableerrno. ThemostgeneralfunctionisPyErr_SetObject(),\nwhich takes two object arguments, the exception and its associated value. You don\u2019t need to Py_INCREF() the\nobjectspassedtoanyofthesefunctions.\nYoucantestnon-destructivelywhetheranexceptionhasbeensetwithPyErr_Occurred(). Thisreturnsthecurrent\nexceptionobject,orNULLifnoexceptionhasoccurred. Younormallydon\u2019tneedtocallPyErr_Occurred()tosee\nwhetheranerroroccurredinafunctioncall,sinceyoushouldbeabletotellfromthereturnvalue.\nWhen a function f that calls another function g detects that the latter fails, f should itself return an error value\n(usuallyNULLor-1). ItshouldnotcalloneofthePyErr_*functions\u2014onehasalreadybeencalledbyg. f\u2019scaller\nisthensupposedtoalsoreturnanerrorindicationtoitscaller,againwithoutcallingPyErr_*,andsoon\u2014themost\ndetailed cause of the error was already reported by the function that first detected it. Once the error reaches the\nPythoninterpreter\u2019smainloop,thisabortsthecurrentlyexecutingPythoncodeandtriestofindanexceptionhandler\nspecifiedbythePythonprogrammer.\n(TherearesituationswhereamodulecanactuallygiveamoredetailederrormessagebycallinganotherPyErr_*\nfunction, and in such cases it is fine to do so. As a general rule, however, this is not necessary, and can cause\ninformationaboutthecauseoftheerrortobelost: mostoperationscanfailforavarietyofreasons.)\nToignoreanexceptionsetbyafunctioncallthatfailed,theexceptionconditionmustbeclearedexplicitlybycalling\nPyErr_Clear(). TheonlytimeCcodeshouldcallPyErr_Clear()isifitdoesn\u2019twanttopasstheerrorontothe\ninterpreterbutwantstohandleitcompletelybyitself(possiblybytryingsomethingelse,orpretendingnothingwent\nwrong).\nEveryfailingmalloc()callmustbeturnedintoanexception\u2014thedirectcallerofmalloc()(orrealloc())\nmustcallPyErr_NoMemory()andreturnafailureindicatoritself. Alltheobject-creatingfunctions(forexample,\nPyLong_FromLong())alreadydothis,sothisnoteisonlyrelevanttothosewhocallmalloc()directly.\nAlsonotethat,withtheimportantexceptionofPyArg_ParseTuple()andfriends,functionsthatreturnaninteger\nstatususuallyreturnapositivevalueorzeroforsuccessand-1forfailure,likeUnixsystemcalls.\nFinally, be careful to clean up garbage (by making Py_XDECREF() or Py_DECREF() calls for objects you have\nalreadycreated)whenyoureturnanerrorindicator!\nThechoiceofwhichexceptiontoraiseisentirelyyours. TherearepredeclaredCobjectscorrespondingtoallbuilt-in\nPythonexceptions,suchasPyExc_ZeroDivisionError,whichyoucanusedirectly. Ofcourse,youshouldchoose\nexceptionswisely\u2014don\u2019tusePyExc_TypeErrortomeanthatafilecouldn\u2019tbeopened(thatshouldprobablybe\nPyExc_OSError). Ifsomething\u2019swrongwiththeargumentlist,thePyArg_ParseTuple()functionusuallyraises\nPyExc_TypeError. If you have an argument whose value must be in a particular range or must satisfy other\nconditions,PyExc_ValueErrorisappropriate.\nYoucanalsodefineanewexceptionthatisuniquetoyourmodule. Forthis,youusuallydeclareastaticobjectvariable\natthebeginningofyourfile:\nstatic PyObject *SpamError;\nandinitializeitinyourmodule\u2019sinitializationfunction(PyInit_spam())withanexceptionobject:\nPyMODINIT_FUNC\nPyInit_spam(void)\n{\nPyObject *m;\nm = PyModule_Create(&spammodule);\nif (m == NULL)\nreturn NULL;\n(continuesonnextpage)\n2.1. ExtendingPythonwithCorC++ 7\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nSpamError = PyErr_NewException(\"spam.error\", NULL, NULL);\nif (PyModule_AddObjectRef(m, \"error\", SpamError) < 0) {\nPy_CLEAR(SpamError);\nPy_DECREF(m);\nreturn NULL;\n}\nreturn m;\n}\nNotethatthePythonnamefortheexceptionobjectisspam.error. ThePyErr_NewException()functionmay\ncreateaclasswiththebaseclassbeingException(unlessanotherclassispassedininsteadofNULL),describedin\nbltin-exceptions.\nNotealsothattheSpamErrorvariableretainsareferencetothenewlycreatedexceptionclass; thisisintentional!\nSincetheexceptioncouldberemovedfromthemodulebyexternalcode,anownedreferencetotheclassisneededto\nensurethatitwillnotbediscarded,causingSpamErrortobecomeadanglingpointer. Shoulditbecomeadangling\npointer,Ccodewhichraisestheexceptioncouldcauseacoredumporotherunintendedsideeffects.\nWediscusstheuseofPyMODINIT_FUNCasafunctionreturntypelaterinthissample.\nThespam.errorexceptioncanberaisedinyourextensionmoduleusingacalltoPyErr_SetString()asshown\nbelow:\nstatic PyObject *\nspam_system(PyObject *self, PyObject *args)\n{\nconst char *command;\nint sts;\nif (!PyArg_ParseTuple(args, \"s\", &command))\nreturn NULL;\nsts = system(command);\nif (sts < 0) {\nPyErr_SetString(SpamError, \"System command failed\");\nreturn NULL;\n}\nreturn PyLong_FromLong(sts);\n}\n2.1.3 Back to the Example\nGoingbacktoourexamplefunction,youshouldnowbeabletounderstandthisstatement:\nif (!PyArg_ParseTuple(args, \"s\", &command))\nreturn NULL;\nIt returns NULL (the error indicator for functions returning object pointers) if an error is detected in the argument\nlist,relyingontheexceptionsetbyPyArg_ParseTuple(). Otherwisethestringvalueoftheargumenthasbeen\ncopiedtothelocalvariablecommand. Thisisapointerassignmentandyouarenotsupposedtomodifythestringto\nwhichitpoints(soinStandardC,thevariablecommandshouldproperlybedeclaredasconst char *command).\nThe next statement is a call to the Unix function system(), passing it the string we just got from\nPyArg_ParseTuple():\nsts = system(command);\n8 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\nOur spam.system() function must return the value of sts as a Python object. This is done using the function\nPyLong_FromLong().\nreturn PyLong_FromLong(sts);\nInthiscase,itwillreturnanintegerobject. (Yes,evenintegersareobjectsontheheapinPython!)\nIf you have a C function that returns no useful argument (a function returning void), the corresponding Python\nfunctionmustreturnNone. Youneedthisidiomtodoso(whichisimplementedbythePy_RETURN_NONEmacro):\nPy_INCREF(Py_None);\nreturn Py_None;\nPy_NoneistheCnameforthespecialPythonobjectNone. ItisagenuinePythonobjectratherthanaNULLpointer,\nwhichmeans\u201cerror\u201dinmostcontexts,aswehaveseen.\n2.1.4 The Module\u2019s Method Table and Initialization Function\nIpromisedtoshowhowspam_system()iscalledfromPythonprograms. First,weneedtolistitsnameandaddress\nina\u201cmethodtable\u201d:\nstatic PyMethodDef SpamMethods[] = {\n...\n{\"system\", spam_system, METH_VARARGS,\n\"Execute a shell command.\"},\n...\n{NULL, NULL, 0, NULL} /* Sentinel */\n};\nNotethethirdentry(METH_VARARGS).Thisisaflagtellingtheinterpreterthecallingconventiontobeusedforthe\nC function. It should normally always be METH_VARARGS or METH_VARARGS | METH_KEYWORDS; a value of 0\nmeansthatanobsoletevariantofPyArg_ParseTuple()isused.\nWhenusingonlyMETH_VARARGS,thefunctionshouldexpectthePython-levelparameterstobepassedinasatuple\nacceptableforparsingviaPyArg_ParseTuple();moreinformationonthisfunctionisprovidedbelow.\nThe METH_KEYWORDS bit may be set in the third field if keyword arguments should be passed to the function. In\nthiscase,theCfunctionshouldacceptathirdPyObject *parameterwhichwillbeadictionaryofkeywords. Use\nPyArg_ParseTupleAndKeywords()toparsetheargumentstosuchafunction.\nThemethodtablemustbereferencedinthemoduledefinitionstructure:\nstatic struct PyModuleDef spammodule = {\nPyModuleDef_HEAD_INIT,\n\"spam\", /* name of module */\nspam_doc, /* module documentation, may be NULL */\n-1, /* size of per-interpreter state of the module,\nor -1 if the module keeps state in global variables. */\nSpamMethods\n};\nThis structure, in turn, must be passed to the interpreter in the module\u2019s initialization function. The initialization\nfunction must be named PyInit_name(), where name is the name of the module, and should be the only non-\nstaticitemdefinedinthemodulefile:\nPyMODINIT_FUNC\nPyInit_spam(void)\n{\nreturn PyModule_Create(&spammodule);\n}\n2.1. ExtendingPythonwithCorC++ 9\nExtendingandEmbeddingPython,Release3.13.3\nNotethatPyMODINIT_FUNCdeclaresthefunctionasPyObject *returntype,declaresanyspeciallinkagedecla-\nrationsrequiredbytheplatform,andforC++declaresthefunctionasextern \"C\".\nWhen the Python program imports module spam for the first time, PyInit_spam() is called. (See below for\ncomments about embedding Python.) It calls PyModule_Create(), which returns a module object, and inserts\nbuilt-infunctionobjectsintothenewlycreatedmodulebaseduponthetable(anarrayofPyMethodDefstructures)\nfoundinthemoduledefinition. PyModule_Create()returnsapointertothemoduleobjectthatitcreates. Itmay\nabortwithafatalerrorforcertainerrors,orreturnNULLifthemodulecouldnotbeinitializedsatisfactorily. Theinit\nfunctionmustreturnthemoduleobjecttoitscaller,sothatitthengetsinsertedintosys.modules.\nWhen embedding Python, the PyInit_spam() function is not called automatically unless there\u2019s an entry in the\nPyImport_Inittab table. To add the module to the initialization table, use PyImport_AppendInittab(),\noptionallyfollowedbyanimportofthemodule:\n#define PY_SSIZE_T_CLEAN\n#include <Python.h>\nint\nmain(int argc, char *argv[])\n{\nPyStatus status;\nPyConfig config;\nPyConfig_InitPythonConfig(&config);\n/* Add a built-in module, before Py_Initialize */\nif (PyImport_AppendInittab(\"spam\", PyInit_spam) == -1) {\nfprintf(stderr, \"Error: could not extend in-built modules table\\n\");\nexit(1);\n}\n/* Pass argv[0] to the Python interpreter */\nstatus = PyConfig_SetBytesString(&config, &config.program_name, argv[0]);\nif (PyStatus_Exception(status)) {\ngoto exception;\n}\n/* Initialize the Python interpreter. Required.\nIf this step fails, it will be a fatal error. */\nstatus = Py_InitializeFromConfig(&config);\nif (PyStatus_Exception(status)) {\ngoto exception;\n}\nPyConfig_Clear(&config);\n/* Optionally import the module; alternatively,\nimport can be deferred until the embedded script\nimports it. */\nPyObject *pmodule = PyImport_ImportModule(\"spam\");\nif (!pmodule) {\nPyErr_Print();\nfprintf(stderr, \"Error: could not import module 'spam'\\n\");\n}\n// ... use Python C API here ...\nreturn 0;\nexception:\nPyConfig_Clear(&config);\n(continuesonnextpage)\n10 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nPy_ExitStatusException(status);\n}\n(cid:174) Note\nRemovingentriesfromsys.modulesorimportingcompiledmodulesintomultipleinterpreterswithinapro-\ncess(orfollowingafork()withoutaninterveningexec())cancreateproblemsforsomeextensionmodules.\nExtensionmoduleauthorsshouldexercisecautionwheninitializinginternaldatastructures.\nAmoresubstantialexamplemoduleisincludedinthePythonsourcedistributionasModules/xxmodule.c. This\nfilemaybeusedasatemplateorsimplyreadasanexample.\n(cid:174) Note\nUnlikeourspamexample,xxmoduleusesmulti-phaseinitialization(newinPython3.5),whereaPyModuleDef\nstructureisreturnedfromPyInit_spam,andcreationofthemoduleislefttotheimportmachinery. Fordetails\nonmulti-phaseinitialization,seePEP489.\n2.1.5 Compilation and Linkage\nTherearetwomorethingstodobeforeyoucanuseyournewextension: compilingandlinkingitwiththePython\nsystem. Ifyouusedynamicloading,thedetailsmaydependonthestyleofdynamicloadingyoursystemuses;seethe\nchaptersaboutbuildingextensionmodules(chapterBuildingCandC++Extensions)andadditionalinformationthat\npertainsonlytobuildingonWindows(chapterBuildingCandC++ExtensionsonWindows)formoreinformation\naboutthis.\nIfyoucan\u2019tusedynamicloading,orifyouwanttomakeyourmoduleapermanentpartofthePythoninterpreter,\nyouwillhavetochangetheconfigurationsetupandrebuildtheinterpreter. Luckily,thisisverysimpleonUnix: just\nplaceyourfile(spammodule.cforexample)intheModules/directoryofanunpackedsourcedistribution,adda\nlinetothefileModules/Setup.localdescribingyourfile:\nspam spammodule.o\nand rebuild the interpreter by running make in the toplevel directory. You can also run make in the Modules/\nsubdirectory,butthenyoumustfirstrebuildMakefiletherebyrunning\u2018makeMakefile\u2019. (Thisisnecessaryeach\ntimeyouchangetheSetupfile.)\nIf your module requires additional libraries to link with, these can be listed on the line in the configuration file as\nwell,forinstance:\nspam spammodule.o -lX11\n2.1.6 Calling Python Functions from C\nSofarwehaveconcentratedonmakingCfunctionscallablefromPython. Thereverseisalsouseful: callingPython\nfunctionsfromC.Thisisespeciallythecaseforlibrariesthatsupportso-called\u201ccallback\u201dfunctions. IfaCinterface\nmakesuseofcallbacks,theequivalentPythonoftenneedstoprovideacallbackmechanismtothePythonprogram-\nmer; theimplementationwillrequirecallingthePythoncallbackfunctionsfromaCcallback. Otherusesarealso\nimaginable.\nFortunately, the Python interpreter is easily called recursively, and there is a standard interface to call a Python\nfunction. (Iwon\u2019tdwellonhowtocallthePythonparserwithaparticularstringasinput\u2014ifyou\u2019reinterested,have\nalookattheimplementationofthe-ccommandlineoptioninModules/main.cfromthePythonsourcecode.)\nCalling a Python function is easy. First, the Python program must somehow pass you the Python function object.\nYoushouldprovideafunction(orsomeotherinterface)todothis. Whenthisfunctioniscalled,saveapointertothe\n2.1. ExtendingPythonwithCorC++ 11\nExtendingandEmbeddingPython,Release3.13.3\nPythonfunctionobject(becarefultoPy_INCREF()it!) inaglobalvariable\u2014orwhereveryouseefit. Forexample,\nthefollowingfunctionmightbepartofamoduledefinition:\nstatic PyObject *my_callback = NULL;\nstatic PyObject *\nmy_set_callback(PyObject *dummy, PyObject *args)\n{\nPyObject *result = NULL;\nPyObject *temp;\nif (PyArg_ParseTuple(args, \"O:set_callback\", &temp)) {\nif (!PyCallable_Check(temp)) {\nPyErr_SetString(PyExc_TypeError, \"parameter must be callable\");\nreturn NULL;\n}\nPy_XINCREF(temp); /* Add a reference to new callback */\nPy_XDECREF(my_callback); /* Dispose of previous callback */\nmy_callback = temp; /* Remember new callback */\n/* Boilerplate to return \"None\" */\nPy_INCREF(Py_None);\nresult = Py_None;\n}\nreturn result;\n}\nThis function must be registered with the interpreter using the METH_VARARGS flag; this is described in section\nTheModule\u2019sMethodTableandInitializationFunction. ThePyArg_ParseTuple()functionanditsargumentsare\ndocumentedinsectionExtractingParametersinExtensionFunctions.\nThemacrosPy_XINCREF()andPy_XDECREF()increment/decrementthereferencecountofanobjectandaresafe\ninthepresenceofNULLpointers(butnotethattempwillnotbeNULLinthiscontext). Moreinfoontheminsection\nReferenceCounts.\nLater, whenitistimetocallthefunction, youcalltheCfunctionPyObject_CallObject(). Thisfunctionhas\ntwoarguments,bothpointerstoarbitraryPythonobjects: thePythonfunction,andtheargumentlist. Theargument\nlist must always be a tuple object, whose length is the number of arguments. To call the Python function with no\narguments,passinNULL,oranemptytuple;tocallitwithoneargument,passasingletontuple. Py_BuildValue()\nreturnsatuplewhenitsformatstringconsistsofzeroormoreformatcodesbetweenparentheses. Forexample:\nint arg;\nPyObject *arglist;\nPyObject *result;\n...\narg = 123;\n...\n/* Time to call the callback */\narglist = Py_BuildValue(\"(i)\", arg);\nresult = PyObject_CallObject(my_callback, arglist);\nPy_DECREF(arglist);\nPyObject_CallObject() returns a Python object pointer: this is the return value of the Python func-\ntion. PyObject_CallObject() is \u201creference-count-neutral\u201d with respect to its arguments. In the exam-\nple a new tuple was created to serve as the argument list, which is Py_DECREF()-ed immediately after the\nPyObject_CallObject()call.\nThereturnvalueofPyObject_CallObject()is\u201cnew\u201d: eitheritisabrandnewobject,oritisanexistingobject\nwhosereferencecounthasbeenincremented. So,unlessyouwanttosaveitinaglobalvariable,youshouldsomehow\nPy_DECREF()theresult,even(especially!) ifyouarenotinterestedinitsvalue.\nBefore you do this, however, it is important to check that the return value isn\u2019t NULL. If it is, the Python function\n12 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\nterminatedbyraisinganexception. IftheCcodethatcalledPyObject_CallObject()iscalledfromPython,it\nshould now return an error indication to its Python caller, so the interpreter can print a stack trace, or the calling\nPythoncodecanhandletheexception. Ifthisisnotpossibleordesirable,theexceptionshouldbeclearedbycalling\nPyErr_Clear(). Forexample:\nif (result == NULL)\nreturn NULL; /* Pass error back */\n...use result...\nPy_DECREF(result);\nDependingonthedesiredinterfacetothePythoncallbackfunction,youmayalsohavetoprovideanargumentlistto\nPyObject_CallObject(). InsomecasestheargumentlistisalsoprovidedbythePythonprogram,throughthe\nsameinterfacethatspecifiedthecallbackfunction. Itcanthenbesavedandusedinthesamemannerasthefunction\nobject. Inothercases,youmayhavetoconstructanewtupletopassastheargumentlist. Thesimplestwaytodothis\nistocallPy_BuildValue(). Forexample,ifyouwanttopassanintegraleventcode,youmightusethefollowing\ncode:\nPyObject *arglist;\n...\narglist = Py_BuildValue(\"(l)\", eventcode);\nresult = PyObject_CallObject(my_callback, arglist);\nPy_DECREF(arglist);\nif (result == NULL)\nreturn NULL; /* Pass error back */\n/* Here maybe use the result */\nPy_DECREF(result);\nNotetheplacementofPy_DECREF(arglist)immediatelyafterthecall, beforetheerrorcheck! Alsonotethat\nstrictlyspeakingthiscodeisnotcomplete: Py_BuildValue()mayrunoutofmemory,andthisshouldbechecked.\nYoumayalsocallafunctionwithkeywordargumentsbyusingPyObject_Call(),whichsupportsargumentsand\nkeywordarguments. Asintheaboveexample,weusePy_BuildValue()toconstructthedictionary.\nPyObject *dict;\n...\ndict = Py_BuildValue(\"{s:i}\", \"name\", val);\nresult = PyObject_Call(my_callback, NULL, dict);\nPy_DECREF(dict);\nif (result == NULL)\nreturn NULL; /* Pass error back */\n/* Here maybe use the result */\nPy_DECREF(result);\n2.1.7 Extracting Parameters in Extension Functions\nThePyArg_ParseTuple()functionisdeclaredasfollows:\nint PyArg_ParseTuple(PyObject *arg, const char *format, ...);\nTheargargumentmustbeatupleobjectcontaininganargumentlistpassedfromPythontoaCfunction. Theformat\nargumentmustbeaformatstring,whosesyntaxisexplainedinarg-parsinginthePython/CAPIReferenceManual.\nTheremainingargumentsmustbeaddressesofvariableswhosetypeisdeterminedbytheformatstring.\nNotethatwhilePyArg_ParseTuple()checksthatthePythonargumentshavetherequiredtypes,itcannotcheck\nthevalidityoftheaddressesofCvariablespassedtothecall: ifyoumakemistakesthere,yourcodewillprobably\ncrashoratleastoverwriterandombitsinmemory. Sobecareful!\nNotethatanyPythonobjectreferenceswhichareprovidedtothecallerareborrowedreferences;donotdecrement\ntheirreferencecount!\nSomeexamplecalls:\n2.1. ExtendingPythonwithCorC++ 13\nExtendingandEmbeddingPython,Release3.13.3\n#define PY_SSIZE_T_CLEAN\n#include <Python.h>\nint ok;\nint i, j;\nlong k, l;\nconst char *s;\nPy_ssize_t size;\nok = PyArg_ParseTuple(args, \"\"); /* No arguments */\n/* Python call: f() */\nok = PyArg_ParseTuple(args, \"s\", &s); /* A string */\n/* Possible Python call: f('whoops!') */\nok = PyArg_ParseTuple(args, \"lls\", &k, &l, &s); /* Two longs and a string */\n/* Possible Python call: f(1, 2, 'three') */\nok = PyArg_ParseTuple(args, \"(ii)s#\", &i, &j, &s, &size);\n/* A pair of ints and a string, whose size is also returned */\n/* Possible Python call: f((1, 2), 'three') */\n{\nconst char *file;\nconst char *mode = \"r\";\nint bufsize = 0;\nok = PyArg_ParseTuple(args, \"s|si\", &file, &mode, &bufsize);\n/* A string, and optionally another string and an integer */\n/* Possible Python calls:\nf('spam')\nf('spam', 'w')\nf('spam', 'wb', 100000) */\n}\n{\nint left, top, right, bottom, h, v;\nok = PyArg_ParseTuple(args, \"((ii)(ii))(ii)\",\n&left, &top, &right, &bottom, &h, &v);\n/* A rectangle and a point */\n/* Possible Python call:\nf(((0, 0), (400, 300)), (10, 10)) */\n}\n{\nPy_complex c;\nok = PyArg_ParseTuple(args, \"D:myfunction\", &c);\n/* a complex, also providing a function name for errors */\n/* Possible Python call: myfunction(1+2j) */\n}\n2.1.8 Keyword Parameters for Extension Functions\nThePyArg_ParseTupleAndKeywords()functionisdeclaredasfollows:\n14 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\nint PyArg_ParseTupleAndKeywords(PyObject *arg, PyObject *kwdict,\nconst char *format, char * const *kwlist, ...);\nTheargandformatparametersareidenticaltothoseofthePyArg_ParseTuple()function. Thekwdictparameter\nis the dictionary of keywords received as the third parameter from the Python runtime. The kwlist parameter is a\nNULL-terminatedlistofstringswhichidentifytheparameters;thenamesarematchedwiththetypeinformationfrom\nformatfromlefttoright. Onsuccess,PyArg_ParseTupleAndKeywords()returnstrue,otherwiseitreturnsfalse\nandraisesanappropriateexception.\n(cid:174) Note\nNestedtuplescannotbeparsedwhenusingkeywordarguments! Keywordparameterspassedinwhicharenot\npresentinthekwlistwillcauseTypeErrortoberaised.\nHereisanexamplemodulewhichuseskeywords,basedonanexamplebyGeoffPhilbrick(philbrick@hks.com):\n#define PY_SSIZE_T_CLEAN\n#include <Python.h>\nstatic PyObject *\nkeywdarg_parrot(PyObject *self, PyObject *args, PyObject *keywds)\n{\nint voltage;\nconst char *state = \"a stiff\";\nconst char *action = \"voom\";\nconst char *type = \"Norwegian Blue\";\nstatic char *kwlist[] = {\"voltage\", \"state\", \"action\", \"type\", NULL};\nif (!PyArg_ParseTupleAndKeywords(args, keywds, \"i|sss\", kwlist,\n&voltage, &state, &action, &type))\nreturn NULL;\nprintf(\"-- This parrot wouldn't %s if you put %i Volts through it.\\n\",\naction, voltage);\nprintf(\"-- Lovely plumage, the %s -- It's %s!\\n\", type, state);\nPy_RETURN_NONE;\n}\nstatic PyMethodDef keywdarg_methods[] = {\n/* The cast of the function is necessary since PyCFunction values\n* only take two PyObject* parameters, and keywdarg_parrot() takes\n* three.\n*/\n{\"parrot\", (PyCFunction)(void(*)(void))keywdarg_parrot, METH_VARARGS | METH_\n,\u2192KEYWORDS,\n\"Print a lovely skit to standard output.\"},\n{NULL, NULL, 0, NULL} /* sentinel */\n};\nstatic struct PyModuleDef keywdargmodule = {\nPyModuleDef_HEAD_INIT,\n\"keywdarg\",\nNULL,\n-1,\n(continuesonnextpage)\n2.1. ExtendingPythonwithCorC++ 15\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nkeywdarg_methods\n};\nPyMODINIT_FUNC\nPyInit_keywdarg(void)\n{\nreturn PyModule_Create(&keywdargmodule);\n}\n2.1.9 Building Arbitrary Values\nThisfunctionisthecounterparttoPyArg_ParseTuple(). Itisdeclaredasfollows:\nPyObject *Py_BuildValue(const char *format, ...);\nIt recognizes a set of format units similar to the ones recognized by PyArg_ParseTuple(), but the arguments\n(whichareinputtothefunction,notoutput)mustnotbepointers,justvalues. ItreturnsanewPythonobject,suitable\nforreturningfromaCfunctioncalledfromPython.\nOnedifferencewithPyArg_ParseTuple(): whilethelatterrequiresitsfirstargumenttobeatuple(sincePython\nargument lists are always represented as tuples internally), Py_BuildValue() does not always build a tuple. It\nbuilds a tuple only if its format string contains two or more format units. If the format string is empty, it returns\nNone;ifitcontainsexactlyoneformatunit,itreturnswhateverobjectisdescribedbythatformatunit. Toforceitto\nreturnatupleofsize0orone,parenthesizetheformatstring.\nExamples(totheleftthecall,totherighttheresultingPythonvalue):\nPy_BuildValue(\"\") None\nPy_BuildValue(\"i\", 123) 123\nPy_BuildValue(\"iii\", 123, 456, 789) (123, 456, 789)\nPy_BuildValue(\"s\", \"hello\") 'hello'\nPy_BuildValue(\"y\", \"hello\") b'hello'\nPy_BuildValue(\"ss\", \"hello\", \"world\") ('hello', 'world')\nPy_BuildValue(\"s#\", \"hello\", 4) 'hell'\nPy_BuildValue(\"y#\", \"hello\", 4) b'hell'\nPy_BuildValue(\"()\") ()\nPy_BuildValue(\"(i)\", 123) (123,)\nPy_BuildValue(\"(ii)\", 123, 456) (123, 456)\nPy_BuildValue(\"(i,i)\", 123, 456) (123, 456)\nPy_BuildValue(\"[i,i]\", 123, 456) [123, 456]\nPy_BuildValue(\"{s:i,s:i}\",\n\"abc\", 123, \"def\", 456) {'abc': 123, 'def': 456}\nPy_BuildValue(\"((ii)(ii)) (ii)\",\n1, 2, 3, 4, 5, 6) (((1, 2), (3, 4)), (5, 6))\n2.1.10 Reference Counts\nInlanguageslikeCorC++,theprogrammerisresponsiblefordynamicallocationanddeallocationofmemoryon\ntheheap. InC,thisisdoneusingthefunctionsmalloc()andfree(). InC++,theoperatorsnewanddeleteare\nusedwithessentiallythesamemeaningandwe\u2019llrestrictthefollowingdiscussiontotheCcase.\nEvery block of memory allocated with malloc() should eventually be returned to the pool of available memory\nbyexactlyonecalltofree(). Itisimportanttocallfree()attherighttime. Ifablock\u2019saddressisforgottenbut\nfree()isnotcalledforit,thememoryitoccupiescannotbereuseduntiltheprogramterminates. Thisiscalleda\nmemoryleak. Ontheotherhand,ifaprogramcallsfree()forablockandthencontinuestousetheblock,itcreates\naconflictwithreuseoftheblockthroughanothermalloc()call. Thisiscalledusingfreedmemory. Ithasthesame\nbadconsequencesasreferencinguninitializeddata\u2014coredumps,wrongresults,mysteriouscrashes.\n16 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\nCommoncausesofmemoryleaksareunusualpathsthroughthecode. Forinstance,afunctionmayallocateablock\nofmemory,dosomecalculation,andthenfreetheblockagain. Nowachangeintherequirementsforthefunction\nmayaddatesttothecalculationthatdetectsanerrorconditionandcanreturnprematurelyfromthefunction. It\u2019s\neasytoforgettofreetheallocatedmemoryblockwhentakingthisprematureexit,especiallywhenitisaddedlater\ntothecode. Suchleaks,onceintroduced,oftengoundetectedforalongtime: theerrorexitistakenonlyinasmall\nfractionofallcalls,andmostmodernmachineshaveplentyofvirtualmemory,sotheleakonlybecomesapparent\ninalong-runningprocessthatusestheleakingfunctionfrequently. Therefore,it\u2019simportanttopreventleaksfrom\nhappeningbyhavingacodingconventionorstrategythatminimizesthiskindoferrors.\nSincePythonmakesheavyuseofmalloc()andfree(),itneedsastrategytoavoidmemoryleaksaswellasthe\nuseoffreedmemory. Thechosenmethodiscalledreferencecounting. Theprincipleissimple: everyobjectcontains\nacounter,whichisincrementedwhenareferencetotheobjectisstoredsomewhere,andwhichisdecrementedwhen\nareferencetoitisdeleted. Whenthecounterreacheszero,thelastreferencetotheobjecthasbeendeletedandthe\nobjectisfreed.\nAnalternativestrategyiscalledautomaticgarbagecollection. (Sometimes,referencecountingisalsoreferredtoas\nagarbagecollectionstrategy,hencemyuseof\u201cautomatic\u201dtodistinguishthetwo.) Thebigadvantageofautomatic\ngarbagecollectionisthattheuserdoesn\u2019tneedtocallfree()explicitly. (Anotherclaimedadvantageisanimprove-\nmentinspeedormemoryusage\u2014thisisnohardfacthowever.) ThedisadvantageisthatforC,thereisnotruly\nportableautomaticgarbagecollector,whilereferencecountingcanbeimplementedportably(aslongasthefunctions\nmalloc()andfree()areavailable\u2014whichtheCStandardguarantees). Maybesomedayasufficientlyportable\nautomaticgarbagecollectorwillbeavailableforC.Untilthen,we\u2019llhavetolivewithreferencecounts.\nWhile Python uses the traditional reference counting implementation, it also offers a cycle detector that works to\ndetect reference cycles. This allows applications to not worry about creating direct or indirect circular references;\nthesearetheweaknessofgarbagecollectionimplementedusingonlyreferencecounting. Referencecyclesconsist\nofobjectswhichcontain(possiblyindirect)referencestothemselves,sothateachobjectinthecyclehasareference\ncountwhichisnon-zero. Typicalreferencecountingimplementationsarenotabletoreclaimthememorybelonging\nto any objects in a reference cycle, or referenced from the objects in the cycle, even though there are no further\nreferencestothecycleitself.\nThe cycle detector is able to detect garbage cycles and can reclaim them. The gc module exposes a way to run\nthedetector(thecollect()function),aswellasconfigurationinterfacesandtheabilitytodisablethedetectorat\nruntime.\nReferenceCountinginPython\nTherearetwomacros,Py_INCREF(x)andPy_DECREF(x),whichhandletheincrementinganddecrementingof\nthereferencecount. Py_DECREF()alsofreestheobjectwhenthecountreacheszero. Forflexibility,itdoesn\u2019tcall\nfree()directly\u2014rather,itmakesacallthroughafunctionpointerintheobject\u2019stypeobject. Forthispurpose(and\nothers),everyobjectalsocontainsapointertoitstypeobject.\nThebigquestionnowremains: whentousePy_INCREF(x)andPy_DECREF(x)? Let\u2019sfirstintroducesometerms.\nNobody\u201cowns\u201danobject;however,youcanownareferencetoanobject. Anobject\u2019sreferencecountisnowdefined\nasthenumberofownedreferencestoit. TheownerofareferenceisresponsibleforcallingPy_DECREF()whenthe\nreferenceisnolongerneeded. Ownershipofareferencecanbetransferred. Therearethreewaystodisposeofan\nownedreference: passiton,storeit,orcallPy_DECREF(). Forgettingtodisposeofanownedreferencecreatesa\nmemoryleak.\nItisalsopossibletoborrow2 areferencetoanobject. TheborrowerofareferenceshouldnotcallPy_DECREF().\nTheborrowermustnotholdontotheobjectlongerthantheownerfromwhichitwasborrowed. Usingaborrowed\nreferenceaftertheownerhasdisposedofitrisksusingfreedmemoryandshouldbeavoidedcompletely3.\nTheadvantageofborrowingoverowningareferenceisthatyoudon\u2019tneedtotakecareofdisposingofthereference\nonallpossiblepathsthroughthecode\u2014inotherwords,withaborrowedreferenceyoudon\u2019truntheriskofleaking\nwhenaprematureexitistaken. Thedisadvantageofborrowingoverowningisthattherearesomesubtlesituations\nwhereinseeminglycorrectcodeaborrowedreferencecanbeusedaftertheownerfromwhichitwasborrowedhas\ninfactdisposedofit.\n2Themetaphorof\u201cborrowing\u201dareferenceisnotcompletelycorrect:theownerstillhasacopyofthereference.\n3Checkingthatthereferencecountisatleast1doesnotwork\u2014thereferencecountitselfcouldbeinfreedmemoryandmaythusbereused\nforanotherobject!\n2.1. ExtendingPythonwithCorC++ 17\nExtendingandEmbeddingPython,Release3.13.3\nAborrowedreferencecanbechangedintoanownedreferencebycallingPy_INCREF(). Thisdoesnotaffectthe\nstatusoftheownerfromwhichthereferencewasborrowed\u2014itcreatesanewownedreference,andgivesfullowner\nresponsibilities(thenewownermustdisposeofthereferenceproperly,aswellasthepreviousowner).\nOwnershipRules\nWhenever an object reference is passed into or out of a function, it is part of the function\u2019s interface specification\nwhetherownershipistransferredwiththereferenceornot.\nMostfunctionsthatreturnareferencetoanobjectpassonownershipwiththereference. Inparticular,allfunctions\nwhosefunctionitistocreateanewobject,suchasPyLong_FromLong()andPy_BuildValue(),passownership\ntothereceiver. Eveniftheobjectisnotactuallynew,youstillreceiveownershipofanewreferencetothatobject.\nForinstance,PyLong_FromLong()maintainsacacheofpopularvaluesandcanreturnareferencetoacacheditem.\nMany functions that extract objects from other objects also transfer ownership with the reference, for instance\nPyObject_GetAttrString(). The picture is less clear, here, however, since a few common routines are ex-\nceptions: PyTuple_GetItem(),PyList_GetItem(),PyDict_GetItem(),andPyDict_GetItemString()\nallreturnreferencesthatyouborrowfromthetuple,listordictionary.\nThefunctionPyImport_AddModule()alsoreturnsaborrowedreference,eventhoughitmayactuallycreatethe\nobjectitreturns: thisispossiblebecauseanownedreferencetotheobjectisstoredinsys.modules.\nWhenyoupassanobjectreferenceintoanotherfunction,ingeneral,thefunctionborrowsthereferencefromyou\u2014\nifitneedstostoreit,itwillusePy_INCREF()tobecomeanindependentowner. Thereareexactlytwoimportant\nexceptionstothisrule: PyTuple_SetItem()andPyList_SetItem(). Thesefunctionstakeoverownershipof\ntheitempassedtothem\u2014eveniftheyfail! (NotethatPyDict_SetItem()andfriendsdon\u2019ttakeoverownership\n\u2014theyare\u201cnormal.\u201d)\nWhenaCfunctioniscalledfromPython,itborrowsreferencestoitsargumentsfromthecaller. Thecallerownsa\nreferencetotheobject,sotheborrowedreference\u2019slifetimeisguaranteeduntilthefunctionreturns. Onlywhensucha\nborrowedreferencemustbestoredorpassedon,itmustbeturnedintoanownedreferencebycallingPy_INCREF().\nTheobjectreferencereturnedfromaCfunctionthatiscalledfromPythonmustbeanownedreference\u2014ownership\nistransferredfromthefunctiontoitscaller.\nThinIce\nThereareafewsituationswhereseeminglyharmlessuseofaborrowedreferencecanleadtoproblems. Theseall\nhavetodowithimplicitinvocationsoftheinterpreter,whichcancausetheownerofareferencetodisposeofit.\nThefirstandmostimportantcasetoknowaboutisusingPy_DECREF()onanunrelatedobjectwhileborrowinga\nreferencetoalistitem. Forinstance:\nvoid\nbug(PyObject *list)\n{\nPyObject *item = PyList_GetItem(list, 0);\nPyList_SetItem(list, 1, PyLong_FromLong(0L));\nPyObject_Print(item, stdout, 0); /* BUG! */\n}\nThisfunctionfirstborrowsareferencetolist[0],thenreplaceslist[1]withthevalue0,andfinallyprintsthe\nborrowedreference. Looksharmless,right? Butit\u2019snot!\nLet\u2019s follow the control flow into PyList_SetItem(). The list owns references to all its items, so when item 1\nis replaced, it has to dispose of the original item 1. Now let\u2019s suppose the original item 1 was an instance of a\nuser-definedclass,andlet\u2019sfurthersupposethattheclassdefineda__del__()method. Ifthisclassinstancehasa\nreferencecountof1,disposingofitwillcallits__del__()method.\nSince it is written in Python, the __del__() method can execute arbitrary Python code. Could it perhaps do\nsomething to invalidate the reference to item in bug()? You bet! Assuming that the list passed into bug() is\n18 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\naccessibletothe__del__()method,itcouldexecuteastatementtotheeffectofdel list[0],andassumingthis\nwasthelastreferencetothatobject,itwouldfreethememoryassociatedwithit,therebyinvalidatingitem.\nThe solution, once you know the source of the problem, is easy: temporarily increment the reference count. The\ncorrectversionofthefunctionreads:\nvoid\nno_bug(PyObject *list)\n{\nPyObject *item = PyList_GetItem(list, 0);\nPy_INCREF(item);\nPyList_SetItem(list, 1, PyLong_FromLong(0L));\nPyObject_Print(item, stdout, 0);\nPy_DECREF(item);\n}\nThis is a true story. An older version of Python contained variants of this bug and someone spent a considerable\namountoftimeinaCdebuggertofigureoutwhyhis__del__()methodswouldfail\u2026\nThesecondcaseofproblemswithaborrowedreferenceisavariantinvolvingthreads. Normally,multiplethreadsin\nthePythoninterpretercan\u2019tgetineachother\u2019sway,becausethereisagloballockprotectingPython\u2019sentireobject\nspace. However,itispossibletotemporarilyreleasethislockusingthemacroPy_BEGIN_ALLOW_THREADS,andto\nre-acquireitusingPy_END_ALLOW_THREADS.ThisiscommonaroundblockingI/Ocalls, toletotherthreadsuse\ntheprocessorwhilewaitingfortheI/Otocomplete. Obviously,thefollowingfunctionhasthesameproblemasthe\npreviousone:\nvoid\nbug(PyObject *list)\n{\nPyObject *item = PyList_GetItem(list, 0);\nPy_BEGIN_ALLOW_THREADS\n...some blocking I/O call...\nPy_END_ALLOW_THREADS\nPyObject_Print(item, stdout, 0); /* BUG! */\n}\nNULLPointers\nIngeneral,functionsthattakeobjectreferencesasargumentsdonotexpectyoutopassthemNULLpointers,andwill\ndumpcore(orcauselatercoredumps)ifyoudoso. FunctionsthatreturnobjectreferencesgenerallyreturnNULL\nonly to indicate that an exception occurred. The reason for not testing for NULL arguments is that functions often\npasstheobjectstheyreceiveontootherfunction\u2014ifeachfunctionweretotestforNULL,therewouldbealotof\nredundanttestsandthecodewouldrunmoreslowly.\nIt is better to test for NULL only at the \u201csource:\u201d when a pointer that may be NULL is received, for example, from\nmalloc()orfromafunctionthatmayraiseanexception.\nThe macros Py_INCREF() and Py_DECREF() do not check for NULL pointers \u2014 however, their variants\nPy_XINCREF()andPy_XDECREF()do.\nThemacrosforcheckingforaparticularobjecttype(Pytype_Check())don\u2019tcheckforNULLpointers\u2014again,\nthereismuchcodethatcallsseveraloftheseinarowtotestanobjectagainstvariousdifferentexpectedtypes,and\nthiswouldgenerateredundanttests. TherearenovariantswithNULLchecking.\nTheCfunctioncallingmechanismguaranteesthattheargumentlistpassedtoCfunctions(argsintheexamples)is\nneverNULL\u2014infactitguaranteesthatitisalwaysatuple4.\nItisasevereerrortoeverletaNULLpointer\u201cescape\u201dtothePythonuser.\n4Theseguaranteesdon\u2019tholdwhenyouusethe\u201cold\u201dstylecallingconvention\u2014thisisstillfoundinmuchexistingcode.\n2.1. ExtendingPythonwithCorC++ 19\nExtendingandEmbeddingPython,Release3.13.3\n2.1.11 Writing Extensions in C++\nItispossibletowriteextensionmodulesinC++. Somerestrictionsapply. Ifthemainprogram(thePythoninterpreter)\nis compiled and linked by the C compiler, global or static objects with constructors cannot be used. This is not a\nproblemifthemainprogramislinkedbytheC++compiler. FunctionsthatwillbecalledbythePythoninterpreter\n(inparticular,moduleinitializationfunctions)havetobedeclaredusingextern \"C\". Itisunnecessarytoenclose\nthePythonheaderfilesinextern \"C\" {...}\u2014theyusethisformalreadyifthesymbol__cplusplusisdefined\n(allrecentC++compilersdefinethissymbol).\n2.1.12 Providing a C API for an Extension Module\nManyextensionmodulesjustprovidenewfunctionsandtypestobeusedfromPython,butsometimesthecodein\nanextensionmodulecanbeusefulforotherextensionmodules. Forexample,anextensionmodulecouldimplement\natype\u201ccollection\u201dwhichworkslikelistswithoutorder. JustlikethestandardPythonlisttypehasaCAPIwhich\npermitsextensionmodulestocreateandmanipulatelists,thisnewcollectiontypeshouldhaveasetofCfunctions\nfordirectmanipulationfromotherextensionmodules.\nAt first sight this seems easy: just write the functions (without declaring them static, of course), provide an\nappropriateheaderfile,anddocumenttheCAPI.Andinfactthiswouldworkifallextensionmoduleswerealways\nlinkedstaticallywiththePythoninterpreter. Whenmodulesareusedassharedlibraries,however,thesymbolsdefined\ninonemodulemaynotbevisibletoanothermodule. Thedetailsofvisibilitydependontheoperatingsystem;some\nsystems use one global namespace for the Python interpreter and all extension modules (Windows, for example),\nwhereas others require an explicit list of imported symbols at module link time (AIX is one example), or offer a\nchoiceofdifferentstrategies(mostUnices). Andevenifsymbolsaregloballyvisible,themodulewhosefunctions\nonewishestocallmightnothavebeenloadedyet!\nPortabilitythereforerequiresnottomakeanyassumptionsaboutsymbolvisibility. Thismeansthatallsymbolsin\nextensionmodulesshouldbedeclaredstatic,exceptforthemodule\u2019sinitializationfunction,inordertoavoidname\nclasheswithotherextensionmodules(asdiscussedinsectionTheModule\u2019sMethodTableandInitializationFunction).\nAnditmeansthatsymbolsthatshould beaccessiblefromotherextensionmodulesmustbeexportedinadifferent\nway.\nPythonprovidesaspecialmechanismtopassC-levelinformation(pointers)fromoneextensionmoduletoanother\none: Capsules. ACapsuleisaPythondatatypewhichstoresapointer(void*). Capsulescanonlybecreatedand\naccessed via their C API, but they can be passed around like any other Python object. In particular, they can be\nassigned to a name in an extension module\u2019s namespace. Other extension modules can then import this module,\nretrievethevalueofthisname,andthenretrievethepointerfromtheCapsule.\nThere are many ways in which Capsules can be used to export the C API of an extension module. Each function\ncouldgetitsownCapsule,orallCAPIpointerscouldbestoredinanarraywhoseaddressispublishedinaCapsule.\nAndthevarioustasksofstoringandretrievingthepointerscanbedistributedindifferentwaysbetweenthemodule\nprovidingthecodeandtheclientmodules.\nWhichever method you choose, it\u2019s important to name your Capsules properly. The function PyCapsule_New()\ntakesanameparameter(const char*);you\u2019repermittedtopassinaNULLname,butwestronglyencourageyou\ntospecifyaname. ProperlynamedCapsulesprovideadegreeofruntimetype-safety;thereisnofeasiblewaytotell\noneunnamedCapsulefromanother.\nInparticular,CapsulesusedtoexposeCAPIsshouldbegivenanamefollowingthisconvention:\nmodulename.attributename\nTheconveniencefunctionPyCapsule_Import()makesiteasytoloadaCAPIprovidedviaaCapsule,butonly\niftheCapsule\u2019snamematchesthisconvention. ThisbehaviorgivesCAPIusersahighdegreeofcertaintythatthe\nCapsuletheyloadcontainsthecorrectCAPI.\nThefollowingexampledemonstratesanapproachthatputsmostoftheburdenonthewriteroftheexportingmodule,\nwhichisappropriateforcommonlyusedlibrarymodules. ItstoresallCAPIpointers(justoneintheexample!) inan\narrayofvoidpointerswhichbecomesthevalueofaCapsule. Theheaderfilecorrespondingtothemoduleprovides\namacrothattakescareofimportingthemoduleandretrievingitsCAPIpointers;clientmodulesonlyhavetocall\nthismacrobeforeaccessingtheCAPI.\n20 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\nTheexportingmoduleisamodificationofthespammodulefromsectionASimpleExample. Thefunctionspam.\nsystem()doesnotcalltheClibraryfunctionsystem()directly,butafunctionPySpam_System(),whichwould\nof course do something more complicated in reality (such as adding \u201cspam\u201d to every command). This function\nPySpam_System()isalsoexportedtootherextensionmodules.\nThefunctionPySpam_System()isaplainCfunction,declaredstaticlikeeverythingelse:\nstatic int\nPySpam_System(const char *command)\n{\nreturn system(command);\n}\nThefunctionspam_system()ismodifiedinatrivialway:\nstatic PyObject *\nspam_system(PyObject *self, PyObject *args)\n{\nconst char *command;\nint sts;\nif (!PyArg_ParseTuple(args, \"s\", &command))\nreturn NULL;\nsts = PySpam_System(command);\nreturn PyLong_FromLong(sts);\n}\nInthebeginningofthemodule,rightaftertheline\n#include <Python.h>\ntwomorelinesmustbeadded:\n#define SPAM_MODULE\n#include \"spammodule.h\"\nThe #define is used to tell the header file that it is being included in the exporting module, not a client module.\nFinally,themodule\u2019sinitializationfunctionmusttakecareofinitializingtheCAPIpointerarray:\nPyMODINIT_FUNC\nPyInit_spam(void)\n{\nPyObject *m;\nstatic void *PySpam_API[PySpam_API_pointers];\nPyObject *c_api_object;\nm = PyModule_Create(&spammodule);\nif (m == NULL)\nreturn NULL;\n/* Initialize the C API pointer array */\nPySpam_API[PySpam_System_NUM] = (void *)PySpam_System;\n/* Create a Capsule containing the API pointer array's address */\nc_api_object = PyCapsule_New((void *)PySpam_API, \"spam._C_API\", NULL);\nif (PyModule_Add(m, \"_C_API\", c_api_object) < 0) {\nPy_DECREF(m);\nreturn NULL;\n(continuesonnextpage)\n2.1. ExtendingPythonwithCorC++ 21\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\n}\nreturn m;\n}\nNotethatPySpam_APIisdeclaredstatic; otherwisethepointerarraywoulddisappearwhenPyInit_spam()\nterminates!\nThebulkoftheworkisintheheaderfilespammodule.h,whichlookslikethis:\n#ifndef Py_SPAMMODULE_H\n#define Py_SPAMMODULE_H\n#ifdef __cplusplus\nextern \"C\" {\n#endif\n/* Header file for spammodule */\n/* C API functions */\n#define PySpam_System_NUM 0\n#define PySpam_System_RETURN int\n#define PySpam_System_PROTO (const char *command)\n/* Total number of C API pointers */\n#define PySpam_API_pointers 1\n#ifdef SPAM_MODULE\n/* This section is used when compiling spammodule.c */\nstatic PySpam_System_RETURN PySpam_System PySpam_System_PROTO;\n#else\n/* This section is used in modules that use spammodule's API */\nstatic void **PySpam_API;\n#define PySpam_System \\\n(*(PySpam_System_RETURN (*)PySpam_System_PROTO) PySpam_API[PySpam_System_NUM])\n/* Return -1 on error, 0 on success.\n* PyCapsule_Import will set an exception if there's an error.\n*/\nstatic int\nimport_spam(void)\n{\nPySpam_API = (void **)PyCapsule_Import(\"spam._C_API\", 0);\nreturn (PySpam_API != NULL) ? 0 : -1;\n}\n#endif\n#ifdef __cplusplus\n}\n#endif\n#endif /* !defined(Py_SPAMMODULE_H) */\n22 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\nAllthataclientmodulemustdoinordertohaveaccesstothefunctionPySpam_System()istocallthefunction\n(orrathermacro)import_spam()initsinitializationfunction:\nPyMODINIT_FUNC\nPyInit_client(void)\n{\nPyObject *m;\nm = PyModule_Create(&clientmodule);\nif (m == NULL)\nreturn NULL;\nif (import_spam() < 0)\nreturn NULL;\n/* additional initialization can happen here */\nreturn m;\n}\nThemaindisadvantageofthisapproachisthatthefilespammodule.hisrathercomplicated. However, thebasic\nstructureisthesameforeachfunctionthatisexported,soithastobelearnedonlyonce.\nFinally it should be mentioned that Capsules offer additional functionality, which is especially useful for memory\nallocationanddeallocationofthepointerstoredinaCapsule. ThedetailsaredescribedinthePython/CAPIReference\nManualinthesectioncapsulesandintheimplementationofCapsules(filesInclude/pycapsule.handObjects/\npycapsule.cinthePythonsourcecodedistribution).\n2.2 Defining Extension Types: Tutorial\nPythonallowsthewriterofaCextensionmoduletodefinenewtypesthatcanbemanipulatedfromPythoncode,\nmuchlikethebuilt-instrandlisttypes. Thecodeforallextensiontypesfollowsapattern, buttherearesome\ndetailsthatyouneedtounderstandbeforeyoucangetstarted. Thisdocumentisagentleintroductiontothetopic.\n2.2.1 The Basics\nTheCPythonruntimeseesallPythonobjectsasvariablesoftypePyObject*,whichservesasa\u201cbasetype\u201dforall\nPythonobjects. ThePyObjectstructureitselfonlycontainstheobject\u2019sreferencecountandapointertotheobject\u2019s\n\u201ctypeobject\u201d. Thisiswheretheactionis;thetypeobjectdetermineswhich(C)functionsgetcalledbytheinterpreter\nwhen, forinstance, anattributegetslookeduponanobject, amethodcalled, oritismultipliedbyanotherobject.\nTheseCfunctionsarecalled\u201ctypemethods\u201d.\nSo,ifyouwanttodefineanewextensiontype,youneedtocreateanewtypeobject.\nThissortofthingcanonlybeexplainedbyexample,sohere\u2019saminimal,butcomplete,modulethatdefinesanew\ntypenamedCustominsideaCextensionmodulecustom:\n(cid:174) Note\nWhatwe\u2019reshowinghereisthetraditionalwayofdefiningstaticextensiontypes. Itshouldbeadequateformost\nuses. TheCAPIalsoallowsdefiningheap-allocatedextensiontypesusingthePyType_FromSpec()function,\nwhichisn\u2019tcoveredinthistutorial.\n#define PY_SSIZE_T_CLEAN\n#include <Python.h>\ntypedef struct {\nPyObject_HEAD\n/* Type-specific fields go here. */\n} CustomObject;\n(continuesonnextpage)\n2.2. DefiningExtensionTypes: Tutorial 23\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nstatic PyTypeObject CustomType = {\n.ob_base = PyVarObject_HEAD_INIT(NULL, 0)\n.tp_name = \"custom.Custom\",\n.tp_doc = PyDoc_STR(\"Custom objects\"),\n.tp_basicsize = sizeof(CustomObject),\n.tp_itemsize = 0,\n.tp_flags = Py_TPFLAGS_DEFAULT,\n.tp_new = PyType_GenericNew,\n};\nstatic PyModuleDef custommodule = {\n.m_base = PyModuleDef_HEAD_INIT,\n.m_name = \"custom\",\n.m_doc = \"Example module that creates an extension type.\",\n.m_size = -1,\n};\nPyMODINIT_FUNC\nPyInit_custom(void)\n{\nPyObject *m;\nif (PyType_Ready(&CustomType) < 0)\nreturn NULL;\nm = PyModule_Create(&custommodule);\nif (m == NULL)\nreturn NULL;\nif (PyModule_AddObjectRef(m, \"Custom\", (PyObject *) &CustomType) < 0) {\nPy_DECREF(m);\nreturn NULL;\n}\nreturn m;\n}\nNowthat\u2019squiteabittotakeinatonce, buthopefullybitswillseemfamiliarfromthepreviouschapter. Thisfile\ndefinesthreethings:\n1. WhataCustomobjectcontains: thisistheCustomObjectstruct,whichisallocatedonceforeachCustom\ninstance.\n2. How the Custom type behaves: this is the CustomType struct, which defines a set of flags and function\npointersthattheinterpreterinspectswhenspecificoperationsarerequested.\n3. Howtoinitializethecustommodule:thisisthePyInit_customfunctionandtheassociatedcustommodule\nstruct.\nThefirstbitis:\ntypedef struct {\nPyObject_HEAD\n} CustomObject;\nThis is what a Custom object will contain. PyObject_HEAD is mandatory at the start of each object struct and\ndefinesafieldcalledob_baseoftypePyObject,containingapointertoatypeobjectandareferencecount(these\ncanbeaccessedusingthemacrosPy_TYPEandPy_REFCNTrespectively). Thereasonforthemacroistoabstract\nawaythelayoutandtoenableadditionalfieldsindebugbuilds.\n24 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\n(cid:174) Note\nThere is no semicolon above after the PyObject_HEAD macro. Be wary of adding one by accident: some\ncompilerswillcomplain.\nOf course, objects generally store additional data besides the standard PyObject_HEAD boilerplate; for example,\nhereisthedefinitionforstandardPythonfloats:\ntypedef struct {\nPyObject_HEAD\ndouble ob_fval;\n} PyFloatObject;\nThesecondbitisthedefinitionofthetypeobject.\nstatic PyTypeObject CustomType = {\n.ob_base = PyVarObject_HEAD_INIT(NULL, 0)\n.tp_name = \"custom.Custom\",\n.tp_doc = PyDoc_STR(\"Custom objects\"),\n.tp_basicsize = sizeof(CustomObject),\n.tp_itemsize = 0,\n.tp_flags = Py_TPFLAGS_DEFAULT,\n.tp_new = PyType_GenericNew,\n};\n(cid:174) Note\nWe recommend using C99-style designated initializers as above, to avoid listing all the PyTypeObject fields\nthatyoudon\u2019tcareaboutandalsotoavoidcaringaboutthefields\u2019declarationorder.\nTheactualdefinitionofPyTypeObjectinobject.hhasmanymorefieldsthanthedefinitionabove. Theremaining\nfieldswillbefilledwithzerosbytheCcompiler,andit\u2019scommonpracticetonotspecifythemexplicitlyunlessyou\nneedthem.\nWe\u2019regoingtopickitapart,onefieldatatime:\n.ob_base = PyVarObject_HEAD_INIT(NULL, 0)\nThislineismandatoryboilerplatetoinitializetheob_basefieldmentionedabove.\n.tp_name = \"custom.Custom\",\nThenameofourtype. Thiswillappearinthedefaulttextualrepresentationofourobjectsandinsomeerrormessages,\nforexample:\n>>> \"\" + custom.Custom()\nTraceback (most recent call last):\nFile \"<stdin>\", line 1, in <module>\nTypeError: can only concatenate str (not \"custom.Custom\") to str\nNotethatthenameisadottednamethatincludesboththemodulenameandthenameofthetypewithinthemodule.\nThemoduleinthiscaseiscustomandthetypeisCustom,sowesetthetypenametocustom.Custom. Usingthe\nrealdottedimportpathisimportanttomakeyourtypecompatiblewiththepydocandpicklemodules.\n.tp_basicsize = sizeof(CustomObject),\n.tp_itemsize = 0,\n2.2. DefiningExtensionTypes: Tutorial 25\nExtendingandEmbeddingPython,Release3.13.3\nThisissothatPythonknowshowmuchmemorytoallocatewhencreatingnewCustominstances. tp_itemsize\nisonlyusedforvariable-sizedobjectsandshouldotherwisebezero.\n(cid:174) Note\nIfyouwantyourtypetobesubclassablefromPython,andyourtypehasthesametp_basicsizeasitsbase\ntype, you may have problems with multiple inheritance. A Python subclass of your type will have to list your\ntypefirstinits__bases__,orelseitwillnotbeabletocallyourtype\u2019s__new__()methodwithoutgettingan\nerror. Youcanavoidthisproblembyensuringthatyourtypehasalargervaluefortp_basicsizethanitsbase\ntypedoes. Mostofthetime,thiswillbetrueanyway,becauseeitheryourbasetypewillbeobject,orelseyou\nwillbeaddingdatamemberstoyourbasetype,andthereforeincreasingitssize.\nWesettheclassflagstoPy_TPFLAGS_DEFAULT.\n.tp_flags = Py_TPFLAGS_DEFAULT,\nAlltypesshouldincludethisconstantintheirflags. ItenablesallofthemembersdefineduntilatleastPython3.3. If\nyouneedfurthermembers,youwillneedtoORthecorrespondingflags.\nWeprovideadocstringforthetypeintp_doc.\n.tp_doc = PyDoc_STR(\"Custom objects\"),\nTo enable object creation, we have to provide a tp_new handler. This is the equivalent of the Python method\n__new__(),buthastobespecifiedexplicitly. Inthiscase,wecanjustusethedefaultimplementationprovidedby\ntheAPIfunctionPyType_GenericNew().\n.tp_new = PyType_GenericNew,\nEverythingelseinthefileshouldbefamiliar,exceptforsomecodeinPyInit_custom():\nif (PyType_Ready(&CustomType) < 0)\nreturn;\nThisinitializestheCustomtype,fillinginanumberofmemberstotheappropriatedefaultvalues,includingob_type\nthatweinitiallysettoNULL.\nif (PyModule_AddObjectRef(m, \"Custom\", (PyObject *) &CustomType) < 0) {\nPy_DECREF(m);\nreturn NULL;\n}\nThisaddsthetypetothemoduledictionary. ThisallowsustocreateCustominstancesbycallingtheCustomclass:\n>>> import custom\n>>> mycustom = custom.Custom()\nThat\u2019sit! Allthatremainsistobuildit;puttheabovecodeinafilecalledcustom.c,\n[build-system]\nrequires = [\"setuptools\"]\nbuild-backend = \"setuptools.build_meta\"\n[project]\nname = \"custom\"\nversion = \"1\"\ninafilecalledpyproject.toml,and\n26 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\nfrom setuptools import Extension, setup\nsetup(ext_modules=[Extension(\"custom\", [\"custom.c\"])])\ninafilecalledsetup.py;thentyping\n$ python -m pip install .\ninashellshouldproduceafilecustom.soinasubdirectoryandinstallit;nowfireupPython\u2014youshouldbeable\ntoimport customandplayaroundwithCustomobjects.\nThatwasn\u2019tsohard,wasit?\nOfcourse,thecurrentCustomtypeisprettyuninteresting. Ithasnodataanddoesn\u2019tdoanything. Itcan\u2019tevenbe\nsubclassed.\n2.2.2 Adding data and methods to the Basic example\nLet\u2019sextendthebasicexampletoaddsomedataandmethods. Let\u2019salsomakethetypeusableasabaseclass. We\u2019ll\ncreateanewmodule,custom2thataddsthesecapabilities:\n#define PY_SSIZE_T_CLEAN\n#include <Python.h>\n#include <stddef.h> /* for offsetof() */\ntypedef struct {\nPyObject_HEAD\nPyObject *first; /* first name */\nPyObject *last; /* last name */\nint number;\n} CustomObject;\nstatic void\nCustom_dealloc(CustomObject *self)\n{\nPy_XDECREF(self->first);\nPy_XDECREF(self->last);\nPy_TYPE(self)->tp_free((PyObject *) self);\n}\nstatic PyObject *\nCustom_new(PyTypeObject *type, PyObject *args, PyObject *kwds)\n{\nCustomObject *self;\nself = (CustomObject *) type->tp_alloc(type, 0);\nif (self != NULL) {\nself->first = PyUnicode_FromString(\"\");\nif (self->first == NULL) {\nPy_DECREF(self);\nreturn NULL;\n}\nself->last = PyUnicode_FromString(\"\");\nif (self->last == NULL) {\nPy_DECREF(self);\nreturn NULL;\n}\nself->number = 0;\n}\nreturn (PyObject *) self;\n(continuesonnextpage)\n2.2. DefiningExtensionTypes: Tutorial 27\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\n}\nstatic int\nCustom_init(CustomObject *self, PyObject *args, PyObject *kwds)\n{\nstatic char *kwlist[] = {\"first\", \"last\", \"number\", NULL};\nPyObject *first = NULL, *last = NULL;\nif (!PyArg_ParseTupleAndKeywords(args, kwds, \"|OOi\", kwlist,\n&first, &last,\n&self->number))\nreturn -1;\nif (first) {\nPy_XSETREF(self->first, Py_NewRef(first));\n}\nif (last) {\nPy_XSETREF(self->last, Py_NewRef(last));\n}\nreturn 0;\n}\nstatic PyMemberDef Custom_members[] = {\n{\"first\", Py_T_OBJECT_EX, offsetof(CustomObject, first), 0,\n\"first name\"},\n{\"last\", Py_T_OBJECT_EX, offsetof(CustomObject, last), 0,\n\"last name\"},\n{\"number\", Py_T_INT, offsetof(CustomObject, number), 0,\n\"custom number\"},\n{NULL} /* Sentinel */\n};\nstatic PyObject *\nCustom_name(CustomObject *self, PyObject *Py_UNUSED(ignored))\n{\nif (self->first == NULL) {\nPyErr_SetString(PyExc_AttributeError, \"first\");\nreturn NULL;\n}\nif (self->last == NULL) {\nPyErr_SetString(PyExc_AttributeError, \"last\");\nreturn NULL;\n}\nreturn PyUnicode_FromFormat(\"%S %S\", self->first, self->last);\n}\nstatic PyMethodDef Custom_methods[] = {\n{\"name\", (PyCFunction) Custom_name, METH_NOARGS,\n\"Return the name, combining the first and last name\"\n},\n{NULL} /* Sentinel */\n};\nstatic PyTypeObject CustomType = {\n.ob_base = PyVarObject_HEAD_INIT(NULL, 0)\n.tp_name = \"custom2.Custom\",\n(continuesonnextpage)\n28 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\n.tp_doc = PyDoc_STR(\"Custom objects\"),\n.tp_basicsize = sizeof(CustomObject),\n.tp_itemsize = 0,\n.tp_flags = Py_TPFLAGS_DEFAULT | Py_TPFLAGS_BASETYPE,\n.tp_new = Custom_new,\n.tp_init = (initproc) Custom_init,\n.tp_dealloc = (destructor) Custom_dealloc,\n.tp_members = Custom_members,\n.tp_methods = Custom_methods,\n};\nstatic PyModuleDef custommodule = {\n.m_base =PyModuleDef_HEAD_INIT,\n.m_name = \"custom2\",\n.m_doc = \"Example module that creates an extension type.\",\n.m_size = -1,\n};\nPyMODINIT_FUNC\nPyInit_custom2(void)\n{\nPyObject *m;\nif (PyType_Ready(&CustomType) < 0)\nreturn NULL;\nm = PyModule_Create(&custommodule);\nif (m == NULL)\nreturn NULL;\nif (PyModule_AddObjectRef(m, \"Custom\", (PyObject *) &CustomType) < 0) {\nPy_DECREF(m);\nreturn NULL;\n}\nreturn m;\n}\nThisversionofthemodulehasanumberofchanges.\nTheCustomtypenowhasthreedataattributesinitsCstruct,first,last,andnumber. Thefirstandlastvariablesare\nPythonstringscontainingfirstandlastnames. ThenumberattributeisaCinteger.\nTheobjectstructureisupdatedaccordingly:\ntypedef struct {\nPyObject_HEAD\nPyObject *first; /* first name */\nPyObject *last; /* last name */\nint number;\n} CustomObject;\nBecause we now have data to manage, we have to be more careful about object allocation and deallocation. At a\nminimum,weneedadeallocationmethod:\nstatic void\nCustom_dealloc(CustomObject *self)\n{\nPy_XDECREF(self->first);\n(continuesonnextpage)\n2.2. DefiningExtensionTypes: Tutorial 29\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nPy_XDECREF(self->last);\nPy_TYPE(self)->tp_free((PyObject *) self);\n}\nwhichisassignedtothetp_deallocmember:\n.tp_dealloc = (destructor) Custom_dealloc,\nThismethodfirstclearsthereferencecountsofthetwoPythonattributes. Py_XDECREF()correctlyhandlesthecase\nwhereitsargumentisNULL(whichmighthappenhereiftp_newfailedmidway). Itthencallsthetp_freemember\noftheobject\u2019stype(computedbyPy_TYPE(self))tofreetheobject\u2019smemory. Notethattheobject\u2019stypemight\nnotbeCustomType,becausetheobjectmaybeaninstanceofasubclass.\n(cid:174) Note\nThe explicit cast to destructor above is needed because we defined Custom_dealloc to take a\nCustomObject * argument, but the tp_dealloc function pointer expects to receive a PyObject * argu-\nment. Otherwise,thecompilerwillemitawarning. Thisisobject-orientedpolymorphism,inC!\nWewanttomakesurethatthefirstandlastnamesareinitializedtoemptystrings,soweprovideatp_newimple-\nmentation:\nstatic PyObject *\nCustom_new(PyTypeObject *type, PyObject *args, PyObject *kwds)\n{\nCustomObject *self;\nself = (CustomObject *) type->tp_alloc(type, 0);\nif (self != NULL) {\nself->first = PyUnicode_FromString(\"\");\nif (self->first == NULL) {\nPy_DECREF(self);\nreturn NULL;\n}\nself->last = PyUnicode_FromString(\"\");\nif (self->last == NULL) {\nPy_DECREF(self);\nreturn NULL;\n}\nself->number = 0;\n}\nreturn (PyObject *) self;\n}\nandinstallitinthetp_newmember:\n.tp_new = Custom_new,\nThetp_newhandlerisresponsibleforcreating(asopposedtoinitializing)objectsofthetype. ItisexposedinPython\nas the __new__() method. It is not required to define a tp_new member, and indeed many extension types will\nsimplyreusePyType_GenericNew()asdoneinthefirstversionoftheCustomtypeabove. Inthiscase,weuse\nthetp_newhandlertoinitializethefirstandlastattributestonon-NULLdefaultvalues.\ntp_new is passed the type being instantiated (not necessarily CustomType, if a subclass is instantiated) and any\nargumentspassedwhenthetypewascalled,andisexpectedtoreturntheinstancecreated. tp_newhandlersalways\naccept positional and keyword arguments, but they often ignore the arguments, leaving the argument handling to\ninitializer(a.k.a. tp_initinCor__init__inPython)methods.\n30 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\n(cid:174) Note\ntp_newshouldn\u2019tcalltp_initexplicitly,astheinterpreterwilldoititself.\nThetp_newimplementationcallsthetp_allocslottoallocatememory:\nself = (CustomObject *) type->tp_alloc(type, 0);\nSincememoryallocationmayfail,wemustcheckthetp_allocresultagainstNULLbeforeproceeding.\n(cid:174) Note\nWedidn\u2019tfillthetp_allocslotourselves. RatherPyType_Ready()fillsitforusbyinheritingitfromourbase\nclass,whichisobjectbydefault. Mosttypesusethedefaultallocationstrategy.\n(cid:174) Note\nIfyouarecreatingaco-operativetp_new(onethatcallsabasetype\u2019stp_newor__new__()), youmustnot\ntrytodeterminewhatmethodtocallusingmethodresolutionorderatruntime. Alwaysstaticallydeterminewhat\ntype you are going to call, and call its tp_new directly, or via type->tp_base->tp_new. If you do not do\nthis,PythonsubclassesofyourtypethatalsoinheritfromotherPython-definedclassesmaynotworkcorrectly.\n(Specifically,youmaynotbeabletocreateinstancesofsuchsubclasseswithoutgettingaTypeError.)\nWealsodefineaninitializationfunctionwhichacceptsargumentstoprovideinitialvaluesforourinstance:\nstatic int\nCustom_init(CustomObject *self, PyObject *args, PyObject *kwds)\n{\nstatic char *kwlist[] = {\"first\", \"last\", \"number\", NULL};\nPyObject *first = NULL, *last = NULL, *tmp;\nif (!PyArg_ParseTupleAndKeywords(args, kwds, \"|OOi\", kwlist,\n&first, &last,\n&self->number))\nreturn -1;\nif (first) {\ntmp = self->first;\nPy_INCREF(first);\nself->first = first;\nPy_XDECREF(tmp);\n}\nif (last) {\ntmp = self->last;\nPy_INCREF(last);\nself->last = last;\nPy_XDECREF(tmp);\n}\nreturn 0;\n}\nbyfillingthetp_initslot.\n.tp_init = (initproc) Custom_init,\n2.2. DefiningExtensionTypes: Tutorial 31\nExtendingandEmbeddingPython,Release3.13.3\nThetp_initslotisexposedinPythonasthe__init__()method. Itisusedtoinitializeanobjectafterit\u2019screated.\nInitializersalwaysacceptpositionalandkeywordarguments,andtheyshouldreturneither0onsuccessor-1onerror.\nUnlikethetp_newhandler,thereisnoguaranteethattp_initiscalledatall(forexample,thepicklemoduleby\ndefaultdoesn\u2019tcall__init__()onunpickledinstances). Itcanalsobecalledmultipletimes. Anyonecancallthe\n__init__()methodonourobjects. Forthisreason,wehavetobeextracarefulwhenassigningthenewattribute\nvalues. Wemightbetempted,forexampletoassignthefirstmemberlikethis:\nif (first) {\nPy_XDECREF(self->first);\nPy_INCREF(first);\nself->first = first;\n}\nButthiswouldberisky. Ourtypedoesn\u2019trestrictthetypeofthefirstmember,soitcouldbeanykindofobject.\nItcouldhaveadestructorthatcausescodetobeexecutedthattriestoaccessthefirstmember;orthatdestructor\ncouldreleasetheGlobalinterpreterLock andletarbitrarycoderuninotherthreadsthataccessesandmodifiesour\nobject.\nTobeparanoidandprotectourselvesagainstthispossibility,wealmostalwaysreassignmembersbeforedecrementing\ntheirreferencecounts. Whendon\u2019twehavetodothis?\n\u2022 whenweabsolutelyknowthatthereferencecountisgreaterthan1;\n\u2022 whenweknowthatdeallocationoftheobject1 willneitherreleasetheGILnorcauseanycallsbackintoour\ntype\u2019scode;\n\u2022 whendecrementingareferencecountinatp_deallochandleronatypewhichdoesn\u2019tsupportcyclicgarbage\ncollection2.\nWewanttoexposeourinstancevariablesasattributes. Thereareanumberofwaystodothat. Thesimplestwayis\ntodefinememberdefinitions:\nstatic PyMemberDef Custom_members[] = {\n{\"first\", Py_T_OBJECT_EX, offsetof(CustomObject, first), 0,\n\"first name\"},\n{\"last\", Py_T_OBJECT_EX, offsetof(CustomObject, last), 0,\n\"last name\"},\n{\"number\", Py_T_INT, offsetof(CustomObject, number), 0,\n\"custom number\"},\n{NULL} /* Sentinel */\n};\nandputthedefinitionsinthetp_membersslot:\n.tp_members = Custom_members,\nEach member definition has a member name, type, offset, access flags and documentation string. See the Generic\nAttributeManagementsectionbelowfordetails.\nAdisadvantageofthisapproachisthatitdoesn\u2019tprovideawaytorestrictthetypesofobjectsthatcanbeassigned\ntothePythonattributes. Weexpectthefirstandlastnamestobestrings, butanyPythonobjectscanbeassigned.\nFurther,theattributescanbedeleted,settingtheCpointerstoNULL.Eventhoughwecanmakesurethemembers\nareinitializedtonon-NULLvalues,thememberscanbesettoNULLiftheattributesaredeleted.\nWedefineasinglemethod,Custom.name(),thatoutputstheobjectsnameastheconcatenationofthefirstandlast\nnames.\nstatic PyObject *\nCustom_name(CustomObject *self, PyObject *Py_UNUSED(ignored))\n(continuesonnextpage)\n1Thisistruewhenweknowthattheobjectisabasictype,likeastringorafloat.\n2Wereliedonthisinthetp_deallochandlerinthisexample,becauseourtypedoesn\u2019tsupportgarbagecollection.\n32 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\n{\nif (self->first == NULL) {\nPyErr_SetString(PyExc_AttributeError, \"first\");\nreturn NULL;\n}\nif (self->last == NULL) {\nPyErr_SetString(PyExc_AttributeError, \"last\");\nreturn NULL;\n}\nreturn PyUnicode_FromFormat(\"%S %S\", self->first, self->last);\n}\nThemethodisimplementedasaCfunctionthattakesaCustom(orCustomsubclass)instanceasthefirstargument.\nMethods always take an instance as the first argument. Methods often take positional and keyword arguments as\nwell, butinthiscasewedon\u2019ttakeanyanddon\u2019tneedtoacceptapositionalargumenttupleorkeywordargument\ndictionary. ThismethodisequivalenttothePythonmethod:\ndef name(self):\nreturn \"%s %s\" % (self.first, self.last)\nNotethatwehavetocheckforthepossibilitythatourfirstandlastmembersareNULL.Thisisbecausetheycan\nbedeleted,inwhichcasetheyaresettoNULL.Itwouldbebettertopreventdeletionoftheseattributesandtorestrict\ntheattributevaluestobestrings. We\u2019llseehowtodothatinthenextsection.\nNowthatwe\u2019vedefinedthemethod,weneedtocreateanarrayofmethoddefinitions:\nstatic PyMethodDef Custom_methods[] = {\n{\"name\", (PyCFunction) Custom_name, METH_NOARGS,\n\"Return the name, combining the first and last name\"\n},\n{NULL} /* Sentinel */\n};\n(notethatweusedtheMETH_NOARGSflagtoindicatethatthemethodisexpectingnoargumentsotherthanself)\nandassignittothetp_methodsslot:\n.tp_methods = Custom_methods,\nFinally,we\u2019llmakeourtypeusableasabaseclassforsubclassing. We\u2019vewrittenourmethodscarefullysofarsothat\ntheydon\u2019tmakeanyassumptionsaboutthetypeoftheobjectbeingcreatedorused,soallweneedtodoistoadd\nthePy_TPFLAGS_BASETYPEtoourclassflagdefinition:\n.tp_flags = Py_TPFLAGS_DEFAULT | Py_TPFLAGS_BASETYPE,\nWerenamePyInit_custom()toPyInit_custom2(),updatethemodulenameinthePyModuleDefstruct,and\nupdatethefullclassnameinthePyTypeObjectstruct.\nFinally,weupdateoursetup.pyfiletoincludethenewmodule,\nfrom setuptools import Extension, setup\nsetup(ext_modules=[\nExtension(\"custom\", [\"custom.c\"]),\nExtension(\"custom2\", [\"custom2.c\"]),\n])\nandthenwere-installsothatwecanimport custom2:\n2.2. DefiningExtensionTypes: Tutorial 33\nExtendingandEmbeddingPython,Release3.13.3\n$ python -m pip install .\n2.2.3 Providing finer control over data attributes\nInthissection,we\u2019llprovidefinercontroloverhowthefirstandlastattributesaresetintheCustomexample.\nInthepreviousversionofourmodule,theinstancevariablesfirstandlastcouldbesettonon-stringvaluesor\nevendeleted. Wewanttomakesurethattheseattributesalwayscontainstrings.\n#define PY_SSIZE_T_CLEAN\n#include <Python.h>\n#include <stddef.h> /* for offsetof() */\ntypedef struct {\nPyObject_HEAD\nPyObject *first; /* first name */\nPyObject *last; /* last name */\nint number;\n} CustomObject;\nstatic void\nCustom_dealloc(CustomObject *self)\n{\nPy_XDECREF(self->first);\nPy_XDECREF(self->last);\nPy_TYPE(self)->tp_free((PyObject *) self);\n}\nstatic PyObject *\nCustom_new(PyTypeObject *type, PyObject *args, PyObject *kwds)\n{\nCustomObject *self;\nself = (CustomObject *) type->tp_alloc(type, 0);\nif (self != NULL) {\nself->first = PyUnicode_FromString(\"\");\nif (self->first == NULL) {\nPy_DECREF(self);\nreturn NULL;\n}\nself->last = PyUnicode_FromString(\"\");\nif (self->last == NULL) {\nPy_DECREF(self);\nreturn NULL;\n}\nself->number = 0;\n}\nreturn (PyObject *) self;\n}\nstatic int\nCustom_init(CustomObject *self, PyObject *args, PyObject *kwds)\n{\nstatic char *kwlist[] = {\"first\", \"last\", \"number\", NULL};\nPyObject *first = NULL, *last = NULL;\nif (!PyArg_ParseTupleAndKeywords(args, kwds, \"|UUi\", kwlist,\n&first, &last,\n&self->number))\n(continuesonnextpage)\n34 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nreturn -1;\nif (first) {\nPy_SETREF(self->first, Py_NewRef(first));\n}\nif (last) {\nPy_SETREF(self->last, Py_NewRef(last));\n}\nreturn 0;\n}\nstatic PyMemberDef Custom_members[] = {\n{\"number\", Py_T_INT, offsetof(CustomObject, number), 0,\n\"custom number\"},\n{NULL} /* Sentinel */\n};\nstatic PyObject *\nCustom_getfirst(CustomObject *self, void *closure)\n{\nreturn Py_NewRef(self->first);\n}\nstatic int\nCustom_setfirst(CustomObject *self, PyObject *value, void *closure)\n{\nif (value == NULL) {\nPyErr_SetString(PyExc_TypeError, \"Cannot delete the first attribute\");\nreturn -1;\n}\nif (!PyUnicode_Check(value)) {\nPyErr_SetString(PyExc_TypeError,\n\"The first attribute value must be a string\");\nreturn -1;\n}\nPy_SETREF(self->first, Py_NewRef(value));\nreturn 0;\n}\nstatic PyObject *\nCustom_getlast(CustomObject *self, void *closure)\n{\nreturn Py_NewRef(self->last);\n}\nstatic int\nCustom_setlast(CustomObject *self, PyObject *value, void *closure)\n{\nif (value == NULL) {\nPyErr_SetString(PyExc_TypeError, \"Cannot delete the last attribute\");\nreturn -1;\n}\nif (!PyUnicode_Check(value)) {\nPyErr_SetString(PyExc_TypeError,\n\"The last attribute value must be a string\");\nreturn -1;\n(continuesonnextpage)\n2.2. DefiningExtensionTypes: Tutorial 35\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\n}\nPy_SETREF(self->last, Py_NewRef(value));\nreturn 0;\n}\nstatic PyGetSetDef Custom_getsetters[] = {\n{\"first\", (getter) Custom_getfirst, (setter) Custom_setfirst,\n\"first name\", NULL},\n{\"last\", (getter) Custom_getlast, (setter) Custom_setlast,\n\"last name\", NULL},\n{NULL} /* Sentinel */\n};\nstatic PyObject *\nCustom_name(CustomObject *self, PyObject *Py_UNUSED(ignored))\n{\nreturn PyUnicode_FromFormat(\"%S %S\", self->first, self->last);\n}\nstatic PyMethodDef Custom_methods[] = {\n{\"name\", (PyCFunction) Custom_name, METH_NOARGS,\n\"Return the name, combining the first and last name\"\n},\n{NULL} /* Sentinel */\n};\nstatic PyTypeObject CustomType = {\n.ob_base = PyVarObject_HEAD_INIT(NULL, 0)\n.tp_name = \"custom3.Custom\",\n.tp_doc = PyDoc_STR(\"Custom objects\"),\n.tp_basicsize = sizeof(CustomObject),\n.tp_itemsize = 0,\n.tp_flags = Py_TPFLAGS_DEFAULT | Py_TPFLAGS_BASETYPE,\n.tp_new = Custom_new,\n.tp_init = (initproc) Custom_init,\n.tp_dealloc = (destructor) Custom_dealloc,\n.tp_members = Custom_members,\n.tp_methods = Custom_methods,\n.tp_getset = Custom_getsetters,\n};\nstatic PyModuleDef custommodule = {\n.m_base = PyModuleDef_HEAD_INIT,\n.m_name = \"custom3\",\n.m_doc = \"Example module that creates an extension type.\",\n.m_size = -1,\n};\nPyMODINIT_FUNC\nPyInit_custom3(void)\n{\nPyObject *m;\nif (PyType_Ready(&CustomType) < 0)\nreturn NULL;\nm = PyModule_Create(&custommodule);\n(continuesonnextpage)\n36 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nif (m == NULL)\nreturn NULL;\nif (PyModule_AddObjectRef(m, \"Custom\", (PyObject *) &CustomType) < 0) {\nPy_DECREF(m);\nreturn NULL;\n}\nreturn m;\n}\nToprovidegreatercontrol,overthefirstandlastattributes,we\u2019llusecustomgetterandsetterfunctions. Here\narethefunctionsforgettingandsettingthefirstattribute:\nstatic PyObject *\nCustom_getfirst(CustomObject *self, void *closure)\n{\nPy_INCREF(self->first);\nreturn self->first;\n}\nstatic int\nCustom_setfirst(CustomObject *self, PyObject *value, void *closure)\n{\nPyObject *tmp;\nif (value == NULL) {\nPyErr_SetString(PyExc_TypeError, \"Cannot delete the first attribute\");\nreturn -1;\n}\nif (!PyUnicode_Check(value)) {\nPyErr_SetString(PyExc_TypeError,\n\"The first attribute value must be a string\");\nreturn -1;\n}\ntmp = self->first;\nPy_INCREF(value);\nself->first = value;\nPy_DECREF(tmp);\nreturn 0;\n}\nThegetterfunctionispassedaCustomobjectanda\u201cclosure\u201d, whichisavoidpointer. Inthiscase, theclosureis\nignored. (The closure supports an advanced usage in which definition data is passed to the getter and setter. This\ncould,forexample,beusedtoallowasinglesetofgetterandsetterfunctionsthatdecidetheattributetogetorset\nbasedondataintheclosure.)\nThe setter function is passed the Custom object, the new value, and the closure. The new value may be NULL, in\nwhichcasetheattributeisbeingdeleted. Inoursetter,weraiseanerroriftheattributeisdeletedorifitsnewvalue\nisnotastring.\nWecreateanarrayofPyGetSetDefstructures:\nstatic PyGetSetDef Custom_getsetters[] = {\n{\"first\", (getter) Custom_getfirst, (setter) Custom_setfirst,\n\"first name\", NULL},\n{\"last\", (getter) Custom_getlast, (setter) Custom_setlast,\n\"last name\", NULL},\n(continuesonnextpage)\n2.2. DefiningExtensionTypes: Tutorial 37\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\n{NULL} /* Sentinel */\n};\nandregisteritinthetp_getsetslot:\n.tp_getset = Custom_getsetters,\nThelastiteminaPyGetSetDefstructureisthe\u201cclosure\u201dmentionedabove. Inthiscase,wearen\u2019tusingaclosure,\nsowejustpassNULL.\nWealsoremovethememberdefinitionsfortheseattributes:\nstatic PyMemberDef Custom_members[] = {\n{\"number\", Py_T_INT, offsetof(CustomObject, number), 0,\n\"custom number\"},\n{NULL} /* Sentinel */\n};\nWealsoneedtoupdatethetp_inithandlertoonlyallowstrings3tobepassed:\nstatic int\nCustom_init(CustomObject *self, PyObject *args, PyObject *kwds)\n{\nstatic char *kwlist[] = {\"first\", \"last\", \"number\", NULL};\nPyObject *first = NULL, *last = NULL, *tmp;\nif (!PyArg_ParseTupleAndKeywords(args, kwds, \"|UUi\", kwlist,\n&first, &last,\n&self->number))\nreturn -1;\nif (first) {\ntmp = self->first;\nPy_INCREF(first);\nself->first = first;\nPy_DECREF(tmp);\n}\nif (last) {\ntmp = self->last;\nPy_INCREF(last);\nself->last = last;\nPy_DECREF(tmp);\n}\nreturn 0;\n}\nWiththesechanges,wecanassurethatthefirstandlastmembersareneverNULLsowecanremovechecksfor\nNULLvaluesinalmostallcases. ThismeansthatmostofthePy_XDECREF()callscanbeconvertedtoPy_DECREF()\ncalls. Theonlyplacewecan\u2019tchangethesecallsisinthetp_deallocimplementation,wherethereisthepossibility\nthattheinitializationofthesemembersfailedintp_new.\nWealsorenamethemoduleinitializationfunctionandmodulenameintheinitializationfunction,aswedidbefore,\nandweaddanextradefinitiontothesetup.pyfile.\n3Wenowknowthatthefirstandlastmembersarestrings,soperhapswecouldbelesscarefulaboutdecrementingtheirreferencecounts,\nhowever,weacceptinstancesofstringsubclasses. Eventhoughdeallocatingnormalstringswon\u2019tcallbackintoourobjects,wecan\u2019tguarantee\nthatdeallocatinganinstanceofastringsubclasswon\u2019tcallbackintoourobjects.\n38 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\n2.2.4 Supporting cyclic garbage collection\nPythonhasacyclicgarbagecollector(GC)thatcanidentifyunneededobjectsevenwhentheirreferencecountsare\nnotzero. Thiscanhappenwhenobjectsareinvolvedincycles. Forexample,consider:\n>>> l = []\n>>> l.append(l)\n>>> del l\nInthisexample,wecreatealistthatcontainsitself. Whenwedeleteit,itstillhasareferencefromitself. Itsreference\ncount doesn\u2019t drop to zero. Fortunately, Python\u2019s cyclic garbage collector will eventually figure out that the list is\ngarbageandfreeit.\nIn the second version of the Custom example, we allowed any kind of object to be stored in the first or last\nattributes4. Besides, in the second and third versions, we allowed subclassing Custom, and subclasses may add\narbitraryattributes. Foranyofthosetworeasons,Customobjectscanparticipateincycles:\n>>> import custom3\n>>> class Derived(custom3.Custom): pass\n...\n>>> n = Derived()\n>>> n.some_attribute = n\nToallowaCustominstanceparticipatinginareferencecycletobeproperlydetectedandcollectedbythecyclicGC,\nourCustomtypeneedstofilltwoadditionalslotsandtoenableaflagthatenablestheseslots:\n#define PY_SSIZE_T_CLEAN\n#include <Python.h>\n#include <stddef.h> /* for offsetof() */\ntypedef struct {\nPyObject_HEAD\nPyObject *first; /* first name */\nPyObject *last; /* last name */\nint number;\n} CustomObject;\nstatic int\nCustom_traverse(CustomObject *self, visitproc visit, void *arg)\n{\nPy_VISIT(self->first);\nPy_VISIT(self->last);\nreturn 0;\n}\nstatic int\nCustom_clear(CustomObject *self)\n{\nPy_CLEAR(self->first);\nPy_CLEAR(self->last);\nreturn 0;\n}\nstatic void\nCustom_dealloc(CustomObject *self)\n{\nPyObject_GC_UnTrack(self);\n(continuesonnextpage)\n4Also,evenwithourattributesrestrictedtostringsinstances,theusercouldpassarbitrarystrsubclassesandthereforestillcreatereference\ncycles.\n2.2. DefiningExtensionTypes: Tutorial 39\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nCustom_clear(self);\nPy_TYPE(self)->tp_free((PyObject *) self);\n}\nstatic PyObject *\nCustom_new(PyTypeObject *type, PyObject *args, PyObject *kwds)\n{\nCustomObject *self;\nself = (CustomObject *) type->tp_alloc(type, 0);\nif (self != NULL) {\nself->first = PyUnicode_FromString(\"\");\nif (self->first == NULL) {\nPy_DECREF(self);\nreturn NULL;\n}\nself->last = PyUnicode_FromString(\"\");\nif (self->last == NULL) {\nPy_DECREF(self);\nreturn NULL;\n}\nself->number = 0;\n}\nreturn (PyObject *) self;\n}\nstatic int\nCustom_init(CustomObject *self, PyObject *args, PyObject *kwds)\n{\nstatic char *kwlist[] = {\"first\", \"last\", \"number\", NULL};\nPyObject *first = NULL, *last = NULL;\nif (!PyArg_ParseTupleAndKeywords(args, kwds, \"|UUi\", kwlist,\n&first, &last,\n&self->number))\nreturn -1;\nif (first) {\nPy_SETREF(self->first, Py_NewRef(first));\n}\nif (last) {\nPy_SETREF(self->last, Py_NewRef(last));\n}\nreturn 0;\n}\nstatic PyMemberDef Custom_members[] = {\n{\"number\", Py_T_INT, offsetof(CustomObject, number), 0,\n\"custom number\"},\n{NULL} /* Sentinel */\n};\nstatic PyObject *\nCustom_getfirst(CustomObject *self, void *closure)\n{\nreturn Py_NewRef(self->first);\n}\n(continuesonnextpage)\n40 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nstatic int\nCustom_setfirst(CustomObject *self, PyObject *value, void *closure)\n{\nif (value == NULL) {\nPyErr_SetString(PyExc_TypeError, \"Cannot delete the first attribute\");\nreturn -1;\n}\nif (!PyUnicode_Check(value)) {\nPyErr_SetString(PyExc_TypeError,\n\"The first attribute value must be a string\");\nreturn -1;\n}\nPy_XSETREF(self->first, Py_NewRef(value));\nreturn 0;\n}\nstatic PyObject *\nCustom_getlast(CustomObject *self, void *closure)\n{\nreturn Py_NewRef(self->last);\n}\nstatic int\nCustom_setlast(CustomObject *self, PyObject *value, void *closure)\n{\nif (value == NULL) {\nPyErr_SetString(PyExc_TypeError, \"Cannot delete the last attribute\");\nreturn -1;\n}\nif (!PyUnicode_Check(value)) {\nPyErr_SetString(PyExc_TypeError,\n\"The last attribute value must be a string\");\nreturn -1;\n}\nPy_XSETREF(self->last, Py_NewRef(value));\nreturn 0;\n}\nstatic PyGetSetDef Custom_getsetters[] = {\n{\"first\", (getter) Custom_getfirst, (setter) Custom_setfirst,\n\"first name\", NULL},\n{\"last\", (getter) Custom_getlast, (setter) Custom_setlast,\n\"last name\", NULL},\n{NULL} /* Sentinel */\n};\nstatic PyObject *\nCustom_name(CustomObject *self, PyObject *Py_UNUSED(ignored))\n{\nreturn PyUnicode_FromFormat(\"%S %S\", self->first, self->last);\n}\nstatic PyMethodDef Custom_methods[] = {\n{\"name\", (PyCFunction) Custom_name, METH_NOARGS,\n\"Return the name, combining the first and last name\"\n(continuesonnextpage)\n2.2. DefiningExtensionTypes: Tutorial 41\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\n},\n{NULL} /* Sentinel */\n};\nstatic PyTypeObject CustomType = {\n.ob_base = PyVarObject_HEAD_INIT(NULL, 0)\n.tp_name = \"custom4.Custom\",\n.tp_doc = PyDoc_STR(\"Custom objects\"),\n.tp_basicsize = sizeof(CustomObject),\n.tp_itemsize = 0,\n.tp_flags = Py_TPFLAGS_DEFAULT | Py_TPFLAGS_BASETYPE | Py_TPFLAGS_HAVE_GC,\n.tp_new = Custom_new,\n.tp_init = (initproc) Custom_init,\n.tp_dealloc = (destructor) Custom_dealloc,\n.tp_traverse = (traverseproc) Custom_traverse,\n.tp_clear = (inquiry) Custom_clear,\n.tp_members = Custom_members,\n.tp_methods = Custom_methods,\n.tp_getset = Custom_getsetters,\n};\nstatic PyModuleDef custommodule = {\n.m_base = PyModuleDef_HEAD_INIT,\n.m_name = \"custom4\",\n.m_doc = \"Example module that creates an extension type.\",\n.m_size = -1,\n};\nPyMODINIT_FUNC\nPyInit_custom4(void)\n{\nPyObject *m;\nif (PyType_Ready(&CustomType) < 0)\nreturn NULL;\nm = PyModule_Create(&custommodule);\nif (m == NULL)\nreturn NULL;\nif (PyModule_AddObjectRef(m, \"Custom\", (PyObject *) &CustomType) < 0) {\nPy_DECREF(m);\nreturn NULL;\n}\nreturn m;\n}\nFirst,thetraversalmethodletsthecyclicGCknowaboutsubobjectsthatcouldparticipateincycles:\nstatic int\nCustom_traverse(CustomObject *self, visitproc visit, void *arg)\n{\nint vret;\nif (self->first) {\nvret = visit(self->first, arg);\nif (vret != 0)\n(continuesonnextpage)\n42 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nreturn vret;\n}\nif (self->last) {\nvret = visit(self->last, arg);\nif (vret != 0)\nreturn vret;\n}\nreturn 0;\n}\nFor each subobject that can participate in cycles, we need to call the visit() function, which is passed to the\ntraversalmethod. Thevisit()functiontakesasargumentsthesubobjectandtheextraargumentargpassedtothe\ntraversalmethod. Itreturnsanintegervaluethatmustbereturnedifitisnon-zero.\nPythonprovidesaPy_VISIT()macrothatautomatescallingvisitfunctions. WithPy_VISIT(),wecanminimize\ntheamountofboilerplateinCustom_traverse:\nstatic int\nCustom_traverse(CustomObject *self, visitproc visit, void *arg)\n{\nPy_VISIT(self->first);\nPy_VISIT(self->last);\nreturn 0;\n}\n(cid:174) Note\nThetp_traverseimplementationmustnameitsargumentsexactlyvisitandarginordertousePy_VISIT().\nSecond,weneedtoprovideamethodforclearinganysubobjectsthatcanparticipateincycles:\nstatic int\nCustom_clear(CustomObject *self)\n{\nPy_CLEAR(self->first);\nPy_CLEAR(self->last);\nreturn 0;\n}\nNoticetheuseofthePy_CLEAR()macro. Itistherecommendedandsafewaytocleardataattributesofarbitrary\ntypeswhiledecrementingtheirreferencecounts. IfyouweretocallPy_XDECREF()insteadontheattributebefore\nsettingittoNULL,thereisapossibilitythattheattribute\u2019sdestructorwouldcallbackintocodethatreadstheattribute\nagain(especiallyifthereisareferencecycle).\n(cid:174) Note\nYoucouldemulatePy_CLEAR()bywriting:\nPyObject *tmp;\ntmp = self->first;\nself->first = NULL;\nPy_XDECREF(tmp);\nNevertheless,itismucheasierandlesserror-pronetoalwaysusePy_CLEAR()whendeletinganattribute. Don\u2019t\ntrytomicro-optimizeattheexpenseofrobustness!\n2.2. DefiningExtensionTypes: Tutorial 43\nExtendingandEmbeddingPython,Release3.13.3\nThedeallocatorCustom_deallocmaycallarbitrarycodewhenclearingattributes. ItmeansthecircularGCcanbe\ntriggeredinsidethefunction. SincetheGCassumesreferencecountisnotzero,weneedtountracktheobjectfrom\nthe GC by calling PyObject_GC_UnTrack() before clearing members. Here is our reimplemented deallocator\nusingPyObject_GC_UnTrack()andCustom_clear:\nstatic void\nCustom_dealloc(CustomObject *self)\n{\nPyObject_GC_UnTrack(self);\nCustom_clear(self);\nPy_TYPE(self)->tp_free((PyObject *) self);\n}\nFinally,weaddthePy_TPFLAGS_HAVE_GCflagtotheclassflags:\n.tp_flags = Py_TPFLAGS_DEFAULT | Py_TPFLAGS_BASETYPE | Py_TPFLAGS_HAVE_GC,\nThat\u2019s pretty much it. If we had written custom tp_alloc or tp_free handlers, we\u2019d need to modify them for\ncyclicgarbagecollection. Mostextensionswillusetheversionsautomaticallyprovided.\n2.2.5 Subclassing other types\nItispossibletocreatenewextensiontypesthatarederivedfromexistingtypes. Itiseasiesttoinheritfromthebuiltin\ntypes,sinceanextensioncaneasilyusethePyTypeObjectitneeds. ItcanbedifficulttosharethesePyTypeObject\nstructuresbetweenextensionmodules.\nIn this example we will create a SubList type that inherits from the built-in list type. The new type will be\ncompletelycompatiblewithregularlists,butwillhaveanadditionalincrement()methodthatincreasesaninternal\ncounter:\n>>> import sublist\n>>> s = sublist.SubList(range(3))\n>>> s.extend(s)\n>>> print(len(s))\n6\n>>> print(s.increment())\n1\n>>> print(s.increment())\n2\n#define PY_SSIZE_T_CLEAN\n#include <Python.h>\ntypedef struct {\nPyListObject list;\nint state;\n} SubListObject;\nstatic PyObject *\nSubList_increment(SubListObject *self, PyObject *unused)\n{\nself->state++;\nreturn PyLong_FromLong(self->state);\n}\nstatic PyMethodDef SubList_methods[] = {\n{\"increment\", (PyCFunction) SubList_increment, METH_NOARGS,\nPyDoc_STR(\"increment state counter\")},\n(continuesonnextpage)\n44 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\n{NULL},\n};\nstatic int\nSubList_init(SubListObject *self, PyObject *args, PyObject *kwds)\n{\nif (PyList_Type.tp_init((PyObject *) self, args, kwds) < 0)\nreturn -1;\nself->state = 0;\nreturn 0;\n}\nstatic PyTypeObject SubListType = {\nPyVarObject_HEAD_INIT(NULL, 0)\n.tp_name = \"sublist.SubList\",\n.tp_doc = PyDoc_STR(\"SubList objects\"),\n.tp_basicsize = sizeof(SubListObject),\n.tp_itemsize = 0,\n.tp_flags = Py_TPFLAGS_DEFAULT | Py_TPFLAGS_BASETYPE,\n.tp_init = (initproc) SubList_init,\n.tp_methods = SubList_methods,\n};\nstatic PyModuleDef sublistmodule = {\nPyModuleDef_HEAD_INIT,\n.m_name = \"sublist\",\n.m_doc = \"Example module that creates an extension type.\",\n.m_size = -1,\n};\nPyMODINIT_FUNC\nPyInit_sublist(void)\n{\nPyObject *m;\nSubListType.tp_base = &PyList_Type;\nif (PyType_Ready(&SubListType) < 0)\nreturn NULL;\nm = PyModule_Create(&sublistmodule);\nif (m == NULL)\nreturn NULL;\nif (PyModule_AddObjectRef(m, \"SubList\", (PyObject *) &SubListType) < 0) {\nPy_DECREF(m);\nreturn NULL;\n}\nreturn m;\n}\nAsyoucansee,thesourcecodecloselyresemblestheCustomexamplesinprevioussections. Wewillbreakdown\nthemaindifferencesbetweenthem.\ntypedef struct {\nPyListObject list;\nint state;\n} SubListObject;\n2.2. DefiningExtensionTypes: Tutorial 45\nExtendingandEmbeddingPython,Release3.13.3\nTheprimarydifferenceforderivedtypeobjectsisthatthebasetype\u2019sobjectstructuremustbethefirstvalue. The\nbasetypewillalreadyincludethePyObject_HEAD()atthebeginningofitsstructure.\nWhenaPythonobjectisaSubListinstance,itsPyObject *pointercanbesafelycasttobothPyListObject\n*andSubListObject *:\nstatic int\nSubList_init(SubListObject *self, PyObject *args, PyObject *kwds)\n{\nif (PyList_Type.tp_init((PyObject *) self, args, kwds) < 0)\nreturn -1;\nself->state = 0;\nreturn 0;\n}\nWeseeabovehowtocallthroughtothe__init__()methodofthebasetype.\nThispatternisimportantwhenwritingatypewithcustomtp_newandtp_deallocmembers. Thetp_newhandler\nshouldnotactuallycreatethememoryfortheobjectwithitstp_alloc,butletthebaseclasshandleitbycallingits\nowntp_new.\nThe PyTypeObject struct supports a tp_base specifying the type\u2019s concrete base class. Due to cross-platform\ncompiler issues, you can\u2019t fill that field directly with a reference to PyList_Type; it should be done later in the\nmoduleinitializationfunction:\nPyMODINIT_FUNC\nPyInit_sublist(void)\n{\nPyObject* m;\nSubListType.tp_base = &PyList_Type;\nif (PyType_Ready(&SubListType) < 0)\nreturn NULL;\nm = PyModule_Create(&sublistmodule);\nif (m == NULL)\nreturn NULL;\nif (PyModule_AddObjectRef(m, \"SubList\", (PyObject *) &SubListType) < 0) {\nPy_DECREF(m);\nreturn NULL;\n}\nreturn m;\n}\nBeforecallingPyType_Ready(),thetypestructuremusthavethetp_baseslotfilledin. Whenwearederivingan\nexistingtype,itisnotnecessarytofilloutthetp_allocslotwithPyType_GenericNew()\u2013theallocationfunction\nfromthebasetypewillbeinherited.\nAfterthat,callingPyType_Ready()andaddingthetypeobjecttothemoduleisthesameaswiththebasicCustom\nexamples.\n2.3 Defining Extension Types: Assorted Topics\nThissectionaimstogiveaquickfly-byonthevarioustypemethodsyoucanimplementandwhattheydo.\nHereisthedefinitionofPyTypeObject,withsomefieldsonlyusedindebugbuildsomitted:\ntypedef struct _typeobject {\nPyObject_VAR_HEAD\n(continuesonnextpage)\n46 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nconst char *tp_name; /* For printing, in format \"<module>.<name>\" */\nPy_ssize_t tp_basicsize, tp_itemsize; /* For allocation */\n/* Methods to implement standard operations */\ndestructor tp_dealloc;\nPy_ssize_t tp_vectorcall_offset;\ngetattrfunc tp_getattr;\nsetattrfunc tp_setattr;\nPyAsyncMethods *tp_as_async; /* formerly known as tp_compare (Python 2)\nor tp_reserved (Python 3) */\nreprfunc tp_repr;\n/* Method suites for standard classes */\nPyNumberMethods *tp_as_number;\nPySequenceMethods *tp_as_sequence;\nPyMappingMethods *tp_as_mapping;\n/* More standard operations (here for binary compatibility) */\nhashfunc tp_hash;\nternaryfunc tp_call;\nreprfunc tp_str;\ngetattrofunc tp_getattro;\nsetattrofunc tp_setattro;\n/* Functions to access object as input/output buffer */\nPyBufferProcs *tp_as_buffer;\n/* Flags to define presence of optional/expanded features */\nunsigned long tp_flags;\nconst char *tp_doc; /* Documentation string */\n/* Assigned meaning in release 2.0 */\n/* call function for all accessible objects */\ntraverseproc tp_traverse;\n/* delete references to contained objects */\ninquiry tp_clear;\n/* Assigned meaning in release 2.1 */\n/* rich comparisons */\nrichcmpfunc tp_richcompare;\n/* weak reference enabler */\nPy_ssize_t tp_weaklistoffset;\n/* Iterators */\ngetiterfunc tp_iter;\niternextfunc tp_iternext;\n/* Attribute descriptor and subclassing stuff */\nstruct PyMethodDef *tp_methods;\nstruct PyMemberDef *tp_members;\n(continuesonnextpage)\n2.3. DefiningExtensionTypes: AssortedTopics 47\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nstruct PyGetSetDef *tp_getset;\n// Strong reference on a heap type, borrowed reference on a static type\nstruct _typeobject *tp_base;\nPyObject *tp_dict;\ndescrgetfunc tp_descr_get;\ndescrsetfunc tp_descr_set;\nPy_ssize_t tp_dictoffset;\ninitproc tp_init;\nallocfunc tp_alloc;\nnewfunc tp_new;\nfreefunc tp_free; /* Low-level free-memory routine */\ninquiry tp_is_gc; /* For PyObject_IS_GC */\nPyObject *tp_bases;\nPyObject *tp_mro; /* method resolution order */\nPyObject *tp_cache;\nPyObject *tp_subclasses;\nPyObject *tp_weaklist;\ndestructor tp_del;\n/* Type attribute cache version tag. Added in version 2.6 */\nunsigned int tp_version_tag;\ndestructor tp_finalize;\nvectorcallfunc tp_vectorcall;\n/* bitset of which type-watchers care about this type */\nunsigned char tp_watched;\n} PyTypeObject;\nNowthat\u2019salot ofmethods. Don\u2019tworrytoomuchthough\u2013ifyouhaveatypeyouwanttodefine,thechancesare\nverygoodthatyouwillonlyimplementahandfulofthese.\nAsyouprobablyexpectbynow,we\u2019regoingtogooverthisandgivemoreinformationaboutthevarioushandlers.\nWewon\u2019tgointheordertheyaredefinedinthestructure,becausethereisalotofhistoricalbaggagethatimpacts\ntheorderingofthefields. It\u2019softeneasiesttofindanexamplethatincludesthefieldsyouneedandthenchangethe\nvaluestosuityournewtype.\nconst char *tp_name; /* For printing */\nThenameofthetype\u2013asmentionedinthepreviouschapter,thiswillappearinvariousplaces,almostentirelyfor\ndiagnosticpurposes. Trytochoosesomethingthatwillbehelpfulinsuchasituation!\nPy_ssize_t tp_basicsize, tp_itemsize; /* For allocation */\nThesefieldstelltheruntimehowmuchmemorytoallocatewhennewobjectsofthistypearecreated. Pythonhas\nsomebuilt-insupportforvariablelengthstructures(think: strings, tuples)whichiswherethetp_itemsizefield\ncomesin. Thiswillbedealtwithlater.\nconst char *tp_doc;\nHereyoucanputastring(oritsaddress)thatyouwantreturnedwhenthePythonscriptreferencesobj.__doc__\ntoretrievethedocstring.\nNowwecometothebasictypemethods\u2013theonesmostextensiontypeswillimplement.\n48 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\n2.3.1 Finalization and De-allocation\ndestructor tp_dealloc;\nThis function is called when the reference count of the instance of your type is reduced to zero and the Python\ninterpreterwantstoreclaimit. Ifyourtypehasmemorytofreeorotherclean-uptoperform, youcanputithere.\nTheobjectitselfneedstobefreedhereaswell. Hereisanexampleofthisfunction:\nstatic void\nnewdatatype_dealloc(newdatatypeobject *obj)\n{\nfree(obj->obj_UnderlyingDatatypePtr);\nPy_TYPE(obj)->tp_free((PyObject *)obj);\n}\nIfyourtypesupportsgarbagecollection,thedestructorshouldcallPyObject_GC_UnTrack()beforeclearingany\nmemberfields:\nstatic void\nnewdatatype_dealloc(newdatatypeobject *obj)\n{\nPyObject_GC_UnTrack(obj);\nPy_CLEAR(obj->other_obj);\n...\nPy_TYPE(obj)->tp_free((PyObject *)obj);\n}\nOneimportantrequirementofthedeallocatorfunctionisthatitleavesanypendingexceptionsalone. Thisisimportant\nsincedeallocatorsarefrequentlycalledastheinterpreterunwindsthePythonstack;whenthestackisunwounddueto\nanexception(ratherthannormalreturns),nothingisdonetoprotectthedeallocatorsfromseeingthatanexceptionhas\nalreadybeenset. AnyactionswhichadeallocatorperformswhichmaycauseadditionalPythoncodetobeexecuted\nmaydetectthatanexceptionhasbeenset. Thiscanleadtomisleadingerrorsfromtheinterpreter. Theproperway\ntoprotectagainstthisistosaveapendingexceptionbeforeperformingtheunsafeaction,andrestoringitwhendone.\nThiscanbedoneusingthePyErr_Fetch()andPyErr_Restore()functions:\nstatic void\nmy_dealloc(PyObject *obj)\n{\nMyObject *self = (MyObject *) obj;\nPyObject *cbresult;\nif (self->my_callback != NULL) {\nPyObject *err_type, *err_value, *err_traceback;\n/* This saves the current exception state */\nPyErr_Fetch(&err_type, &err_value, &err_traceback);\ncbresult = PyObject_CallNoArgs(self->my_callback);\nif (cbresult == NULL)\nPyErr_WriteUnraisable(self->my_callback);\nelse\nPy_DECREF(cbresult);\n/* This restores the saved exception state */\nPyErr_Restore(err_type, err_value, err_traceback);\nPy_DECREF(self->my_callback);\n}\n(continuesonnextpage)\n2.3. DefiningExtensionTypes: AssortedTopics 49\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nPy_TYPE(obj)->tp_free((PyObject*)self);\n}\n(cid:174) Note\nThere are limitations to what you can safely do in a deallocator function. First, if your type supports garbage\ncollection (using tp_traverse and/or tp_clear), some of the object\u2019s members can have been cleared or\nfinalized by the time tp_dealloc is called. Second, in tp_dealloc, your object is in an unstable state: its\nreferencecountisequaltozero. Anycalltoanon-trivialobjectorAPI(asintheexampleabove)mightendup\ncallingtp_deallocagain,causingadoublefreeandacrash.\nStartingwithPython3.4,itisrecommendednottoputanycomplexfinalizationcodeintp_dealloc,andinstead\nusethenewtp_finalizetypemethod.\n(cid:181) Seealso\nPEP442explainsthenewfinalizationscheme.\n2.3.2 Object Presentation\nInPython,therearetwowaystogenerateatextualrepresentationofanobject: therepr()function,andthestr()\nfunction. (Theprint()functionjustcallsstr().) Thesehandlersarebothoptional.\nreprfunc tp_repr;\nreprfunc tp_str;\nThetp_reprhandlershouldreturnastringobjectcontainingarepresentationoftheinstanceforwhichitiscalled.\nHereisasimpleexample:\nstatic PyObject *\nnewdatatype_repr(newdatatypeobject *obj)\n{\nreturn PyUnicode_FromFormat(\"Repr-ified_newdatatype{{size:%d}}\",\nobj->obj_UnderlyingDatatypePtr->size);\n}\nIfnotp_reprhandlerisspecified,theinterpreterwillsupplyarepresentationthatusesthetype\u2019stp_nameanda\nuniquelyidentifyingvaluefortheobject.\nThetp_strhandleristostr()whatthetp_reprhandlerdescribedaboveistorepr();thatis,itiscalledwhen\nPythoncodecallsstr()onaninstanceofyourobject. Itsimplementationisverysimilartothetp_reprfunction,\nbuttheresultingstringisintendedforhumanconsumption. Iftp_strisnotspecified,thetp_reprhandlerisused\ninstead.\nHereisasimpleexample:\nstatic PyObject *\nnewdatatype_str(newdatatypeobject *obj)\n{\nreturn PyUnicode_FromFormat(\"Stringified_newdatatype{{size:%d}}\",\nobj->obj_UnderlyingDatatypePtr->size);\n}\n50 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\n2.3.3 Attribute Management\nForeveryobjectwhichcansupportattributes,thecorrespondingtypemustprovidethefunctionsthatcontrolhowthe\nattributesareresolved. Thereneedstobeafunctionwhichcanretrieveattributes(ifanyaredefined),andanotherto\nsetattributes(ifsettingattributesisallowed). Removinganattributeisaspecialcase,forwhichthenewvaluepassed\ntothehandlerisNULL.\nPythonsupportstwopairsofattributehandlers;atypethatsupportsattributesonlyneedstoimplementthefunctions\nforonepair. Thedifferenceisthatonepairtakesthenameoftheattributeas a char*, whiletheotheracceptsa\nPyObject*. Eachtypecanusewhicheverpairmakesmoresensefortheimplementation\u2019sconvenience.\ngetattrfunc tp_getattr; /* char * version */\nsetattrfunc tp_setattr;\n/* ... */\ngetattrofunc tp_getattro; /* PyObject * version */\nsetattrofunc tp_setattro;\nIf accessing attributes of an object is always a simple operation (this will be explained shortly), there are generic\nimplementationswhichcanbeusedtoprovidethePyObject*versionoftheattributemanagementfunctions. The\nactualneedfortype-specificattributehandlersalmostcompletelydisappearedstartingwithPython2.2,thoughthere\naremanyexampleswhichhavenotbeenupdatedtousesomeofthenewgenericmechanismthatisavailable.\nGenericAttributeManagement\nMostextensiontypesonlyusesimpleattributes. So,whatmakestheattributessimple? Thereareonlyacoupleof\nconditionsthatmustbemet:\n1. ThenameoftheattributesmustbeknownwhenPyType_Ready()iscalled.\n2. Nospecialprocessingisneededtorecordthatanattributewaslookeduporset,nordoactionsneedtobetaken\nbasedonthevalue.\nNotethatthislistdoesnotplaceanyrestrictionsonthevaluesoftheattributes, whenthevaluesarecomputed, or\nhowrelevantdataisstored.\nWhenPyType_Ready()iscalled,itusesthreetablesreferencedbythetypeobjecttocreatedescriptorswhichare\nplacedinthedictionaryofthetypeobject. Eachdescriptorcontrolsaccesstooneattributeoftheinstanceobject.\nEachofthetablesisoptional;ifallthreeareNULL,instancesofthetypewillonlyhaveattributesthatareinherited\nfromtheirbasetype,andshouldleavethetp_getattroandtp_setattrofieldsNULLaswell,allowingthebase\ntypetohandleattributes.\nThetablesaredeclaredasthreefieldsofthetypeobject:\nstruct PyMethodDef *tp_methods;\nstruct PyMemberDef *tp_members;\nstruct PyGetSetDef *tp_getset;\nIf tp_methods is not NULL, it must refer to an array of PyMethodDef structures. Each entry in the table is an\ninstanceofthisstructure:\ntypedef struct PyMethodDef {\nconst char *ml_name; /* method name */\nPyCFunction ml_meth; /* implementation function */\nint ml_flags; /* flags */\nconst char *ml_doc; /* docstring */\n} PyMethodDef;\nOneentryshouldbedefinedforeachmethodprovidedbythetype;noentriesareneededformethodsinheritedfrom\nabasetype. Oneadditionalentryisneededattheend;itisasentinelthatmarkstheendofthearray. Theml_name\nfieldofthesentinelmustbeNULL.\nThesecondtableisusedtodefineattributeswhichmapdirectlytodatastoredintheinstance. Avarietyofprimitive\nCtypesaresupported,andaccessmayberead-onlyorread-write. Thestructuresinthetablearedefinedas:\n2.3. DefiningExtensionTypes: AssortedTopics 51\nExtendingandEmbeddingPython,Release3.13.3\ntypedef struct PyMemberDef {\nconst char *name;\nint type;\nint offset;\nint flags;\nconst char *doc;\n} PyMemberDef;\nForeachentryinthetable,adescriptorwillbeconstructedandaddedtothetypewhichwillbeabletoextractavalue\nfromtheinstancestructure. ThetypefieldshouldcontainatypecodelikePy_T_INTorPy_T_DOUBLE;thevalue\nwillbeusedtodeterminehowtoconvertPythonvaluestoandfromCvalues. Theflagsfieldisusedtostoreflags\nwhichcontrolhowtheattributecanbeaccessed: youcansetittoPy_READONLYtopreventPythoncodefromsetting\nit.\nAn interesting advantage of using the tp_members table to build descriptors that are used at runtime is that any\nattributedefinedthiswaycanhaveanassociateddocstringsimplybyprovidingthetextinthetable. Anapplication\ncanusetheintrospectionAPItoretrievethedescriptorfromtheclassobject,andgetthedocstringusingits__doc__\nattribute.\nAswiththetp_methodstable,asentinelentrywithaml_namevalueofNULLisrequired.\nType-specificAttributeManagement\nForsimplicity, onlythechar*versionwillbedemonstratedhere; thetypeofthenameparameteristheonlydif-\nferencebetweenthechar*andPyObject*flavorsoftheinterface. Thisexampleeffectivelydoesthesamething\nasthegenericexampleabove,butdoesnotusethegenericsupportaddedinPython2.2. Itexplainshowthehandler\nfunctionsarecalled,sothatifyoudoneedtoextendtheirfunctionality,you\u2019llunderstandwhatneedstobedone.\nThetp_getattrhandleriscalledwhentheobjectrequiresanattributelook-up. Itiscalledinthesamesituations\nwherethe__getattr__()methodofaclasswouldbecalled.\nHereisanexample:\nstatic PyObject *\nnewdatatype_getattr(newdatatypeobject *obj, char *name)\n{\nif (strcmp(name, \"data\") == 0)\n{\nreturn PyLong_FromLong(obj->data);\n}\nPyErr_Format(PyExc_AttributeError,\n\"'%.100s' object has no attribute '%.400s'\",\nPy_TYPE(obj)->tp_name, name);\nreturn NULL;\n}\nThe tp_setattr handler is called when the __setattr__() or __delattr__() method of a class instance\nwould be called. When an attribute should be deleted, the third parameter will be NULL. Here is an example that\nsimplyraisesanexception;ifthiswerereallyallyouwanted,thetp_setattrhandlershouldbesettoNULL.\nstatic int\nnewdatatype_setattr(newdatatypeobject *obj, char *name, PyObject *v)\n{\nPyErr_Format(PyExc_RuntimeError, \"Read-only attribute: %s\", name);\nreturn -1;\n}\n52 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\n2.3.4 Object Comparison\nrichcmpfunc tp_richcompare;\nThe tp_richcompare handler is called when comparisons are needed. It is analogous to the rich comparison\nmethods,like__lt__(),andalsocalledbyPyObject_RichCompare()andPyObject_RichCompareBool().\nThisfunctioniscalledwithtwoPythonobjectsandtheoperatorasarguments,wheretheoperatorisoneofPy_EQ,\nPy_NE,Py_LE,Py_GE,Py_LTorPy_GT.Itshouldcomparethetwoobjectswithrespecttothespecifiedoperatorand\nreturnPy_TrueorPy_Falseifthecomparisonissuccessful,Py_NotImplementedtoindicatethatcomparison\nisnotimplementedandtheotherobject\u2019scomparisonmethodshouldbetried,orNULLifanexceptionwasset.\nHereisasampleimplementation,foradatatypethatisconsideredequalifthesizeofaninternalpointerisequal:\nstatic PyObject *\nnewdatatype_richcmp(newdatatypeobject *obj1, newdatatypeobject *obj2, int op)\n{\nPyObject *result;\nint c, size1, size2;\n/* code to make sure that both arguments are of type\nnewdatatype omitted */\nsize1 = obj1->obj_UnderlyingDatatypePtr->size;\nsize2 = obj2->obj_UnderlyingDatatypePtr->size;\nswitch (op) {\ncase Py_LT: c = size1 < size2; break;\ncase Py_LE: c = size1 <= size2; break;\ncase Py_EQ: c = size1 == size2; break;\ncase Py_NE: c = size1 != size2; break;\ncase Py_GT: c = size1 > size2; break;\ncase Py_GE: c = size1 >= size2; break;\n}\nresult = c ? Py_True : Py_False;\nPy_INCREF(result);\nreturn result;\n}\n2.3.5 Abstract Protocol Support\nPython supports a variety of abstract \u2018protocols;\u2019 the specific interfaces provided to use these interfaces are docu-\nmentedinabstract.\nAnumberoftheseabstractinterfacesweredefinedearlyinthedevelopmentofthePythonimplementation. Inpar-\nticular,thenumber,mapping,andsequenceprotocolshavebeenpartofPythonsincethebeginning. Otherprotocols\nhavebeenaddedovertime. Forprotocolswhichdependonseveralhandlerroutinesfromthetypeimplementation,\ntheolderprotocolshavebeendefinedasoptionalblocksofhandlersreferencedbythetypeobject. Fornewerpro-\ntocolsthereareadditionalslotsinthemaintypeobject,withaflagbitbeingsettoindicatethattheslotsarepresent\nandshouldbecheckedbytheinterpreter. (Theflagbitdoesnotindicatethattheslotvaluesarenon-NULL.Theflag\nmaybesettoindicatethepresenceofaslot,butaslotmaystillbeunfilled.)\nPyNumberMethods *tp_as_number;\nPySequenceMethods *tp_as_sequence;\nPyMappingMethods *tp_as_mapping;\nIfyouwishyourobjecttobeabletoactlikeanumber,asequence,oramappingobject,thenyouplacetheaddress\nof a structure that implements the C type PyNumberMethods, PySequenceMethods, or PyMappingMethods,\nrespectively. Itisuptoyoutofillinthisstructurewithappropriatevalues. Youcanfindexamplesoftheuseofeach\noftheseintheObjectsdirectoryofthePythonsourcedistribution.\n2.3. DefiningExtensionTypes: AssortedTopics 53\nExtendingandEmbeddingPython,Release3.13.3\nhashfunc tp_hash;\nThisfunction,ifyouchoosetoprovideit,shouldreturnahashnumberforaninstanceofyourdatatype. Hereisa\nsimpleexample:\nstatic Py_hash_t\nnewdatatype_hash(newdatatypeobject *obj)\n{\nPy_hash_t result;\nresult = obj->some_size + 32767 * obj->some_number;\nif (result == -1)\nresult = -2;\nreturn result;\n}\nPy_hash_tisasignedintegertypewithaplatform-varyingwidth. Returning-1fromtp_hashindicatesanerror,\nwhichiswhyyoushouldbecarefultoavoidreturningitwhenhashcomputationissuccessful,asseenabove.\nternaryfunc tp_call;\nThisfunctioniscalledwhenaninstanceofyourdatatypeis\u201ccalled\u201d,forexample,ifobj1isaninstanceofyourdata\ntypeandthePythonscriptcontainsobj1('hello'),thetp_callhandlerisinvoked.\nThisfunctiontakesthreearguments:\n1. self istheinstanceofthedatatypewhichisthesubjectofthecall. Ifthecallisobj1('hello'),thenself is\nobj1.\n2. argsisatuplecontainingtheargumentstothecall. YoucanusePyArg_ParseTuple()toextracttheargu-\nments.\n3. kwds is a dictionary of keyword arguments that were passed. If this is non-NULL and you support keyword\narguments,usePyArg_ParseTupleAndKeywords()toextractthearguments. Ifyoudonotwanttosupport\nkeywordargumentsandthisisnon-NULL,raiseaTypeErrorwithamessagesayingthatkeywordarguments\narenotsupported.\nHereisatoytp_callimplementation:\nstatic PyObject *\nnewdatatype_call(newdatatypeobject *obj, PyObject *args, PyObject *kwds)\n{\nPyObject *result;\nconst char *arg1;\nconst char *arg2;\nconst char *arg3;\nif (!PyArg_ParseTuple(args, \"sss:call\", &arg1, &arg2, &arg3)) {\nreturn NULL;\n}\nresult = PyUnicode_FromFormat(\n\"Returning -- value: [%d] arg1: [%s] arg2: [%s] arg3: [%s]\\n\",\nobj->obj_UnderlyingDatatypePtr->size,\narg1, arg2, arg3);\nreturn result;\n}\n/* Iterators */\ngetiterfunc tp_iter;\niternextfunc tp_iternext;\n54 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\nThesefunctionsprovidesupportfortheiteratorprotocol. Bothhandlerstakeexactlyoneparameter,theinstancefor\nwhichthey arebeing called, andreturn a new reference. In the case ofan error, they should setan exceptionand\nreturnNULL.tp_itercorrespondstothePython__iter__()method, whiletp_iternextcorrespondstothe\nPython__next__()method.\nAny iterable object must implement the tp_iter handler, which must return an iterator object. Here the same\nguidelinesapplyasforPythonclasses:\n\u2022 Forcollections(suchaslistsandtuples)whichcansupportmultipleindependentiterators,anewiteratorshould\nbecreatedandreturnedbyeachcalltotp_iter.\n\u2022 Objectswhichcanonlybeiteratedoveronce(usuallyduetosideeffectsofiteration,suchasfileobjects)can\nimplement tp_iter by returning a new reference to themselves \u2013 and should also therefore implement the\ntp_iternexthandler.\nAny iterator object should implement both tp_iter and tp_iternext. An iterator\u2019s tp_iter handler should\nreturnanewreferencetotheiterator. Itstp_iternexthandlershouldreturnanewreferencetothenextobjectin\ntheiteration, ifthereisone. Iftheiterationhasreachedtheend, tp_iternextmayreturnNULLwithoutsetting\nanexception,oritmaysetStopIterationinadditiontoreturningNULL;avoidingtheexceptioncanyieldslightly\nbetterperformance. Ifanactualerroroccurs,tp_iternextshouldalwayssetanexceptionandreturnNULL.\n2.3.6 Weak Reference Support\nOneofthegoalsofPython\u2019sweakreferenceimplementationistoallowanytypetoparticipateintheweakreference\nmechanismwithoutincurringtheoverheadonperformance-criticalobjects(suchasnumbers).\n(cid:181) Seealso\nDocumentationfortheweakrefmodule.\nForanobjecttobeweaklyreferenceable,theextensiontypemustsetthePy_TPFLAGS_MANAGED_WEAKREFbitof\nthetp_flagsfield. Thelegacytp_weaklistoffsetfieldshouldbeleftaszero.\nConcretely,hereishowthestaticallydeclaredtypeobjectwouldlook:\nstatic PyTypeObject TrivialType = {\nPyVarObject_HEAD_INIT(NULL, 0)\n/* ... other members omitted for brevity ... */\n.tp_flags = Py_TPFLAGS_MANAGED_WEAKREF | ...,\n};\nThe only further addition is that tp_dealloc needs to clear any weak references (by calling\nPyObject_ClearWeakRefs()):\nstatic void\nTrivial_dealloc(TrivialObject *self)\n{\n/* Clear weakrefs first before calling any destructors */\nPyObject_ClearWeakRefs((PyObject *) self);\n/* ... remainder of destruction code omitted for brevity ... */\nPy_TYPE(self)->tp_free((PyObject *) self);\n}\n2.3.7 More Suggestions\nIn order to learn how to implement any specific method for your new data type, get the CPython source code.\nGo to the Objects directory, then search the C source files for tp_ plus the function you want (for example,\ntp_richcompare). Youwillfindexamplesofthefunctionyouwanttoimplement.\nWhen you need to verify that an object is a concrete instance of the type you are implementing, use the\nPyObject_TypeCheck()function. Asampleofitsusemightbesomethinglikethefollowing:\n2.3. DefiningExtensionTypes: AssortedTopics 55\nExtendingandEmbeddingPython,Release3.13.3\nif (!PyObject_TypeCheck(some_object, &MyType)) {\nPyErr_SetString(PyExc_TypeError, \"arg #1 not a mything\");\nreturn NULL;\n}\n(cid:181) Seealso\nDownloadCPythonsourcereleases.\nhttps://www.python.org/downloads/source/\nTheCPythonprojectonGitHub,wheretheCPythonsourcecodeisdeveloped.\nhttps://github.com/python/cpython\n2.4 Building C and C++ Extensions\nA C extension for CPython is a shared library (e.g. a .so file on Linux, .pyd on Windows), which exports an\ninitializationfunction.\nTobeimportable,thesharedlibrarymustbeavailableonPYTHONPATH,andmustbenamedafterthemodulename,\nwithanappropriateextension. Whenusingsetuptools,thecorrectfilenameisgeneratedautomatically.\nTheinitializationfunctionhasthesignature:\nPyObject*PyInit_modulename(void)\nItreturnseitherafullyinitializedmodule,oraPyModuleDefinstance. Seeinitializing-modulesfordetails.\nFormoduleswithASCII-onlynames,thefunctionmustbenamedPyInit_<modulename>,with<modulename>\nreplacedbythenameofthemodule. Whenusingmulti-phase-initialization,non-ASCIImodulenamesareallowed.\nIn this case, the initialization function name is PyInitU_<modulename>, with <modulename> encoded using\nPython\u2019spunycodeencodingwithhyphensreplacedbyunderscores. InPython:\ndef initfunc_name(name):\ntry:\nsuffix = b'_' + name.encode('ascii')\nexcept UnicodeEncodeError:\nsuffix = b'U_' + name.encode('punycode').replace(b'-', b'_')\nreturn b'PyInit' + suffix\nIt is possible to export multiple modules from a single shared library by defining multiple initialization functions.\nHowever,importingthemrequiresusingsymboliclinksoracustomimporter,becausebydefaultonlythefunction\ncorrespondingtothefilenameisfound. Seethe\u201cMultiplemodulesinonelibrary\u201d sectioninPEP489fordetails.\n2.4.1 Building C and C++ Extensions with setuptools\nPython 3.12 and newer no longer come with distutils. Please refer to the setuptools documentation at https:\n//setuptools.readthedocs.io/en/latest/setuptools.htmltolearnmoreabouthowbuildanddistributeC/C++extensions\nwithsetuptools.\n2.5 Building C and C++ Extensions on Windows\nThis chapter briefly explains how to create a Windows extension module for Python using Microsoft Visual C++,\nandfollowswithmoredetailedbackgroundinformationonhowitworks. Theexplanatorymaterialisusefulforboth\nthe Windows programmer learning to build Python extensions and the Unix programmer interested in producing\nsoftwarewhichcanbesuccessfullybuiltonbothUnixandWindows.\n56 Chapter2. Creatingextensionswithoutthirdpartytools\nExtendingandEmbeddingPython,Release3.13.3\nModule authors are encouraged to use the distutils approach for building extension modules, instead of the one\ndescribedinthissection. YouwillstillneedtheCcompilerthatwasusedtobuildPython;typicallyMicrosoftVisual\nC++.\n(cid:174) Note\nThischaptermentionsanumberoffilenamesthatincludeanencodedPythonversionnumber. Thesefilenames\nare represented with the version number shown as XY; in practice, 'X' will be the major version number and\n'Y'willbetheminorversionnumberofthePythonreleaseyou\u2019reworkingwith. Forexample,ifyouareusing\nPython2.2.1,XYwillactuallybe22.\n2.5.1 A Cookbook Approach\nTherearetwoapproachestobuildingextensionmodulesonWindows,justasthereareonUnix:usethesetuptools\npackagetocontrolthebuildprocess,ordothingsmanually. Thesetuptoolsapproachworkswellformostextensions;\ndocumentationonusingsetuptoolstobuildandpackageextensionmodulesisavailableinBuildingCandC++\nExtensionswithsetuptools. Ifyoufindyoureallyneedtodothingsmanually,itmaybeinstructivetostudytheproject\nfileforthewinsoundstandardlibrarymodule.\n2.5.2 Differences Between Unix and Windows\nUnixandWindowsusecompletelydifferentparadigmsforrun-timeloadingofcode. Beforeyoutrytobuildamodule\nthatcanbedynamicallyloaded,beawareofhowyoursystemworks.\nInUnix,asharedobject(.so)filecontainscodetobeusedbytheprogram,andalsothenamesoffunctionsanddata\nthatitexpectstofindintheprogram. Whenthefileisjoinedtotheprogram,allreferencestothosefunctionsand\ndatainthefile\u2019scodearechangedtopointtotheactuallocationsintheprogramwherethefunctionsanddataare\nplacedinmemory. Thisisbasicallyalinkoperation.\nInWindows,adynamic-linklibrary(.dll)filehasnodanglingreferences. Instead,anaccesstofunctionsordata\ngoes through a lookup table. So the DLL code does not have to be fixed up at runtime to refer to the program\u2019s\nmemory;instead,thecodealreadyusestheDLL\u2019slookuptable,andthelookuptableismodifiedatruntimetopoint\ntothefunctionsanddata.\nInUnix,thereisonlyonetypeoflibraryfile(.a)whichcontainscodefromseveralobjectfiles(.o). Duringthelink\nsteptocreateasharedobjectfile(.so),thelinkermayfindthatitdoesn\u2019tknowwhereanidentifierisdefined. The\nlinkerwilllookforitintheobjectfilesinthelibraries;ifitfindsit,itwillincludeallthecodefromthatobjectfile.\nInWindows,therearetwotypesoflibrary,astaticlibraryandanimportlibrary(bothcalled.lib). Astaticlibrary\nislikeaUnix.afile;itcontainscodetobeincludedasnecessary. Animportlibraryisbasicallyusedonlytoreassure\nthelinkerthatacertainidentifierislegal,andwillbepresentintheprogramwhentheDLLisloaded. Sothelinker\nusestheinformationfromtheimportlibrarytobuildthelookuptableforusingidentifiersthatarenotincludedinthe\nDLL.WhenanapplicationoraDLLislinked,animportlibrarymaybegenerated,whichwillneedtobeusedfor\nallfutureDLLsthatdependonthesymbolsintheapplicationorDLL.\nSuppose you are building two dynamic-load modules, B and C, which should share another block of code A. On\nUnix,youwouldnot passA.atothelinkerforB.soandC.so;thatwouldcauseittobeincludedtwice,sothatB\nandCwouldeachhavetheirowncopy. InWindows,buildingA.dllwillalsobuildA.lib. YoudopassA.libto\nthelinkerforBandC.A.libdoesnotcontaincode;itjustcontainsinformationwhichwillbeusedatruntimeto\naccessA\u2019scode.\nIn Windows, using an import library is sort of like using import spam; it gives you access to spam\u2019s names, but\ndoesnotcreateaseparatecopy. OnUnix,linkingwithalibraryismorelikefrom spam import *;itdoescreate\naseparatecopy.\n2.5. BuildingCandC++ExtensionsonWindows 57\nExtendingandEmbeddingPython,Release3.13.3\n2.5.3 Using DLLs in Practice\nWindows Python is built in Microsoft Visual C++; using other compilers may or may not work. The rest of this\nsectionisMSVC++specific.\nWhencreatingDLLsinWindows, youmustpasspythonXY.libtothelinker. TobuildtwoDLLs, spamandni\n(whichusesCfunctionsfoundinspam),youcouldusethesecommands:\ncl /LD /I/python/include spam.c ../libs/pythonXY.lib\ncl /LD /I/python/include ni.c spam.lib ../libs/pythonXY.lib\nThe first command created three files: spam.obj, spam.dll and spam.lib. Spam.dll does not contain any\nPython functions (such as PyArg_ParseTuple()), but it does know how to find the Python code thanks to\npythonXY.lib.\nThesecondcommandcreatedni.dll(and.objand.lib),whichknowshowtofindthenecessaryfunctionsfrom\nspam,andalsofromthePythonexecutable.\nNot every identifier is exported to the lookup table. If you want any other modules (including Python) to be\nable to see your identifiers, you have to say _declspec(dllexport), as in void _declspec(dllexport)\ninitspam(void)orPyObject _declspec(dllexport) *NiGetSpamData(void).\nDeveloper Studio will throw in a lot of import libraries that you do not really need, adding about 100K to your\nexecutable. Togetridofthem,usetheProjectSettingsdialog,Linktab,tospecifyignoredefaultlibraries. Addthe\ncorrectmsvcrtxx.libtothelistoflibraries.\n58 Chapter2. Creatingextensionswithoutthirdpartytools\nCHAPTER\nTHREE\nEMBEDDING THE CPYTHON RUNTIME IN A LARGER\nAPPLICATION\nSometimes, rather than creating an extension that runs inside the Python interpreter as the main application, it is\ndesirabletoinsteadembedtheCPythonruntimeinsidealargerapplication. Thissectioncoverssomeofthedetails\ninvolvedindoingthatsuccessfully.\n3.1 Embedding Python in Another Application\nThepreviouschaptersdiscussedhowtoextendPython,thatis,howtoextendthefunctionalityofPythonbyattaching\na library of C functions to it. It is also possible to do it the other way around: enrich your C/C++ application by\nembeddingPythoninit. Embeddingprovidesyourapplicationwiththeabilitytoimplementsomeofthefunctionality\nofyourapplicationinPythonratherthanCorC++. Thiscanbeusedformanypurposes;oneexamplewouldbeto\nallowuserstotailortheapplicationtotheirneedsbywritingsomescriptsinPython. Youcanalsouseityourselfif\nsomeofthefunctionalitycanbewritteninPythonmoreeasily.\nEmbeddingPythonissimilartoextendingit,butnotquite. ThedifferenceisthatwhenyouextendPython,themain\nprogramoftheapplicationisstillthePythoninterpreter,whileifyouembedPython,themainprogrammayhave\nnothingtodowithPython\u2014instead,somepartsoftheapplicationoccasionallycallthePythoninterpretertorun\nsomePythoncode.\nSoifyouareembeddingPython,youareprovidingyourownmainprogram. Oneofthethingsthismainprogram\nhas to do is initialize the Python interpreter. At the very least, you have to call the function Py_Initialize().\nThereareoptionalcallstopasscommandlineargumentstoPython. Thenlateryoucancalltheinterpreterfromany\npartoftheapplication.\nThere are several different ways to call the interpreter: you can pass a string containing Python statements to\nPyRun_SimpleString(),oryoucanpassastdiofilepointerandafilename(foridentificationinerrormessages\nonly)toPyRun_SimpleFile(). Youcanalsocallthelower-leveloperationsdescribedinthepreviouschaptersto\nconstructandusePythonobjects.\n(cid:181) Seealso\nc-api-index\nThedetailsofPython\u2019sCinterfacearegiveninthismanual. Agreatdealofnecessaryinformationcanbe\nfoundhere.\n3.1.1 Very High Level Embedding\nThe simplest form of embedding Python is the use of the very high level interface. This interface is intended to\nexecuteaPythonscriptwithoutneedingtointeractwiththeapplicationdirectly. Thiscanforexamplebe usedto\nperformsomeoperationonafile.\n#define PY_SSIZE_T_CLEAN\n#include <Python.h>\n(continuesonnextpage)\n59\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nint\nmain(int argc, char *argv[])\n{\nPyStatus status;\nPyConfig config;\nPyConfig_InitPythonConfig(&config);\n/* optional but recommended */\nstatus = PyConfig_SetBytesString(&config, &config.program_name, argv[0]);\nif (PyStatus_Exception(status)) {\ngoto exception;\n}\nstatus = Py_InitializeFromConfig(&config);\nif (PyStatus_Exception(status)) {\ngoto exception;\n}\nPyConfig_Clear(&config);\nPyRun_SimpleString(\"from time import time,ctime\\n\"\n\"print('Today is', ctime(time()))\\n\");\nif (Py_FinalizeEx() < 0) {\nexit(120);\n}\nreturn 0;\nexception:\nPyConfig_Clear(&config);\nPy_ExitStatusException(status);\n}\n(cid:174) Note\n#define PY_SSIZE_T_CLEAN was used to indicatethat Py_ssize_t shouldbe used insomeAPIs instead\nofint. ItisnotnecessarysincePython3.13,butwekeepithereforbackwardcompatibility. Seearg-parsing-\nstring-and-buffersforadescriptionofthismacro.\nSettingPyConfig.program_nameshouldbecalledbeforePy_InitializeFromConfig()toinformtheinter-\npreteraboutpathstoPythonrun-timelibraries. Next,thePythoninterpreterisinitializedwithPy_Initialize(),\nfollowed by the execution of a hard-coded Python script that prints the date and time. Afterwards, the\nPy_FinalizeEx() call shuts the interpreter down, followed by the end of the program. In a real program, you\nmaywanttogetthePythonscriptfromanothersource,perhapsatext-editorroutine,afile,oradatabase. Getting\nthePythoncodefromafilecanbetterbedonebyusingthePyRun_SimpleFile()function,whichsavesyouthe\ntroubleofallocatingmemoryspaceandloadingthefilecontents.\n3.1.2 Beyond Very High Level Embedding: An overview\nThehighlevelinterfacegivesyoutheabilitytoexecutearbitrarypiecesofPythoncodefromyourapplication,but\nexchangingdatavaluesisquitecumbersometosaytheleast. Ifyouwantthat,youshoulduselowerlevelcalls. At\nthecostofhavingtowritemoreCcode,youcanachievealmostanything.\nItshouldbenotedthatextendingPythonandembeddingPythonisquitethesameactivity,despitethedifferentintent.\nMosttopicsdiscussedinthepreviouschaptersarestillvalid. Toshowthis,considerwhattheextensioncodefrom\nPythontoCreallydoes:\n1. ConvertdatavaluesfromPythontoC,\n60 Chapter3. EmbeddingtheCPythonruntimeinalargerapplication\nExtendingandEmbeddingPython,Release3.13.3\n2. PerformafunctioncalltoaCroutineusingtheconvertedvalues,and\n3. ConvertthedatavaluesfromthecallfromCtoPython.\nWhenembeddingPython,theinterfacecodedoes:\n1. ConvertdatavaluesfromCtoPython,\n2. PerformafunctioncalltoaPythoninterfaceroutineusingtheconvertedvalues,and\n3. ConvertthedatavaluesfromthecallfromPythontoC.\nAsyoucansee,thedataconversionstepsaresimplyswappedtoaccommodatethedifferentdirectionofthecross-\nlanguagetransfer. Theonlydifferenceistheroutinethatyoucallbetweenbothdataconversions. Whenextending,\nyoucallaCroutine,whenembedding,youcallaPythonroutine.\nThischapterwillnotdiscusshowtoconvertdatafromPythontoCandviceversa. Also,properuseofreferences\nanddealingwitherrorsisassumedtobeunderstood. Sincetheseaspectsdonotdifferfromextendingtheinterpreter,\nyoucanrefertoearlierchaptersfortherequiredinformation.\n3.1.3 Pure Embedding\nThefirstprogramaimstoexecuteafunctioninaPythonscript. Likeinthesectionabouttheveryhighlevelinterface,\nthePythoninterpreterdoesnotdirectlyinteractwiththeapplication(butthatwillchangeinthenextsection).\nThecodetorunafunctiondefinedinaPythonscriptis:\n#define PY_SSIZE_T_CLEAN\n#include <Python.h>\nint\nmain(int argc, char *argv[])\n{\nPyObject *pName, *pModule, *pFunc;\nPyObject *pArgs, *pValue;\nint i;\nif (argc < 3) {\nfprintf(stderr,\"Usage: call pythonfile funcname [args]\\n\");\nreturn 1;\n}\nPy_Initialize();\npName = PyUnicode_DecodeFSDefault(argv[1]);\n/* Error checking of pName left out */\npModule = PyImport_Import(pName);\nPy_DECREF(pName);\nif (pModule != NULL) {\npFunc = PyObject_GetAttrString(pModule, argv[2]);\n/* pFunc is a new reference */\nif (pFunc && PyCallable_Check(pFunc)) {\npArgs = PyTuple_New(argc - 3);\nfor (i = 0; i < argc - 3; ++i) {\npValue = PyLong_FromLong(atoi(argv[i + 3]));\nif (!pValue) {\nPy_DECREF(pArgs);\nPy_DECREF(pModule);\nfprintf(stderr, \"Cannot convert argument\\n\");\nreturn 1;\n(continuesonnextpage)\n3.1. EmbeddingPythoninAnotherApplication 61\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\n}\n/* pValue reference stolen here: */\nPyTuple_SetItem(pArgs, i, pValue);\n}\npValue = PyObject_CallObject(pFunc, pArgs);\nPy_DECREF(pArgs);\nif (pValue != NULL) {\nprintf(\"Result of call: %ld\\n\", PyLong_AsLong(pValue));\nPy_DECREF(pValue);\n}\nelse {\nPy_DECREF(pFunc);\nPy_DECREF(pModule);\nPyErr_Print();\nfprintf(stderr,\"Call failed\\n\");\nreturn 1;\n}\n}\nelse {\nif (PyErr_Occurred())\nPyErr_Print();\nfprintf(stderr, \"Cannot find function \\\"%s\\\"\\n\", argv[2]);\n}\nPy_XDECREF(pFunc);\nPy_DECREF(pModule);\n}\nelse {\nPyErr_Print();\nfprintf(stderr, \"Failed to load \\\"%s\\\"\\n\", argv[1]);\nreturn 1;\n}\nif (Py_FinalizeEx() < 0) {\nreturn 120;\n}\nreturn 0;\n}\nThiscodeloadsaPythonscriptusingargv[1],andcallsthefunctionnamedinargv[2]. Itsintegerargumentsare\ntheothervaluesoftheargvarray. Ifyoucompileandlinkthisprogram(let\u2019scallthefinishedexecutablecall),and\nuseittoexecuteaPythonscript,suchas:\ndef multiply(a,b):\nprint(\"Will compute\", a, \"times\", b)\nc = 0\nfor i in range(0, a):\nc = c + b\nreturn c\nthentheresultshouldbe:\n$ call multiply multiply 3 2\nWill compute 3 times 2\nResult of call: 6\nAlthoughtheprogramisquitelargeforitsfunctionality,mostofthecodeisfordataconversionbetweenPythonand\nC,andforerrorreporting. TheinterestingpartwithrespecttoembeddingPythonstartswith\n62 Chapter3. EmbeddingtheCPythonruntimeinalargerapplication\nExtendingandEmbeddingPython,Release3.13.3\nPy_Initialize();\npName = PyUnicode_DecodeFSDefault(argv[1]);\n/* Error checking of pName left out */\npModule = PyImport_Import(pName);\nAfterinitializingtheinterpreter,thescriptisloadedusingPyImport_Import(). ThisroutineneedsaPythonstring\nasitsargument,whichisconstructedusingthePyUnicode_DecodeFSDefault()dataconversionroutine.\npFunc = PyObject_GetAttrString(pModule, argv[2]);\n/* pFunc is a new reference */\nif (pFunc && PyCallable_Check(pFunc)) {\n...\n}\nPy_XDECREF(pFunc);\nOncethescriptisloaded,thenamewe\u2019relookingforisretrievedusingPyObject_GetAttrString(). Ifthename\nexists,andtheobjectreturnediscallable,youcansafelyassumethatitisafunction. Theprogramthenproceedsby\nconstructingatupleofargumentsasnormal. ThecalltothePythonfunctionisthenmadewith:\npValue = PyObject_CallObject(pFunc, pArgs);\nUponreturnofthefunction,pValueiseitherNULLoritcontainsareferencetothereturnvalueofthefunction. Be\nsuretoreleasethereferenceafterexaminingthevalue.\n3.1.4 Extending Embedded Python\nUntilnow,theembeddedPythoninterpreterhadnoaccesstofunctionalityfromtheapplicationitself. ThePython\nAPIallowsthisbyextendingtheembeddedinterpreter. Thatis,theembeddedinterpretergetsextendedwithroutines\nprovidedbytheapplication. Whileitsoundscomplex,itisnotsobad. Simplyforgetforawhilethattheapplication\nstartsthePythoninterpreter. Instead,considertheapplicationtobeasetofsubroutines,andwritesomegluecode\nthatgivesPythonaccesstothoseroutines,justlikeyouwouldwriteanormalPythonextension. Forexample:\nstatic int numargs=0;\n/* Return the number of arguments of the application command line */\nstatic PyObject*\nemb_numargs(PyObject *self, PyObject *args)\n{\nif(!PyArg_ParseTuple(args, \":numargs\"))\nreturn NULL;\nreturn PyLong_FromLong(numargs);\n}\nstatic PyMethodDef EmbMethods[] = {\n{\"numargs\", emb_numargs, METH_VARARGS,\n\"Return the number of arguments received by the process.\"},\n{NULL, NULL, 0, NULL}\n};\nstatic PyModuleDef EmbModule = {\nPyModuleDef_HEAD_INIT, \"emb\", NULL, -1, EmbMethods,\nNULL, NULL, NULL, NULL\n};\nstatic PyObject*\nPyInit_emb(void)\n(continuesonnextpage)\n3.1. EmbeddingPythoninAnotherApplication 63\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\n{\nreturn PyModule_Create(&EmbModule);\n}\nInserttheabovecodejustabovethemain()function. Also, insertthefollowingtwostatementsbeforethecallto\nPy_Initialize():\nnumargs = argc;\nPyImport_AppendInittab(\"emb\", &PyInit_emb);\nThesetwolinesinitializethenumargsvariable,andmaketheemb.numargs()functionaccessibletotheembedded\nPythoninterpreter. Withtheseextensions,thePythonscriptcandothingslike\nimport emb\nprint(\"Number of arguments\", emb.numargs())\nInarealapplication,themethodswillexposeanAPIoftheapplicationtoPython.\n3.1.5 Embedding Python in C++\nItisalsopossibletoembedPythoninaC++program; preciselyhowthisisdonewilldependonthedetailsofthe\nC++systemused;ingeneralyouwillneedtowritethemainprograminC++,andusetheC++compilertocompile\nandlinkyourprogram. ThereisnoneedtorecompilePythonitselfusingC++.\n3.1.6 Compiling and Linking under Unix-like systems\nItisnotnecessarilytrivialtofindtherightflagstopasstoyourcompiler(andlinker)inordertoembedthePythonin-\nterpreterintoyourapplication,particularlybecausePythonneedstoloadlibrarymodulesimplementedasCdynamic\nextensions(.sofiles)linkedagainstit.\nTofindouttherequiredcompilerandlinkerflags,youcanexecutethepythonX.Y-configscriptwhichisgenerated\naspartoftheinstallationprocess(apython3-configscriptmayalsobeavailable). Thisscripthasseveraloptions,\nofwhichthefollowingwillbedirectlyusefultoyou:\n\u2022 pythonX.Y-config --cflagswillgiveyoutherecommendedflagswhencompiling:\n$ /opt/bin/python3.11-config --cflags\n-I/opt/include/python3.11 -I/opt/include/python3.11 -Wsign-compare -DNDEBUG -\n,\u2192g -fwrapv -O3 -Wall\n\u2022 pythonX.Y-config --ldflags --embedwillgiveyoutherecommendedflagswhenlinking:\n$ /opt/bin/python3.11-config --ldflags --embed\n-L/opt/lib/python3.11/config-3.11-x86_64-linux-gnu -L/opt/lib -lpython3.11 -\n,\u2192lpthread -ldl -lutil -lm\n(cid:174) Note\nToavoidconfusionbetweenseveralPythoninstallations(andespeciallybetweenthesystemPythonandyourown\ncompiledPython), itisrecommendedthatyouusetheabsolutepathtopythonX.Y-config, asintheabove\nexample.\nIfthisproceduredoesn\u2019tworkforyou(itisnotguaranteedtoworkforallUnix-likeplatforms;however,wewelcome\nbug reports) you will have to read your system\u2019s documentation about dynamic linking and/or examine Python\u2019s\nMakefile(usesysconfig.get_makefile_filename()tofinditslocation)andcompilationoptions. Inthis\ncase,thesysconfigmoduleisausefultooltoprogrammaticallyextracttheconfigurationvaluesthatyouwillwant\ntocombinetogether. Forexample:\n64 Chapter3. EmbeddingtheCPythonruntimeinalargerapplication\nExtendingandEmbeddingPython,Release3.13.3\n>>> import sysconfig\n>>> sysconfig.get_config_var('LIBS')\n'-lpthread -ldl -lutil'\n>>> sysconfig.get_config_var('LINKFORSHARED')\n'-Xlinker -export-dynamic'\n3.1. EmbeddingPythoninAnotherApplication 65\nExtendingandEmbeddingPython,Release3.13.3\n66 Chapter3. EmbeddingtheCPythonruntimeinalargerapplication\nAPPENDIX\nA\nGLOSSARY\n>>>\nThe default Python prompt of the interactive shell. Often seen for code examples which can be executed\ninteractivelyintheinterpreter.\n...\nCanreferto:\n\u2022 ThedefaultPythonpromptoftheinteractiveshellwhenenteringthecodeforanindentedcodeblock,\nwhen within a pair of matching left and right delimiters (parentheses, square brackets, curly braces or\ntriplequotes),orafterspecifyingadecorator.\n\u2022 TheEllipsisbuilt-inconstant.\nabstractbaseclass\nAbstractbaseclassescomplementduck-typingbyprovidingawaytodefineinterfaceswhenothertechniques\nlikehasattr()wouldbeclumsyorsubtlywrong(forexamplewithmagicmethods). ABCsintroducevirtual\nsubclasses, which are classes that don\u2019t inherit from a class but are still recognized by isinstance() and\nissubclass();seetheabcmoduledocumentation. Pythoncomeswithmanybuilt-inABCsfordatastruc-\ntures(inthecollections.abcmodule),numbers(inthenumbersmodule),streams(intheiomodule),\nimportfindersandloaders(intheimportlib.abcmodule). YoucancreateyourownABCswiththeabc\nmodule.\nannotation\nAlabelassociatedwithavariable,aclassattributeorafunctionparameterorreturnvalue,usedbyconvention\nasatypehint.\nAnnotations of local variables cannot be accessed at runtime, but annotations of global variables, class at-\ntributes, andfunctionsarestoredinthe__annotations__specialattributeofmodules, classes, andfunc-\ntions,respectively.\nSeevariableannotation,functionannotation,PEP484andPEP526,whichdescribethisfunctionality. Also\nseeannotations-howtoforbestpracticesonworkingwithannotations.\nargument\nAvaluepassedtoafunction(ormethod)whencallingthefunction. Therearetwokindsofargument:\n\u2022 keywordargument: anargumentprecededbyanidentifier(e.g. name=)inafunctioncallorpassedasa\nvalueinadictionaryprecededby**. Forexample,3and5arebothkeywordargumentsinthefollowing\ncallstocomplex():\ncomplex(real=3, imag=5)\ncomplex(**{'real': 3, 'imag': 5})\n\u2022 positionalargument: anargumentthatisnotakeywordargument. Positionalargumentscanappearatthe\nbeginningofanargumentlistand/orbepassedaselementsofaniterableprecededby*. Forexample,3\nand5arebothpositionalargumentsinthefollowingcalls:\ncomplex(3, 5)\ncomplex(*(3, 5))\n67\nExtendingandEmbeddingPython,Release3.13.3\nArguments are assigned to the named local variables in a function body. See the calls section for the rules\ngoverningthisassignment. Syntactically,anyexpressioncanbeusedtorepresentanargument;theevaluated\nvalueisassignedtothelocalvariable.\nSeealsotheparameterglossaryentry,theFAQquestiononthedifferencebetweenargumentsandparameters,\nandPEP362.\nasynchronouscontextmanager\nAnobjectwhichcontrolstheenvironmentseeninanasync withstatementbydefining__aenter__()and\n__aexit__()methods. IntroducedbyPEP492.\nasynchronousgenerator\nAfunctionwhichreturnsanasynchronousgeneratoriterator. Itlookslikeacoroutinefunctiondefinedwith\nasync def except that it contains yield expressions for producing a series of values usable in an async\nforloop.\nUsuallyreferstoanasynchronousgeneratorfunction, butmayrefertoanasynchronousgeneratoriterator in\nsomecontexts. Incaseswheretheintendedmeaningisn\u2019tclear,usingthefulltermsavoidsambiguity.\nAnasynchronousgeneratorfunctionmaycontainawaitexpressionsaswellasasync for,andasync with\nstatements.\nasynchronousgeneratoriterator\nAnobjectcreatedbyaasynchronousgeneratorfunction.\nThisisanasynchronousiteratorwhichwhencalledusingthe__anext__()methodreturnsanawaitableobject\nwhichwillexecutethebodyoftheasynchronousgeneratorfunctionuntilthenextyieldexpression.\nEachyieldtemporarilysuspendsprocessing,rememberingtheexecutionstate(includinglocalvariablesand\npendingtry-statements). Whentheasynchronousgeneratoriteratoreffectivelyresumeswithanotherawaitable\nreturnedby__anext__(),itpicksupwhereitleftoff. SeePEP492andPEP525.\nasynchronousiterable\nAn object, that can be used in an async for statement. Must return an asynchronous iterator from its\n__aiter__()method. IntroducedbyPEP492.\nasynchronousiterator\nAn object that implements the __aiter__() and __anext__() methods. __anext__() must return an\nawaitableobject. async forresolvestheawaitablesreturnedbyanasynchronousiterator\u2019s__anext__()\nmethoduntilitraisesaStopAsyncIterationexception. IntroducedbyPEP492.\nattribute\nAvalueassociatedwithanobjectwhichisusuallyreferencedbynameusingdottedexpressions. Forexample,\nifanobjectohasanattributeaitwouldbereferencedaso.a.\nItispossibletogiveanobjectanattributewhosenameisnotanidentifierasdefinedbyidentifiers,forexample\nusingsetattr(),iftheobjectallowsit. Suchanattributewillnotbeaccessibleusingadottedexpression,\nandwouldinsteadneedtoberetrievedwithgetattr().\nawaitable\nAnobjectthatcanbeusedinanawaitexpression. Canbeacoroutineoranobjectwithan__await__()\nmethod. SeealsoPEP492.\nBDFL\nBenevolentDictatorForLife,a.k.a. GuidovanRossum,Python\u2019screator.\nbinaryfile\nAfileobjectabletoreadandwritebytes-likeobjects. Examplesofbinaryfilesarefilesopenedinbinarymode\n('rb','wb'or'rb+'),sys.stdin.buffer,sys.stdout.buffer,andinstancesofio.BytesIOand\ngzip.GzipFile.\nSeealsotextfileforafileobjectabletoreadandwritestrobjects.\nborrowedreference\nInPython\u2019sCAPI,aborrowedreferenceisareferencetoanobject,wherethecodeusingtheobjectdoesnot\nownthereference. Itbecomesadanglingpointeriftheobjectisdestroyed. Forexample,agarbagecollection\ncanremovethelaststrongreferencetotheobjectandsodestroyit.\n68 AppendixA. Glossary\nExtendingandEmbeddingPython,Release3.13.3\nCallingPy_INCREF()ontheborrowedreferenceisrecommendedtoconvertittoastrongreferencein-place,\nexceptwhentheobjectcannotbedestroyedbeforethelastusageoftheborrowedreference. ThePy_NewRef()\nfunctioncanbeusedtocreateanewstrongreference.\nbytes-likeobject\nAn object that supports the bufferobjects and can export a C-contiguous buffer. This includes all bytes,\nbytearray,andarray.arrayobjects,aswellasmanycommonmemoryviewobjects. Bytes-likeobjects\ncanbeusedforvariousoperationsthatworkwithbinarydata;theseincludecompression,savingtoabinary\nfile,andsendingoverasocket.\nSomeoperationsneedthebinarydatatobemutable. Thedocumentationoftenreferstotheseas\u201cread-write\nbytes-likeobjects\u201d. Examplemutablebufferobjectsincludebytearrayandamemoryviewofabytearray.\nOther operations require the binary data to be stored in immutable objects (\u201cread-only bytes-like objects\u201d);\nexamplesoftheseincludebytesandamemoryviewofabytesobject.\nbytecode\nPythonsourcecodeiscompiledintobytecode,theinternalrepresentationofaPythonprogramintheCPython\ninterpreter. Thebytecodeisalsocachedin.pycfilessothatexecutingthesamefileisfasterthesecondtime\n(recompilation from source to bytecode can be avoided). This \u201cintermediate language\u201d is said to run on a\nvirtualmachinethatexecutesthemachinecodecorrespondingtoeachbytecode. Donotethatbytecodesare\nnotexpectedtoworkbetweendifferentPythonvirtualmachines,nortobestablebetweenPythonreleases.\nAlistofbytecodeinstructionscanbefoundinthedocumentationforthedismodule.\ncallable\nAcallableisanobjectthatcanbecalled,possiblywithasetofarguments(seeargument),withthefollowing\nsyntax:\ncallable(argument1, argument2, argumentN)\nAfunction,andbyextensionamethod,isacallable. Aninstanceofaclassthatimplementsthe__call__()\nmethodisalsoacallable.\ncallback\nAsubroutinefunctionwhichispassedasanargumenttobeexecutedatsomepointinthefuture.\nclass\nA template for creating user-defined objects. Class definitions normally contain method definitions which\noperateoninstancesoftheclass.\nclassvariable\nAvariabledefinedinaclassandintendedtobemodifiedonlyatclasslevel(i.e.,notinaninstanceoftheclass).\nclosurevariable\nAfreevariablereferencedfromanestedscopethatisdefinedinanouterscoperatherthanbeingresolvedat\nruntime from the globals or builtin namespaces. May be explicitly defined with the nonlocal keyword to\nallowwriteaccess,orimplicitlydefinedifthevariableisonlybeingread.\nForexample,intheinnerfunctioninthefollowingcode,bothxandprintarefreevariables,butonlyxis\naclosurevariable:\ndef outer():\nx = 0\ndef inner():\nnonlocal x\nx += 1\nprint(x)\nreturn inner\nDuetothecodeobject.co_freevarsattribute(which,despiteitsname,onlyincludesthenamesofclosure\nvariablesratherthanlistingallreferencedfreevariables),themoregeneralfreevariabletermissometimesused\nevenwhentheintendedmeaningistoreferspecificallytoclosurevariables.\n69\nExtendingandEmbeddingPython,Release3.13.3\ncomplexnumber\nAnextensionofthefamiliarrealnumbersysteminwhichallnumbersareexpressedasasumofarealpartand\nanimaginarypart. Imaginarynumbersarerealmultiplesoftheimaginaryunit(thesquarerootof-1),often\nwritten i in mathematics or j in engineering. Python has built-in support for complex numbers, which are\nwrittenwiththislatternotation;theimaginarypartiswrittenwithajsuffix,e.g.,3+1j. Togetaccesstocom-\nplexequivalentsofthemathmodule,usecmath. Useofcomplexnumbersisafairlyadvancedmathematical\nfeature. Ifyou\u2019renotawareofaneedforthem,it\u2019salmostcertainyoucansafelyignorethem.\ncontext\nThistermhasdifferentmeaningsdependingonwhereandhowitisused. Somecommonmeanings:\n\u2022 Thetemporarystateorenvironmentestablishedbyacontextmanagerviaawithstatement.\n\u2022 The collection of keyvalue bindings associated with a particular contextvars.Context object and\naccessedviaContextVarobjects. Alsoseecontextvariable.\n\u2022 Acontextvars.Contextobject. Alsoseecurrentcontext.\ncontextmanagementprotocol\nThe__enter__()and__exit__()methodscalledbythewithstatement. SeePEP343.\ncontextmanager\nAnobjectwhichimplementsthecontextmanagementprotocol andcontrolstheenvironmentseenina with\nstatement. SeePEP343.\ncontextvariable\nA variable whose value depends on which context is the current context. Values are accessed via\ncontextvars.ContextVarobjects. Contextvariablesareprimarilyusedtoisolatestatebetweenconcur-\nrentasynchronoustasks.\ncontiguous\nAbufferisconsideredcontiguousexactlyifitiseitherC-contiguousorFortrancontiguous. Zero-dimensional\nbuffersareCandFortrancontiguous. Inone-dimensionalarrays,theitemsmustbelaidoutinmemorynext\ntoeachother,inorderofincreasingindexesstartingfromzero. InmultidimensionalC-contiguousarrays,the\nlastindexvariesthefastestwhenvisitingitemsinorderofmemoryaddress. However,inFortrancontiguous\narrays,thefirstindexvariesthefastest.\ncoroutine\nCoroutines are a more generalized form of subroutines. Subroutines are entered at one point and exited at\nanotherpoint. Coroutinescanbeentered,exited,andresumedatmanydifferentpoints. Theycanbeimple-\nmentedwiththeasync defstatement. SeealsoPEP492.\ncoroutinefunction\nAfunctionwhichreturnsacoroutineobject. Acoroutinefunctionmaybedefinedwiththeasync defstate-\nment, and may contain await, async for, and async with keywords. These were introduced by PEP\n492.\nCPython\nThecanonicalimplementationofthePythonprogramminglanguage,asdistributedonpython.org. Theterm\n\u201cCPython\u201disusedwhennecessarytodistinguishthisimplementationfromotherssuchasJythonorIronPython.\ncurrentcontext\nThecontext (contextvars.Contextobject)thatiscurrentlyusedbyContextVarobjectstoaccess(get\nor set) the values of context variables. Each thread has its own current context. Frameworks for executing\nasynchronous tasks (see asyncio) associate each task with a context which becomes the current context\nwheneverthetaskstartsorresumesexecution.\ndecorator\nAfunctionreturninganotherfunction,usuallyappliedasafunctiontransformationusingthe@wrappersyntax.\nCommonexamplesfordecoratorsareclassmethod()andstaticmethod().\nThedecoratorsyntaxismerelysyntacticsugar,thefollowingtwofunctiondefinitionsaresemanticallyequiv-\nalent:\n70 AppendixA. Glossary\nExtendingandEmbeddingPython,Release3.13.3\ndef f(arg):\n...\nf = staticmethod(f)\n@staticmethod\ndef f(arg):\n...\nThe same concept exists for classes, but is less commonly used there. See the documentation for function\ndefinitionsandclassdefinitionsformoreaboutdecorators.\ndescriptor\nAnyobjectwhichdefinesthemethods__get__(),__set__(),or__delete__(). Whenaclassattribute\nis a descriptor, its special binding behavior is triggered upon attribute lookup. Normally, using a.b to get,\nset or delete an attribute looks up the object named b in the class dictionary for a, but if b is a descriptor,\ntherespectivedescriptormethodgetscalled. Understandingdescriptorsisakeytoadeepunderstandingof\nPythonbecausetheyarethebasisformanyfeaturesincludingfunctions,methods,properties,classmethods,\nstaticmethods,andreferencetosuperclasses.\nFormoreinformationaboutdescriptors\u2019methods,seedescriptorsortheDescriptorHowToGuide.\ndictionary\nAnassociativearray,wherearbitrarykeysaremappedtovalues. Thekeyscanbeanyobjectwith__hash__()\nand__eq__()methods. CalledahashinPerl.\ndictionarycomprehension\nA compact way to process all or part of the elements in an iterable and return a dictionary with the re-\nsults. results = {n: n ** 2 for n in range(10)}generatesadictionarycontainingkeynmapped\ntovaluen ** 2. Seecomprehensions.\ndictionaryview\nTheobjectsreturnedfromdict.keys(),dict.values(),anddict.items()arecalleddictionaryviews.\nTheyprovideadynamicviewonthedictionary\u2019sentries,whichmeansthatwhenthedictionarychanges,the\nview reflects these changes. To force the dictionary view to become a full list use list(dictview). See\ndict-views.\ndocstring\nAstringliteralwhichappearsasthefirstexpressioninaclass,functionormodule. Whileignoredwhenthe\nsuiteisexecuted,itisrecognizedbythecompilerandputintothe__doc__attributeoftheenclosingclass,\nfunctionormodule. Sinceitisavailableviaintrospection,itisthecanonicalplacefordocumentationofthe\nobject.\nduck-typing\nAprogrammingstylewhichdoesnotlookatanobject\u2019stypetodetermineifithastherightinterface;instead,\nthe method or attribute is simply called or used (\u201cIf it looks like a duck and quacks like a duck, it must be\na duck.\u201d) By emphasizing interfaces rather than specific types, well-designed code improves its flexibility\nby allowing polymorphic substitution. Duck-typing avoids tests using type() or isinstance(). (Note,\nhowever, that duck-typing can be complemented with abstract base classes.) Instead, it typically employs\nhasattr()testsorEAFPprogramming.\nEAFP\nEasier to ask for forgiveness than permission. This common Python coding style assumes the existence of\nvalid keys or attributes and catches exceptions if the assumption proves false. This clean and fast style is\ncharacterizedbythepresenceofmanytryandexceptstatements. ThetechniquecontrastswiththeLBYL\nstylecommontomanyotherlanguagessuchasC.\nexpression\nApieceofsyntaxwhichcanbeevaluatedtosomevalue. Inotherwords,anexpressionisanaccumulationof\nexpressionelementslikeliterals,names,attributeaccess,operatorsorfunctioncallswhichallreturnavalue. In\ncontrasttomanyotherlanguages,notalllanguageconstructsareexpressions. Therearealsostatementswhich\ncannotbeusedasexpressions,suchaswhile. Assignmentsarealsostatements,notexpressions.\n71\nExtendingandEmbeddingPython,Release3.13.3\nextensionmodule\nAmodulewritteninCorC++,usingPython\u2019sCAPItointeractwiththecoreandwithusercode.\nf-string\nString literals prefixed with 'f' or 'F' are commonly called \u201cf-strings\u201d which is short for formatted string\nliterals. SeealsoPEP498.\nfileobject\nAnobjectexposingafile-orientedAPI(withmethodssuchasread()orwrite())toanunderlyingresource.\nDependingonthewayitwascreated,afileobjectcanmediateaccesstoarealon-diskfileortoanothertypeof\nstorageorcommunicationdevice(forexamplestandardinput/output,in-memorybuffers,sockets,pipes,etc.).\nFileobjectsarealsocalledfile-likeobjectsorstreams.\nThereareactuallythreecategoriesoffileobjects: rawbinaryfiles, bufferedbinaryfilesandtextfiles. Their\ninterfaces are defined in the io module. The canonical way to create a file object is by using the open()\nfunction.\nfile-likeobject\nAsynonymforfileobject.\nfilesystemencodinganderrorhandler\nEncodinganderrorhandlerusedbyPythontodecodebytesfromtheoperatingsystemandencodeUnicodeto\ntheoperatingsystem.\nThefilesystemencodingmustguaranteetosuccessfullydecodeallbytesbelow128. Ifthefilesystemencoding\nfailstoprovidethisguarantee,APIfunctionscanraiseUnicodeError.\nThe sys.getfilesystemencoding() and sys.getfilesystemencodeerrors() functions can be\nusedtogetthefilesystemencodinganderrorhandler.\nThefilesystemencodinganderrorhandlerareconfiguredatPythonstartupbythePyConfig_Read()func-\ntion: seefilesystem_encodingandfilesystem_errorsmembersofPyConfig.\nSeealsothelocaleencoding.\nfinder\nAnobjectthattriestofindtheloaderforamodulethatisbeingimported.\nTherearetwotypesoffinder: metapathfindersforusewithsys.meta_path,andpathentryfindersforuse\nwithsys.path_hooks.\nSeefinders-and-loadersandimportlibformuchmoredetail.\nfloordivision\nMathematicaldivisionthatroundsdowntonearestinteger. Thefloordivisionoperatoris//. Forexample,the\nexpression11 // 4evaluatesto2incontrasttothe2.75returnedbyfloattruedivision. Notethat(-11)\n// 4is-3becausethatis-2.75roundeddownward. SeePEP238.\nfreethreading\nAthreadingmodelwheremultiplethreadscanrunPythonbytecodesimultaneouslywithinthesameinterpreter.\nThisisincontrasttotheglobalinterpreterlockwhichallowsonlyonethreadtoexecutePythonbytecodeata\ntime. SeePEP703.\nfreevariable\nFormally, as defined in the language execution model, a free variable is any variable used in a namespace\nwhichisnotalocalvariableinthatnamespace. Seeclosurevariableforanexample. Pragmatically,duetothe\nnameofthecodeobject.co_freevarsattribute,thetermisalsosometimesusedasasynonymforclosure\nvariable.\nfunction\nAseriesofstatementswhichreturnssomevaluetoacaller. Itcanalsobepassedzeroormoreargumentswhich\nmaybeusedintheexecutionofthebody. Seealsoparameter,method,andthefunctionsection.\nfunctionannotation\nAnannotationofafunctionparameterorreturnvalue.\n72 AppendixA. Glossary\nExtendingandEmbeddingPython,Release3.13.3\nFunction annotations are usually used for type hints: for example, this function is expected to take two int\nargumentsandisalsoexpectedtohaveanintreturnvalue:\ndef sum_two_numbers(a: int, b: int) -> int:\nreturn a + b\nFunctionannotationsyntaxisexplainedinsectionfunction.\nSeevariableannotationandPEP484,whichdescribethisfunctionality. Alsoseeannotations-howtoforbest\npracticesonworkingwithannotations.\n__future__\nAfuturestatement,from __future__ import <feature>,directsthecompilertocompilethecurrent\nmoduleusingsyntaxorsemanticsthatwillbecomestandardinafuturereleaseofPython. The__future__\nmoduledocumentsthepossiblevaluesoffeature. Byimportingthismoduleandevaluatingitsvariables,you\ncanseewhenanewfeaturewasfirstaddedtothelanguageandwhenitwill(ordid)becomethedefault:\n>>> import __future__\n>>> __future__.division\n_Feature((2, 2, 0, 'alpha', 2), (3, 0, 0, 'alpha', 0), 8192)\ngarbagecollection\nTheprocessoffreeingmemorywhenitisnotusedanymore. Pythonperformsgarbagecollectionviareference\ncountingandacyclicgarbagecollectorthatisabletodetectandbreakreferencecycles. Thegarbagecollector\ncanbecontrolledusingthegcmodule.\ngenerator\nA function which returns a generator iterator. It looks like a normal function except that it contains yield\nexpressionsforproducingaseriesofvaluesusableinafor-looporthatcanberetrievedoneatatimewiththe\nnext()function.\nUsuallyreferstoageneratorfunction,butmayrefertoageneratoriterator insomecontexts. Incaseswhere\ntheintendedmeaningisn\u2019tclear,usingthefulltermsavoidsambiguity.\ngeneratoriterator\nAnobjectcreatedbyageneratorfunction.\nEachyieldtemporarilysuspendsprocessing,rememberingtheexecutionstate(includinglocalvariablesand\npending try-statements). When the generator iterator resumes, it picks up where it left off (in contrast to\nfunctionswhichstartfreshoneveryinvocation).\ngeneratorexpression\nAnexpressionthatreturnsaniterator. Itlookslikeanormalexpressionfollowedbyaforclausedefininga\nloop variable, range, andan optional if clause. The combinedexpressiongeneratesvaluesfor an enclosing\nfunction:\n>>> sum(i*i for i in range(10)) # sum of squares 0, 1, 4, ... 81\n285\ngenericfunction\nAfunctioncomposedofmultiplefunctionsimplementingthesameoperationfordifferenttypes. Whichim-\nplementationshouldbeusedduringacallisdeterminedbythedispatchalgorithm.\nSeealsothesingledispatchglossaryentry,thefunctools.singledispatch()decorator,andPEP443.\ngenerictype\nAtypethatcanbeparameterized; typicallyacontainerclasssuchaslistordict. Usedfortypehintsand\nannotations.\nFormoredetails,seegenericaliastypes,PEP483,PEP484,PEP585,andthetypingmodule.\nGIL\nSeeglobalinterpreterlock.\n73\nExtendingandEmbeddingPython,Release3.13.3\nglobalinterpreterlock\nThe mechanism used by the CPython interpreter to assure that only one thread executes Python bytecode at\na time. This simplifies the CPython implementation by making the object model (including critical built-in\ntypessuchasdict)implicitlysafeagainstconcurrentaccess. Lockingtheentireinterpretermakesiteasier\nfortheinterpretertobemulti-threaded,attheexpenseofmuchoftheparallelismaffordedbymulti-processor\nmachines.\nHowever,someextensionmodules,eitherstandardorthird-party,aredesignedsoastoreleasetheGILwhen\ndoingcomputationallyintensivetaskssuchascompressionorhashing. Also,theGILisalwaysreleasedwhen\ndoingI/O.\nAsofPython3.13, theGILcanbedisabledusingthe--disable-gilbuildconfiguration. Afterbuilding\nPythonwiththisoption,codemustberunwith-X gil=0oraftersettingthePYTHON_GIL=0environment\nvariable. This feature enables improved performance for multi-threaded applications and makes it easier to\nusemulti-coreCPUsefficiently. Formoredetails,seePEP703.\nhash-basedpyc\nAbytecodecachefilethatusesthehashratherthanthelast-modifiedtimeofthecorrespondingsourcefileto\ndetermineitsvalidity. Seepyc-invalidation.\nhashable\nAnobjectishashableifithasahashvaluewhichneverchangesduringitslifetime(itneedsa__hash__()\nmethod), and can be compared to other objects (it needs an __eq__() method). Hashable objects which\ncompareequalmusthavethesamehashvalue.\nHashabilitymakesanobjectusableasadictionarykeyandasetmember,becausethesedatastructuresusethe\nhashvalueinternally.\nMost of Python\u2019s immutable built-in objects are hashable; mutable containers (such as lists or dictionaries)\narenot;immutablecontainers(suchastuplesandfrozensets)areonlyhashableiftheirelementsarehashable.\nObjectswhichareinstancesofuser-definedclassesarehashablebydefault. Theyallcompareunequal(except\nwiththemselves),andtheirhashvalueisderivedfromtheirid().\nIDLE\nAnIntegratedDevelopmentandLearningEnvironmentforPython. idleisabasiceditorandinterpreterenvi-\nronmentwhichshipswiththestandarddistributionofPython.\nimmortal\nImmortalobjectsareaCPythonimplementationdetailintroducedinPEP683.\nIfanobjectisimmortal,itsreferencecount isnevermodified,andthereforeitisneverdeallocatedwhilethe\ninterpreterisrunning. Forexample,TrueandNoneareimmortalinCPython.\nimmutable\nAnobjectwithafixedvalue. Immutableobjectsincludenumbers,stringsandtuples. Suchanobjectcannot\nbealtered. Anewobjecthastobecreatedifadifferentvaluehastobestored. Theyplayanimportantrolein\nplaceswhereaconstanthashvalueisneeded,forexampleasakeyinadictionary.\nimportpath\nAlistoflocations(orpathentries)thataresearchedbythepathbasedfinderformodulestoimport. During\nimport,thislistoflocationsusuallycomesfromsys.path,butforsubpackagesitmayalsocomefromthe\nparentpackage\u2019s__path__attribute.\nimporting\nTheprocessbywhichPythoncodeinonemoduleismadeavailabletoPythoncodeinanothermodule.\nimporter\nAnobjectthatbothfindsandloadsamodule;bothafinderandloaderobject.\ninteractive\nPythonhasaninteractiveinterpreterwhichmeansyoucanenterstatementsandexpressionsattheinterpreter\nprompt, immediately execute them and see their results. Just launch python with no arguments (possibly\nby selecting it fromyour computer\u2019s mainmenu). It isa very powerfulway to testout new ideas orinspect\nmodulesandpackages(rememberhelp(x)). Formoreoninteractivemode,seetut-interac.\n74 AppendixA. Glossary\nExtendingandEmbeddingPython,Release3.13.3\ninterpreted\nPythonisaninterpretedlanguage,asopposedtoacompiledone,thoughthedistinctioncanbeblurrybecause\nofthepresenceofthebytecodecompiler. Thismeansthatsourcefilescanberundirectlywithoutexplicitly\ncreating an executable which is then run. Interpreted languages typically have a shorter development/debug\ncyclethancompiledones,thoughtheirprogramsgenerallyalsorunmoreslowly. Seealsointeractive.\ninterpretershutdown\nWhenaskedtoshutdown,thePythoninterpreterentersaspecialphasewhereitgraduallyreleasesallallocated\nresources, suchasmodulesandvariouscriticalinternalstructures. Italsomakesseveralcallstothegarbage\ncollector. Thiscantriggertheexecutionofcodeinuser-defineddestructorsorweakrefcallbacks. Codeexe-\ncutedduringtheshutdownphasecanencountervariousexceptionsastheresourcesitreliesonmaynotfunction\nanymore(commonexamplesarelibrarymodulesorthewarningsmachinery).\nThemainreasonforinterpretershutdownisthatthe__main__moduleorthescriptbeingrunhasfinished\nexecuting.\niterable\nAnobjectcapableofreturningitsmembersoneatatime. Examplesofiterablesincludeallsequencetypes\n(such as list, str, and tuple) and some non-sequence types like dict, file objects, and objects of any\nclassesyoudefinewithan__iter__()methodorwitha__getitem__()methodthatimplementssequence\nsemantics.\nIterables can be used in a for loop and in many other places where a sequence is needed (zip(), map(),\n\u2026). Whenaniterableobjectispassedasanargumenttothebuilt-infunctioniter(),itreturnsaniterator\nfortheobject. Thisiteratorisgoodforonepassoverthesetofvalues. Whenusingiterables,itisusuallynot\nnecessarytocalliter()ordealwithiteratorobjectsyourself. Theforstatementdoesthatautomaticallyfor\nyou,creatingatemporaryunnamedvariabletoholdtheiteratorforthedurationoftheloop. Seealsoiterator,\nsequence,andgenerator.\niterator\nAn object representing a stream of data. Repeated calls to the iterator\u2019s __next__() method (or passing\nittothebuilt-infunctionnext())returnsuccessiveitemsinthestream. Whennomoredataareavailablea\nStopIterationexceptionisraisedinstead. Atthispoint,theiteratorobjectisexhaustedandanyfurthercalls\ntoits__next__()methodjustraiseStopIterationagain. Iteratorsarerequiredtohavean__iter__()\nmethodthatreturnstheiteratorobjectitselfsoeveryiteratorisalsoiterableandmaybeusedinmostplaces\nwhereotheriterablesareaccepted. Onenotableexceptioniscodewhichattemptsmultipleiterationpasses. A\ncontainerobject(suchasalist)producesafreshnewiteratoreachtimeyoupassittotheiter()function\noruseitinaforloop. Attemptingthiswithaniteratorwilljustreturnthesameexhaustediteratorobjectused\ninthepreviousiterationpass,makingitappearlikeanemptycontainer.\nMoreinformationcanbefoundintypeiter.\nCPythonimplementationdetail: CPythondoesnotconsistentlyapplytherequirementthataniteratordefine\n__iter__(). Andalsopleasenotethatthefree-threadingCPythondoesnotguaranteethethread-safetyof\niteratoroperations.\nkeyfunction\nAkeyfunctionorcollationfunctionisacallablethatreturnsavalueusedforsortingorordering. Forexample,\nlocale.strxfrm()isusedtoproduceasortkeythatisawareoflocalespecificsortconventions.\nA number of tools in Python accept key functions to control how elements are ordered or grouped. They\ninclude min(), max(), sorted(), list.sort(), heapq.merge(), heapq.nsmallest(), heapq.\nnlargest(),anditertools.groupby().\nThere are several ways to create a key function. For example. the str.lower() method can serve as a\nkey function for case insensitive sorts. Alternatively, a key function can be built from a lambda expression\nsuchaslambda r: (r[0], r[2]). Also,operator.attrgetter(),operator.itemgetter(),and\noperator.methodcaller()arethreekeyfunctionconstructors. SeetheSortingHOWTOforexamples\nofhowtocreateandusekeyfunctions.\nkeywordargument\nSeeargument.\n75\nExtendingandEmbeddingPython,Release3.13.3\nlambda\nAnanonymousinlinefunctionconsistingofasingleexpressionwhichisevaluatedwhenthefunctioniscalled.\nThesyntaxtocreatealambdafunctionislambda [parameters]: expression\nLBYL\nLookbeforeyouleap. Thiscodingstyleexplicitlytestsforpre-conditionsbeforemakingcallsorlookups. This\nstylecontrastswiththeEAFPapproachandischaracterizedbythepresenceofmanyifstatements.\nIn a multi-threaded environment, the LBYL approach can risk introducing a race condition between \u201cthe\nlooking\u201dand\u201ctheleaping\u201d. Forexample, thecode, if key in mapping: return mapping[key] can\nfailifanotherthreadremoveskeyfrommappingafterthetest,butbeforethelookup. Thisissuecanbesolved\nwithlocksorbyusingtheEAFPapproach.\nlexicalanalyzer\nFormalnameforthetokenizer;seetoken.\nlist\nAbuilt-inPythonsequence. Despiteitsnameitismoreakintoanarrayinotherlanguagesthantoalinkedlist\nsinceaccesstoelementsisO(1).\nlistcomprehension\nAcompactwaytoprocessallorpartoftheelementsinasequenceandreturnalistwiththeresults. result\n= ['{:#04x}'.format(x) for x in range(256) if x % 2 == 0]generatesalistofstringscon-\ntainingevenhexnumbers(0x..) intherangefrom0to255. Theifclauseisoptional. Ifomitted,allelements\ninrange(256)areprocessed.\nloader\nAn object that loads a module. It must define the exec_module() and create_module() methods to\nimplementtheLoaderinterface. Aloaderistypicallyreturnedbyafinder. Seealso:\n\u2022 finders-and-loaders\n\u2022 importlib.abc.Loader\n\u2022 PEP302\nlocaleencoding\nOn Unix, it is the encoding of the LC_CTYPE locale. It can be set with locale.setlocale(locale.\nLC_CTYPE, new_locale).\nOnWindows,itistheANSIcodepage(ex: \"cp1252\").\nOnAndroidandVxWorks,Pythonuses\"utf-8\"asthelocaleencoding.\nlocale.getencoding()canbeusedtogetthelocaleencoding.\nSeealsothefilesystemencodinganderrorhandler.\nmagicmethod\nAninformalsynonymforspecialmethod.\nmapping\nA container object that supports arbitrary key lookups and implements the methods specified in the\ncollections.abc.Mapping or collections.abc.MutableMapping abstract base classes. Exam-\nples include dict, collections.defaultdict, collections.OrderedDict and collections.\nCounter.\nmetapathfinder\nAfinderreturnedbyasearchofsys.meta_path. Metapathfindersarerelatedto,butdifferentfrompath\nentryfinders.\nSeeimportlib.abc.MetaPathFinderforthemethodsthatmetapathfindersimplement.\nmetaclass\nTheclassofaclass. Classdefinitionscreateaclassname, aclassdictionary, andalistofbaseclasses. The\nmetaclass is responsible for taking those three arguments and creating the class. Most object oriented pro-\ngramming languages provide a default implementation. What makes Python special is that it is possible to\ncreatecustommetaclasses. Mostusersneverneedthistool,butwhentheneedarises,metaclassescanprovide\n76 AppendixA. Glossary\nExtendingandEmbeddingPython,Release3.13.3\npowerful,elegantsolutions. Theyhavebeenusedforloggingattributeaccess,addingthread-safety,tracking\nobjectcreation,implementingsingletons,andmanyothertasks.\nMoreinformationcanbefoundinmetaclasses.\nmethod\nAfunctionwhichisdefinedinsideaclassbody. Ifcalledasanattributeofaninstanceofthatclass,themethod\nwillgettheinstanceobjectasitsfirstargument(whichisusuallycalledself). Seefunctionandnestedscope.\nmethodresolutionorder\nMethod Resolution Order is the order in which base classes are searched for a member during lookup. See\npython_2.3_mrofordetailsofthealgorithmusedbythePythoninterpretersincethe2.3release.\nmodule\nAnobjectthatservesasanorganizationalunitofPythoncode. Moduleshaveanamespacecontainingarbitrary\nPythonobjects. ModulesareloadedintoPythonbytheprocessofimporting.\nSeealsopackage.\nmodulespec\nAnamespacecontainingtheimport-relatedinformationusedtoloadamodule. Aninstanceofimportlib.\nmachinery.ModuleSpec.\nSeealsomodule-specs.\nMRO\nSeemethodresolutionorder.\nmutable\nMutableobjectscanchangetheirvaluebutkeeptheirid(). Seealsoimmutable.\nnamedtuple\nTheterm\u201cnamedtuple\u201dappliestoanytypeorclassthatinheritsfromtupleandwhoseindexableelementsare\nalsoaccessibleusingnamedattributes. Thetypeorclassmayhaveotherfeaturesaswell.\nSeveral built-in types are named tuples, including the values returned by time.localtime() and os.\nstat(). Anotherexampleissys.float_info:\n>>> sys.float_info[1] # indexed access\n1024\n>>> sys.float_info.max_exp # named field access\n1024\n>>> isinstance(sys.float_info, tuple) # kind of tuple\nTrue\nSome named tuples are built-in types (such as the above examples). Alternatively, a named tuple can be\ncreated from a regular class definition that inherits from tuple and that defines named fields. Such a class\ncanbewrittenbyhand,oritcanbecreatedbyinheritingtyping.NamedTuple,orwiththefactoryfunction\ncollections.namedtuple(). Thelattertechniquesalsoaddsomeextramethodsthatmaynotbefound\ninhand-writtenorbuilt-innamedtuples.\nnamespace\nThe place where a variable is stored. Namespaces are implemented as dictionaries. There are the local,\nglobal and built-in namespaces as well as nested namespaces in objects (in methods). Namespaces support\nmodularitybypreventingnamingconflicts. Forinstance,thefunctionsbuiltins.openandos.open()are\ndistinguished by their namespaces. Namespaces also aid readability and maintainability by making it clear\nwhich module implements a function. For instance, writing random.seed() or itertools.islice()\nmakesitclearthatthosefunctionsareimplementedbytherandomanditertoolsmodules,respectively.\nnamespacepackage\nA package which serves only as a container for subpackages. Namespace packages may have no physical\nrepresentation,andspecificallyarenotlikearegularpackagebecausetheyhaveno__init__.pyfile.\nNamespacepackagesallowseveralindividuallyinstallablepackagestohaveacommonparentpackage. Oth-\nerwise,itisrecommendedtousearegularpackage.\n77\nExtendingandEmbeddingPython,Release3.13.3\nFormoreinformation,seePEP420andreference-namespace-package.\nSeealsomodule.\nnestedscope\nThe ability to refer to a variable in an enclosing definition. For instance, a function defined inside another\nfunctioncanrefertovariablesintheouterfunction. Notethatnestedscopesbydefaultworkonlyforreference\nandnotforassignment. Localvariablesbothreadandwriteintheinnermostscope. Likewise,globalvariables\nreadandwritetotheglobalnamespace. Thenonlocalallowswritingtoouterscopes.\nnew-styleclass\nOld name for the flavor of classes now used for all class objects. In earlier Python versions, only\nnew-style classes could use Python\u2019s newer, versatile features like __slots__, descriptors, properties,\n__getattribute__(),classmethods,andstaticmethods.\nobject\nAnydatawithstate(attributesorvalue)anddefinedbehavior(methods). Alsotheultimatebaseclassofany\nnew-styleclass.\noptimizedscope\nA scope where target local variable names are reliably known to the compiler when the code is compiled,\nallowingoptimizationofreadandwriteaccesstothesenames. Thelocalnamespacesforfunctions,generators,\ncoroutines,comprehensions,andgeneratorexpressionsareoptimizedinthisfashion. Note: mostinterpreter\noptimizationsareappliedtoallscopes,onlythoserelyingonaknownsetoflocalandnonlocalvariablenames\narerestrictedtooptimizedscopes.\npackage\nA Python module which can contain submodules or recursively, subpackages. Technically, a package is a\nPythonmodulewitha__path__attribute.\nSeealsoregularpackageandnamespacepackage.\nparameter\nAnamedentityinafunction(ormethod)definitionthatspecifiesanargument (orinsomecases,arguments)\nthatthefunctioncanaccept. Therearefivekindsofparameter:\n\u2022 positional-or-keyword: specifiesanargumentthatcanbepassedeitherpositionallyorasakeywordargu-\nment. Thisisthedefaultkindofparameter,forexamplefooandbarinthefollowing:\ndef func(foo, bar=None): ...\n\u2022 positional-only: specifiesanargumentthatcanbesuppliedonlybyposition. Positional-onlyparameters\ncanbedefinedbyincludinga/characterintheparameterlistofthefunctiondefinitionafterthem,for\nexampleposonly1andposonly2inthefollowing:\ndef func(posonly1, posonly2, /, positional_or_keyword): ...\n\u2022 keyword-only: specifiesanargumentthatcanbesuppliedonlybykeyword. Keyword-onlyparameters\ncanbedefinedbyincludingasinglevar-positionalparameterorbare*intheparameterlistofthefunction\ndefinitionbeforethem,forexamplekw_only1andkw_only2inthefollowing:\ndef func(arg, *, kw_only1, kw_only2): ...\n\u2022 var-positional: specifiesthatanarbitrarysequenceofpositionalargumentscanbeprovided(inaddition\ntoanypositionalargumentsalreadyacceptedbyotherparameters). Suchaparametercanbedefinedby\nprependingtheparameternamewith*,forexampleargsinthefollowing:\ndef func(*args, **kwargs): ...\n\u2022 var-keyword: specifiesthatarbitrarilymanykeywordargumentscanbeprovided(inadditiontoanykey-\nwordargumentsalreadyacceptedbyotherparameters). Suchaparametercanbedefinedbyprepending\ntheparameternamewith**,forexamplekwargsintheexampleabove.\n78 AppendixA. Glossary\nExtendingandEmbeddingPython,Release3.13.3\nParameters can specify both optional and required arguments, as well as default values for some optional\narguments.\nSeealsotheargumentglossaryentry,theFAQquestiononthedifferencebetweenargumentsandparameters,\ntheinspect.Parameterclass,thefunctionsection,andPEP362.\npathentry\nAsinglelocationontheimportpathwhichthepathbasedfinderconsultstofindmodulesforimporting.\npathentryfinder\nA finder returned by a callable on sys.path_hooks (i.e. a path entry hook) which knows how to locate\nmodulesgivenapathentry.\nSeeimportlib.abc.PathEntryFinderforthemethodsthatpathentryfindersimplement.\npathentryhook\nAcallableonthesys.path_hookslistwhichreturnsapathentryfinderifitknowshowtofindmoduleson\naspecificpathentry.\npathbasedfinder\nOneofthedefaultmetapathfinderswhichsearchesanimportpathformodules.\npath-likeobject\nAn object representing a file system path. A path-like object is either a str or bytes object representing\na path, or an object implementing the os.PathLike protocol. An object that supports the os.PathLike\nprotocol can be converted to a str or bytes file system path by calling the os.fspath() function; os.\nfsdecode() and os.fsencode() can be used to guarantee a str or bytes result instead, respectively.\nIntroducedbyPEP519.\nPEP\nPythonEnhancementProposal. APEPisadesigndocumentprovidinginformationtothePythoncommunity,\nordescribinganewfeatureforPythonoritsprocessesorenvironment. PEPsshouldprovideaconcisetechnical\nspecificationandarationaleforproposedfeatures.\nPEPsareintendedtobetheprimarymechanismsforproposingmajornewfeatures,forcollectingcommunity\ninputonanissue, andfordocumentingthedesigndecisionsthathavegoneintoPython. ThePEPauthoris\nresponsibleforbuildingconsensuswithinthecommunityanddocumentingdissentingopinions.\nSeePEP1.\nportion\nA set of files in a single directory (possibly stored in a zip file) that contribute to a namespace package, as\ndefinedinPEP420.\npositionalargument\nSeeargument.\nprovisionalAPI\nA provisional API is one which has been deliberately excluded from the standard library\u2019s backwards com-\npatibility guarantees. While major changes to such interfaces are not expected, as long as they are marked\nprovisional, backwards incompatible changes (up to and including removal of the interface) may occur if\ndeemednecessarybycoredevelopers. Suchchangeswillnotbemadegratuitously\u2013theywilloccuronlyif\nseriousfundamentalflawsareuncoveredthatweremissedpriortotheinclusionoftheAPI.\nEven for provisional APIs, backwards incompatible changes are seen as a \u201csolution of last resort\u201d - every\nattemptwillstillbemadetofindabackwardscompatibleresolutiontoanyidentifiedproblems.\nThisprocessallowsthestandardlibrarytocontinuetoevolveovertime,withoutlockinginproblematicdesign\nerrorsforextendedperiodsoftime. SeePEP411formoredetails.\nprovisionalpackage\nSeeprovisionalAPI.\nPython3000\nNicknameforthePython3.xreleaseline(coinedlongagowhenthereleaseofversion3wassomethinginthe\ndistantfuture.) Thisisalsoabbreviated\u201cPy3k\u201d.\n79\nExtendingandEmbeddingPython,Release3.13.3\nPythonic\nAnideaorpieceofcodewhichcloselyfollowsthemostcommonidiomsofthePythonlanguage,ratherthan\nimplementingcodeusingconceptscommontootherlanguages. Forexample,acommonidiominPythonis\ntoloopoverallelementsofaniterableusingaforstatement. Manyotherlanguagesdon\u2019thavethistypeof\nconstruct,sopeopleunfamiliarwithPythonsometimesuseanumericalcounterinstead:\nfor i in range(len(food)):\nprint(food[i])\nAsopposedtothecleaner,Pythonicmethod:\nfor piece in food:\nprint(piece)\nqualifiedname\nAdottednameshowingthe\u201cpath\u201dfromamodule\u2019sglobalscopetoaclass,functionormethoddefinedinthat\nmodule, as defined in PEP 3155. For top-level functions and classes, the qualified name is the same as the\nobject\u2019sname:\n>>> class C:\n... class D:\n... def meth(self):\n... pass\n...\n>>> C.__qualname__\n'C'\n>>> C.D.__qualname__\n'C.D'\n>>> C.D.meth.__qualname__\n'C.D.meth'\nWhenusedtorefertomodules,thefullyqualifiednamemeanstheentiredottedpathtothemodule,including\nanyparentpackages,e.g. email.mime.text:\n>>> import email.mime.text\n>>> email.mime.text.__name__\n'email.mime.text'\nreferencecount\nThenumberofreferencestoanobject. Whenthereferencecountofanobjectdropstozero,itisdeallocated.\nSome objects are immortal and have reference counts that are never modified, and therefore the objects are\nneverdeallocated. ReferencecountingisgenerallynotvisibletoPythoncode, butitisakeyelementofthe\nCPythonimplementation. Programmerscancallthesys.getrefcount()functiontoreturnthereference\ncountforaparticularobject.\nregularpackage\nAtraditionalpackage,suchasadirectorycontainingan__init__.pyfile.\nSeealsonamespacepackage.\nREPL\nAnacronymforthe\u201cread\u2013eval\u2013printloop\u201d,anothernamefortheinteractiveinterpretershell.\n__slots__\nAdeclarationinsideaclassthatsavesmemorybypre-declaringspaceforinstanceattributesandeliminating\ninstancedictionaries. Thoughpopular,thetechniqueissomewhattrickytogetrightandisbestreservedfor\nrarecaseswheretherearelargenumbersofinstancesinamemory-criticalapplication.\nsequence\nAn iterable which supports efficient element access using integer indices via the __getitem__() special\nmethod and defines a __len__() method that returns the length of the sequence. Some built-in sequence\n80 AppendixA. Glossary\nExtendingandEmbeddingPython,Release3.13.3\ntypesarelist,str,tuple,andbytes. Notethatdictalsosupports__getitem__()and__len__(),\nbut is considered a mapping rather than a sequence because the lookups use arbitrary hashable keys rather\nthanintegers.\nThecollections.abc.Sequenceabstractbaseclassdefinesamuchricherinterfacethatgoesbeyondjust\n__getitem__()and__len__(),addingcount(),index(),__contains__(),and__reversed__().\nTypes that implement this expanded interface can be registered explicitly using register(). For more\ndocumentationonsequencemethodsgenerally,seeCommonSequenceOperations.\nsetcomprehension\nAcompactwaytoprocessallorpartoftheelementsinaniterableandreturnasetwiththeresults. results\n= {c for c in 'abracadabra' if c not in 'abc'}generatesthesetofstrings{'r', 'd'}. See\ncomprehensions.\nsingledispatch\nAformofgenericfunctiondispatchwheretheimplementationischosenbasedonthetypeofasingleargument.\nslice\nAnobjectusuallycontainingaportionofasequence. Asliceiscreatedusingthesubscriptnotation,[]with\ncolons between numbers when several are given, such as in variable_name[1:3:5]. The bracket (sub-\nscript)notationusessliceobjectsinternally.\nsoftdeprecated\nAsoftdeprecatedAPIshouldnotbeusedinnewcode,butitissafeforalreadyexistingcodetouseit. The\nAPIremainsdocumentedandtested,butwillnotbeenhancedfurther.\nSoftdeprecation,unlikenormaldeprecation,doesnotplanonremovingtheAPIandwillnotemitwarnings.\nSeePEP387: SoftDeprecation.\nspecialmethod\nAmethodthatiscalledimplicitlybyPythontoexecuteacertainoperationonatype,suchasaddition. Such\nmethodshavenamesstartingandendingwithdoubleunderscores. Specialmethodsaredocumentedinspe-\ncialnames.\nstatement\nAstatementispartofasuite(a\u201cblock\u201dofcode). Astatementiseitheranexpressionoroneofseveralconstructs\nwithakeyword,suchasif,whileorfor.\nstatictypechecker\nAnexternaltoolthatreadsPythoncodeandanalyzesit, lookingforissuessuchasincorrecttypes. Seealso\ntypehintsandthetypingmodule.\nstrongreference\nIn Python\u2019s C API, a strong reference is a reference to an object which is owned by the code holding the\nreference. ThestrongreferenceistakenbycallingPy_INCREF()whenthereferenceiscreatedandreleased\nwithPy_DECREF()whenthereferenceisdeleted.\nThePy_NewRef()functioncanbeusedtocreateastrongreferencetoanobject. Usually,thePy_DECREF()\nfunctionmustbecalledonthestrongreferencebeforeexitingthescopeofthestrongreference,toavoidleaking\nonereference.\nSeealsoborrowedreference.\ntextencoding\nAstringinPythonisasequenceofUnicodecodepoints(inrangeU+0000\u2013U+10FFFF).Tostoreortransfer\nastring,itneedstobeserializedasasequenceofbytes.\nSerializingastringintoasequenceofbytesisknownas\u201cencoding\u201d,andrecreatingthestringfromthesequence\nofbytesisknownas\u201cdecoding\u201d.\nThereareavarietyofdifferenttextserializationcodecs,whicharecollectivelyreferredtoas\u201ctextencodings\u201d.\ntextfile\nAfileobjectabletoreadandwritestrobjects. Often,atextfileactuallyaccessesabyte-orienteddatastream\nandhandlesthetextencodingautomatically. Examplesoftextfilesarefilesopenedintextmode('r'or'w'),\nsys.stdin,sys.stdout,andinstancesofio.StringIO.\n81\nExtendingandEmbeddingPython,Release3.13.3\nSeealsobinaryfileforafileobjectabletoreadandwritebytes-likeobjects.\ntoken\nA small unit of source code, generated by the lexical analyzer (also called the tokenizer). Names, numbers,\nstrings,operators,newlinesandsimilararerepresentedbytokens.\nThe tokenize module exposes Python\u2019s lexical analyzer. The token module contains information on the\nvarioustypesoftokens.\ntriple-quotedstring\nAstringwhichisboundbythreeinstancesofeitheraquotationmark(\u201d)oranapostrophe(\u2018). Whiletheydon\u2019t\nprovide any functionality not available with single-quoted strings, they are useful for a number of reasons.\nTheyallowyoutoincludeunescapedsingleanddoublequoteswithinastringandtheycanspanmultiplelines\nwithouttheuseofthecontinuationcharacter,makingthemespeciallyusefulwhenwritingdocstrings.\ntype\nThetypeofaPythonobjectdetermineswhatkindofobjectitis;everyobjecthasatype. Anobject\u2019stypeis\naccessibleasits__class__attributeorcanberetrievedwithtype(obj).\ntypealias\nAsynonymforatype,createdbyassigningthetypetoanidentifier.\nTypealiasesareusefulforsimplifyingtypehints. Forexample:\ndef remove_gray_shades(\ncolors: list[tuple[int, int, int]]) -> list[tuple[int, int, int]]:\npass\ncouldbemademorereadablelikethis:\nColor = tuple[int, int, int]\ndef remove_gray_shades(colors: list[Color]) -> list[Color]:\npass\nSeetypingandPEP484,whichdescribethisfunctionality.\ntypehint\nAnannotationthatspecifiestheexpectedtypeforavariable,aclassattribute,orafunctionparameterorreturn\nvalue.\nTypehintsareoptionalandarenotenforcedbyPythonbuttheyareusefultostatictypecheckers. Theycan\nalsoaidIDEswithcodecompletionandrefactoring.\nType hints of global variables, class attributes, and functions, but not local variables, can be accessed using\ntyping.get_type_hints().\nSeetypingandPEP484,whichdescribethisfunctionality.\nuniversalnewlines\nAmannerofinterpretingtextstreamsinwhichallofthefollowingarerecognizedasendingaline: theUnix\nend-of-lineconvention'\\n',theWindowsconvention'\\r\\n',andtheoldMacintoshconvention'\\r'. See\nPEP278andPEP3116,aswellasbytes.splitlines()foranadditionaluse.\nvariableannotation\nAnannotationofavariableoraclassattribute.\nWhenannotatingavariableoraclassattribute,assignmentisoptional:\nclass C:\nfield: 'annotation'\nVariableannotationsareusuallyusedfortypehints: forexamplethisvariableisexpectedtotakeintvalues:\n82 AppendixA. Glossary\nExtendingandEmbeddingPython,Release3.13.3\ncount: int = 0\nVariableannotationsyntaxisexplainedinsectionannassign.\nSeefunctionannotation,PEP484andPEP526,whichdescribethisfunctionality. Alsoseeannotations-howto\nforbestpracticesonworkingwithannotations.\nvirtualenvironment\nAcooperativelyisolatedruntimeenvironmentthatallowsPythonusersandapplicationstoinstallandupgrade\nPythondistributionpackageswithoutinterferingwiththebehaviourofotherPythonapplicationsrunningon\nthesamesystem.\nSeealsovenv.\nvirtualmachine\nAcomputerdefinedentirelyinsoftware. Python\u2019svirtualmachineexecutesthebytecodeemittedbythebyte-\ncodecompiler.\nZenofPython\nListingofPythondesignprinciplesandphilosophiesthatarehelpfulinunderstandingandusingthelanguage.\nThelistingcanbefoundbytyping\u201cimport this\u201dattheinteractiveprompt.\n83\nExtendingandEmbeddingPython,Release3.13.3\n84 AppendixA. Glossary\nAPPENDIX\nB\nABOUT THIS DOCUMENTATION\nPython\u2019sdocumentationisgeneratedfromreStructuredTextsourcesusingSphinx,adocumentationgeneratororigi-\nnallycreatedforPythonandnowmaintainedasanindependentproject.\nDevelopment of the documentation and its toolchain is an entirely volunteer effort, just like Python itself. If you\nwanttocontribute,pleasetakealookatthereporting-bugspageforinformationonhowtodoso. Newvolunteers\narealwayswelcome!\nManythanksgoto:\n\u2022 FredL.Drake,Jr.,thecreatoroftheoriginalPythondocumentationtoolsetandauthorofmuchofthecontent;\n\u2022 theDocutilsprojectforcreatingreStructuredTextandtheDocutilssuite;\n\u2022 FredrikLundhforhisAlternativePythonReferenceprojectfromwhichSphinxgotmanygoodideas.\nB.1 Contributors to the Python documentation\nManypeoplehavecontributedtothePythonlanguage,thePythonstandardlibrary,andthePythondocumentation.\nSeeMisc/ACKSinthePythonsourcedistributionforapartiallistofcontributors.\nItisonlywiththeinputandcontributionsofthePythoncommunitythatPythonhassuchwonderfuldocumentation\n\u2013ThankYou!\n85\nExtendingandEmbeddingPython,Release3.13.3\n86 AppendixB. Aboutthisdocumentation\nAPPENDIX\nC\nHISTORY AND LICENSE\nC.1 History of the software\nPythonwascreatedintheearly1990sbyGuidovanRossumatStichtingMathematischCentrum(CWI,seehttps:\n//www.cwi.nl)intheNetherlandsasasuccessorofalanguagecalledABC.GuidoremainsPython\u2019sprincipalauthor,\nalthoughitincludesmanycontributionsfromothers.\nIn1995,GuidocontinuedhisworkonPythonattheCorporationforNationalResearchInitiatives(CNRI,seehttps:\n//www.cnri.reston.va.us)inReston,Virginiawherehereleasedseveralversionsofthesoftware.\nInMay2000,GuidoandthePythoncoredevelopmentteammovedtoBeOpen.comtoformtheBeOpenPythonLabs\nteam. InOctoberofthesameyear,thePythonLabsteammovedtoDigitalCreations,whichbecameZopeCorpo-\nration. In2001,thePythonSoftwareFoundation(PSF,seehttps://www.python.org/psf/)wasformed,anon-profit\norganization created specifically to own Python-related Intellectual Property. Zope Corporation was a sponsoring\nmemberofthePSF.\nAllPythonreleasesareOpenSource(seehttps://opensource.orgfortheOpenSourceDefinition). Historically,most,\nbutnotall,PythonreleaseshavealsobeenGPL-compatible;thetablebelowsummarizesthevariousreleases.\nRelease Derivedfrom Year Owner GPL-compatible? (1)\n0.9.0thru1.2 n/a 1991-1995 CWI yes\n1.3thru1.5.2 1.2 1995-1999 CNRI yes\n1.6 1.5.2 2000 CNRI no\n2.0 1.6 2000 BeOpen.com no\n1.6.1 1.6 2001 CNRI yes(2)\n2.1 2.0+1.6.1 2001 PSF no\n2.0.1 2.0+1.6.1 2001 PSF yes\n2.1.1 2.1+2.0.1 2001 PSF yes\n2.1.2 2.1.1 2002 PSF yes\n2.1.3 2.1.2 2002 PSF yes\n2.2andabove 2.1.1 2001-now PSF yes\n(cid:174) Note\n(1) GPL-compatibledoesn\u2019tmeanthatwe\u2019redistributingPythonundertheGPL.AllPythonlicenses,unlike\nthe GPL, let you distribute a modified version without making your changes open source. The GPL-\ncompatible licenses make it possible to combine Python with other software that is released under the\nGPL;theothersdon\u2019t.\n(2) AccordingtoRichardStallman,1.6.1isnotGPL-compatible,becauseitslicensehasachoiceoflawclause.\nAccordingtoCNRI,however, Stallman\u2019slawyerhastoldCNRI\u2019slawyerthat1.6.1is\u201cnotincompatible\u201d\nwiththeGPL.\nThankstothemanyoutsidevolunteerswhohaveworkedunderGuido\u2019sdirectiontomakethesereleasespossible.\n87\nExtendingandEmbeddingPython,Release3.13.3\nC.2 Terms and conditions for accessing or otherwise using Python\nPythonsoftwareanddocumentationarelicensedunderthePythonSoftwareFoundationLicenseVersion2.\nStartingwithPython3.8.6,examples,recipes,andothercodeinthedocumentationareduallicensedunderthePSF\nLicenseVersion2andtheZero-ClauseBSDlicense.\nSomesoftwareincorporatedintoPythonisunderdifferentlicenses. Thelicensesarelistedwithcodefallingunder\nthatlicense. SeeLicensesandAcknowledgementsforIncorporatedSoftwareforanincompletelistoftheselicenses.\nC.2.1 PYTHON SOFTWARE FOUNDATION LICENSE VERSION 2\n1. This LICENSE AGREEMENT is between the Python Software Foundation (\"PSF\"), and\nthe Individual or Organization (\"Licensee\") accessing and otherwise using this\nsoftware (\"Python\") in source or binary form and its associated documentation.\n2. Subject to the terms and conditions of this License Agreement, PSF hereby\ngrants Licensee a nonexclusive, royalty-free, world-wide license to reproduce,\nanalyze, test, perform and/or display publicly, prepare derivative works,\ndistribute, and otherwise use Python alone or in any derivative\nversion, provided, however, that PSF's License Agreement and PSF's notice of\ncopyright, i.e., \"Copyright \u00a9 2001-2024 Python Software Foundation; All Rights\nReserved\" are retained in Python alone or in any derivative version\nprepared by Licensee.\n3. In the event Licensee prepares a derivative work that is based on or\nincorporates Python or any part thereof, and wants to make the\nderivative work available to others as provided herein, then Licensee hereby\nagrees to include in any such work a brief summary of the changes made to\u2423\n,\u2192Python.\n4. PSF is making Python available to Licensee on an \"AS IS\" basis.\nPSF MAKES NO REPRESENTATIONS OR WARRANTIES, EXPRESS OR IMPLIED. BY WAY OF\nEXAMPLE, BUT NOT LIMITATION, PSF MAKES NO AND DISCLAIMS ANY REPRESENTATION OR\nWARRANTY OF MERCHANTABILITY OR FITNESS FOR ANY PARTICULAR PURPOSE OR THAT THE\nUSE OF PYTHON WILL NOT INFRINGE ANY THIRD PARTY RIGHTS.\n5. PSF SHALL NOT BE LIABLE TO LICENSEE OR ANY OTHER USERS OF PYTHON\nFOR ANY INCIDENTAL, SPECIAL, OR CONSEQUENTIAL DAMAGES OR LOSS AS A RESULT OF\nMODIFYING, DISTRIBUTING, OR OTHERWISE USING PYTHON, OR ANY DERIVATIVE\nTHEREOF, EVEN IF ADVISED OF THE POSSIBILITY THEREOF.\n6. This License Agreement will automatically terminate upon a material breach of\nits terms and conditions.\n7. Nothing in this License Agreement shall be deemed to create any relationship\nof agency, partnership, or joint venture between PSF and Licensee. This License\nAgreement does not grant permission to use PSF trademarks or trade name in a\ntrademark sense to endorse or promote products or services of Licensee, or any\nthird party.\n8. By copying, installing or otherwise using Python, Licensee agrees\nto be bound by the terms and conditions of this License Agreement.\n88 AppendixC. HistoryandLicense\nExtendingandEmbeddingPython,Release3.13.3\nC.2.2 BEOPEN.COM LICENSE AGREEMENT FOR PYTHON 2.0\nBEOPENPYTHONOPENSOURCELICENSEAGREEMENTVERSION1\n1. This LICENSE AGREEMENT is between BeOpen.com (\"BeOpen\"), having an office at\n160 Saratoga Avenue, Santa Clara, CA 95051, and the Individual or Organization\n(\"Licensee\") accessing and otherwise using this software in source or binary\nform and its associated documentation (\"the Software\").\n2. Subject to the terms and conditions of this BeOpen Python License Agreement,\nBeOpen hereby grants Licensee a non-exclusive, royalty-free, world-wide license\nto reproduce, analyze, test, perform and/or display publicly, prepare derivative\nworks, distribute, and otherwise use the Software alone or in any derivative\nversion, provided, however, that the BeOpen Python License is retained in the\nSoftware, alone or in any derivative version prepared by Licensee.\n3. BeOpen is making the Software available to Licensee on an \"AS IS\" basis.\nBEOPEN MAKES NO REPRESENTATIONS OR WARRANTIES, EXPRESS OR IMPLIED. BY WAY OF\nEXAMPLE, BUT NOT LIMITATION, BEOPEN MAKES NO AND DISCLAIMS ANY REPRESENTATION OR\nWARRANTY OF MERCHANTABILITY OR FITNESS FOR ANY PARTICULAR PURPOSE OR THAT THE\nUSE OF THE SOFTWARE WILL NOT INFRINGE ANY THIRD PARTY RIGHTS.\n4. BEOPEN SHALL NOT BE LIABLE TO LICENSEE OR ANY OTHER USERS OF THE SOFTWARE FOR\nANY INCIDENTAL, SPECIAL, OR CONSEQUENTIAL DAMAGES OR LOSS AS A RESULT OF USING,\nMODIFYING OR DISTRIBUTING THE SOFTWARE, OR ANY DERIVATIVE THEREOF, EVEN IF\nADVISED OF THE POSSIBILITY THEREOF.\n5. This License Agreement will automatically terminate upon a material breach of\nits terms and conditions.\n6. This License Agreement shall be governed by and interpreted in all respects\nby the law of the State of California, excluding conflict of law provisions.\nNothing in this License Agreement shall be deemed to create any relationship of\nagency, partnership, or joint venture between BeOpen and Licensee. This License\nAgreement does not grant permission to use BeOpen trademarks or trade names in a\ntrademark sense to endorse or promote products or services of Licensee, or any\nthird party. As an exception, the \"BeOpen Python\" logos available at\nhttp://www.pythonlabs.com/logos.html may be used according to the permissions\ngranted on that web page.\n7. By copying, installing or otherwise using the software, Licensee agrees to be\nbound by the terms and conditions of this License Agreement.\nC.2.3 CNRI LICENSE AGREEMENT FOR PYTHON 1.6.1\n1. This LICENSE AGREEMENT is between the Corporation for National Research\nInitiatives, having an office at 1895 Preston White Drive, Reston, VA 20191\n(\"CNRI\"), and the Individual or Organization (\"Licensee\") accessing and\notherwise using Python 1.6.1 software in source or binary form and its\nassociated documentation.\n2. Subject to the terms and conditions of this License Agreement, CNRI hereby\ngrants Licensee a nonexclusive, royalty-free, world-wide license to reproduce,\nanalyze, test, perform and/or display publicly, prepare derivative works,\ndistribute, and otherwise use Python 1.6.1 alone or in any derivative version,\nprovided, however, that CNRI's License Agreement and CNRI's notice of copyright,\ni.e., \"Copyright \u00a9 1995-2001 Corporation for National Research Initiatives; All\n(continuesonnextpage)\nC.2. TermsandconditionsforaccessingorotherwiseusingPython 89\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nRights Reserved\" are retained in Python 1.6.1 alone or in any derivative version\nprepared by Licensee. Alternately, in lieu of CNRI's License Agreement,\nLicensee may substitute the following text (omitting the quotes): \"Python 1.6.1\nis made available subject to the terms and conditions in CNRI's License\nAgreement. This Agreement together with Python 1.6.1 may be located on the\ninternet using the following unique, persistent identifier (known as a handle):\n1895.22/1013. This Agreement may also be obtained from a proxy server on the\ninternet using the following URL: http://hdl.handle.net/1895.22/1013\".\n3. In the event Licensee prepares a derivative work that is based on or\nincorporates Python 1.6.1 or any part thereof, and wants to make the derivative\nwork available to others as provided herein, then Licensee hereby agrees to\ninclude in any such work a brief summary of the changes made to Python 1.6.1.\n4. CNRI is making Python 1.6.1 available to Licensee on an \"AS IS\" basis. CNRI\nMAKES NO REPRESENTATIONS OR WARRANTIES, EXPRESS OR IMPLIED. BY WAY OF EXAMPLE,\nBUT NOT LIMITATION, CNRI MAKES NO AND DISCLAIMS ANY REPRESENTATION OR WARRANTY\nOF MERCHANTABILITY OR FITNESS FOR ANY PARTICULAR PURPOSE OR THAT THE USE OF\nPYTHON 1.6.1 WILL NOT INFRINGE ANY THIRD PARTY RIGHTS.\n5. CNRI SHALL NOT BE LIABLE TO LICENSEE OR ANY OTHER USERS OF PYTHON 1.6.1 FOR\nANY INCIDENTAL, SPECIAL, OR CONSEQUENTIAL DAMAGES OR LOSS AS A RESULT OF\nMODIFYING, DISTRIBUTING, OR OTHERWISE USING PYTHON 1.6.1, OR ANY DERIVATIVE\nTHEREOF, EVEN IF ADVISED OF THE POSSIBILITY THEREOF.\n6. This License Agreement will automatically terminate upon a material breach of\nits terms and conditions.\n7. This License Agreement shall be governed by the federal intellectual property\nlaw of the United States, including without limitation the federal copyright\nlaw, and, to the extent such U.S. federal law does not apply, by the law of the\nCommonwealth of Virginia, excluding Virginia's conflict of law provisions.\nNotwithstanding the foregoing, with regard to derivative works based on Python\n1.6.1 that incorporate non-separable material that was previously distributed\nunder the GNU General Public License (GPL), the law of the Commonwealth of\nVirginia shall govern this License Agreement only as to issues arising under or\nwith respect to Paragraphs 4, 5, and 7 of this License Agreement. Nothing in\nthis License Agreement shall be deemed to create any relationship of agency,\npartnership, or joint venture between CNRI and Licensee. This License Agreement\ndoes not grant permission to use CNRI trademarks or trade name in a trademark\nsense to endorse or promote products or services of Licensee, or any third\nparty.\n8. By clicking on the \"ACCEPT\" button where indicated, or by copying, installing\nor otherwise using Python 1.6.1, Licensee agrees to be bound by the terms and\nconditions of this License Agreement.\nC.2.4 CWI LICENSE AGREEMENT FOR PYTHON 0.9.0 THROUGH 1.2\nCopyright \u00a9 1991 - 1995, Stichting Mathematisch Centrum Amsterdam, The\nNetherlands. All rights reserved.\nPermission to use, copy, modify, and distribute this software and its\ndocumentation for any purpose and without fee is hereby granted, provided that\nthe above copyright notice appear in all copies and that both that copyright\n(continuesonnextpage)\n90 AppendixC. HistoryandLicense\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nnotice and this permission notice appear in supporting documentation, and that\nthe name of Stichting Mathematisch Centrum or CWI not be used in advertising or\npublicity pertaining to distribution of the software without specific, written\nprior permission.\nSTICHTING MATHEMATISCH CENTRUM DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS\nSOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO\nEVENT SHALL STICHTING MATHEMATISCH CENTRUM BE LIABLE FOR ANY SPECIAL, INDIRECT\nOR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE,\nDATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS\nACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS\nSOFTWARE.\nC.2.5 ZERO-CLAUSE BSD LICENSE FOR CODE IN THE PYTHON DOCUMENTA-\nTION\nPermission to use, copy, modify, and/or distribute this software for any\npurpose with or without fee is hereby granted.\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\nPERFORMANCE OF THIS SOFTWARE.\nC.3 Licenses and Acknowledgements for Incorporated Software\nThissectionisanincomplete,butgrowinglistoflicensesandacknowledgementsforthird-partysoftwareincorporated\ninthePythondistribution.\nC.3.1 Mersenne Twister\nThe_randomCextensionunderlyingtherandommoduleincludescodebasedonadownloadfromhttp://www.math.\nsci.hiroshima-u.ac.jp/~m-mat/MT/MT2002/emt19937ar.html. Thefollowingaretheverbatimcommentsfromthe\noriginalcode:\nA C-program for MT19937, with initialization improved 2002/1/26.\nCoded by Takuji Nishimura and Makoto Matsumoto.\nBefore using, initialize the state by using init_genrand(seed)\nor init_by_array(init_key, key_length).\nCopyright (C) 1997 - 2002, Makoto Matsumoto and Takuji Nishimura,\nAll rights reserved.\nRedistribution and use in source and binary forms, with or without\nmodification, are permitted provided that the following conditions\nare met:\n1. Redistributions of source code must retain the above copyright\nnotice, this list of conditions and the following disclaimer.\n(continuesonnextpage)\nC.3. LicensesandAcknowledgementsforIncorporatedSoftware 91\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\n2. Redistributions in binary form must reproduce the above copyright\nnotice, this list of conditions and the following disclaimer in the\ndocumentation and/or other materials provided with the distribution.\n3. The names of its contributors may not be used to endorse or promote\nproducts derived from this software without specific prior written\npermission.\nTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n\"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\nLIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\nA PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR\nCONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,\nEXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,\nPROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\nPROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF\nLIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING\nNEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\nSOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\nAny feedback is very welcome.\nhttp://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/emt.html\nemail: m-mat @ math.sci.hiroshima-u.ac.jp (remove space)\nC.3.2 Sockets\nThesocketmoduleusesthefunctions,getaddrinfo(),andgetnameinfo(),whicharecodedinseparatesource\nfilesfromtheWIDEProject,https://www.wide.ad.jp/.\nCopyright (C) 1995, 1996, 1997, and 1998 WIDE Project.\nAll rights reserved.\nRedistribution and use in source and binary forms, with or without\nmodification, are permitted provided that the following conditions\nare met:\n1. Redistributions of source code must retain the above copyright\nnotice, this list of conditions and the following disclaimer.\n2. Redistributions in binary form must reproduce the above copyright\nnotice, this list of conditions and the following disclaimer in the\ndocumentation and/or other materials provided with the distribution.\n3. Neither the name of the project nor the names of its contributors\nmay be used to endorse or promote products derived from this software\nwithout specific prior written permission.\nTHIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS \"AS IS\" AND\nANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\nIMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\nARE DISCLAIMED. IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE\nFOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL\nDAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS\nOR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)\nHOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT\nLIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY\nOUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF\nSUCH DAMAGE.\n92 AppendixC. HistoryandLicense\nExtendingandEmbeddingPython,Release3.13.3\nC.3.3 Asynchronous socket services\nThetest.support.asynchatandtest.support.asyncoremodulescontainthefollowingnotice:\nCopyright 1996 by Sam Rushing\nAll Rights Reserved\nPermission to use, copy, modify, and distribute this software and\nits documentation for any purpose and without fee is hereby\ngranted, provided that the above copyright notice appear in all\ncopies and that both that copyright notice and this permission\nnotice appear in supporting documentation, and that the name of Sam\nRushing not be used in advertising or publicity pertaining to\ndistribution of the software without specific, written prior\npermission.\nSAM RUSHING DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,\nINCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN\nNO EVENT SHALL SAM RUSHING BE LIABLE FOR ANY SPECIAL, INDIRECT OR\nCONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS\nOF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT,\nNEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN\nCONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\nC.3.4 Cookie management\nThehttp.cookiesmodulecontainsthefollowingnotice:\nCopyright 2000 by Timothy O'Malley <timo@alum.mit.edu>\nAll Rights Reserved\nPermission to use, copy, modify, and distribute this software\nand its documentation for any purpose and without fee is hereby\ngranted, provided that the above copyright notice appear in all\ncopies and that both that copyright notice and this permission\nnotice appear in supporting documentation, and that the name of\nTimothy O'Malley not be used in advertising or publicity\npertaining to distribution of the software without specific, written\nprior permission.\nTimothy O'Malley DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS\nSOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\nAND FITNESS, IN NO EVENT SHALL Timothy O'Malley BE LIABLE FOR\nANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES\nWHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,\nWHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS\nACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\nPERFORMANCE OF THIS SOFTWARE.\nC.3.5 Execution tracing\nThetracemodulecontainsthefollowingnotice:\nportions copyright 2001, Autonomous Zones Industries, Inc., all rights...\nerr... reserved and offered to the public under the terms of the\nPython 2.2 license.\n(continuesonnextpage)\nC.3. LicensesandAcknowledgementsforIncorporatedSoftware 93\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nAuthor: Zooko O'Whielacronx\nhttp://zooko.com/\nmailto:zooko@zooko.com\nCopyright 2000, Mojam Media, Inc., all rights reserved.\nAuthor: Skip Montanaro\nCopyright 1999, Bioreason, Inc., all rights reserved.\nAuthor: Andrew Dalke\nCopyright 1995-1997, Automatrix, Inc., all rights reserved.\nAuthor: Skip Montanaro\nCopyright 1991-1995, Stichting Mathematisch Centrum, all rights reserved.\nPermission to use, copy, modify, and distribute this Python software and\nits associated documentation for any purpose without fee is hereby\ngranted, provided that the above copyright notice appears in all copies,\nand that both that copyright notice and this permission notice appear in\nsupporting documentation, and that the name of neither Automatrix,\nBioreason or Mojam Media be used in advertising or publicity pertaining to\ndistribution of the software without specific, written prior permission.\nC.3.6 UUencode and UUdecode functions\nTheuucodeccontainsthefollowingnotice:\nCopyright 1994 by Lance Ellinghouse\nCathedral City, California Republic, United States of America.\nAll Rights Reserved\nPermission to use, copy, modify, and distribute this software and its\ndocumentation for any purpose and without fee is hereby granted,\nprovided that the above copyright notice appear in all copies and that\nboth that copyright notice and this permission notice appear in\nsupporting documentation, and that the name of Lance Ellinghouse\nnot be used in advertising or publicity pertaining to distribution\nof the software without specific, written prior permission.\nLANCE ELLINGHOUSE DISCLAIMS ALL WARRANTIES WITH REGARD TO\nTHIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND\nFITNESS, IN NO EVENT SHALL LANCE ELLINGHOUSE CENTRUM BE LIABLE\nFOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES\nWHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN\nACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT\nOF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\nModified by Jack Jansen, CWI, July 1995:\n- Use binascii module to do the actual line-by-line conversion\nbetween ascii and binary. This results in a 1000-fold speedup. The C\nversion is still 5 times faster, though.\n- Arguments more compliant with Python standard\n94 AppendixC. HistoryandLicense\nExtendingandEmbeddingPython,Release3.13.3\nC.3.7 XML Remote Procedure Calls\nThexmlrpc.clientmodulecontainsthefollowingnotice:\nThe XML-RPC client interface is\nCopyright (c) 1999-2002 by Secret Labs AB\nCopyright (c) 1999-2002 by Fredrik Lundh\nBy obtaining, using, and/or copying this software and/or its\nassociated documentation, you agree that you have read, understood,\nand will comply with the following terms and conditions:\nPermission to use, copy, modify, and distribute this software and\nits associated documentation for any purpose and without fee is\nhereby granted, provided that the above copyright notice appears in\nall copies, and that both that copyright notice and this permission\nnotice appear in supporting documentation, and that the name of\nSecret Labs AB or the author not be used in advertising or publicity\npertaining to distribution of the software without specific, written\nprior permission.\nSECRET LABS AB AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD\nTO THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANT-\nABILITY AND FITNESS. IN NO EVENT SHALL SECRET LABS AB OR THE AUTHOR\nBE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY\nDAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,\nWHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS\nACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE\nOF THIS SOFTWARE.\nC.3.8 test_epoll\nThetest.test_epollmodulecontainsthefollowingnotice:\nCopyright (c) 2001-2006 Twisted Matrix Laboratories.\nPermission is hereby granted, free of charge, to any person obtaining\na copy of this software and associated documentation files (the\n\"Software\"), to deal in the Software without restriction, including\nwithout limitation the rights to use, copy, modify, merge, publish,\ndistribute, sublicense, and/or sell copies of the Software, and to\npermit persons to whom the Software is furnished to do so, subject to\nthe following conditions:\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\nMERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\nLIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\nOF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\nWITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\nC.3. LicensesandAcknowledgementsforIncorporatedSoftware 95\nExtendingandEmbeddingPython,Release3.13.3\nC.3.9 Select kqueue\nTheselectmodulecontainsthefollowingnoticeforthekqueueinterface:\nCopyright (c) 2000 Doug White, 2006 James Knight, 2007 Christian Heimes\nAll rights reserved.\nRedistribution and use in source and binary forms, with or without\nmodification, are permitted provided that the following conditions\nare met:\n1. Redistributions of source code must retain the above copyright\nnotice, this list of conditions and the following disclaimer.\n2. Redistributions in binary form must reproduce the above copyright\nnotice, this list of conditions and the following disclaimer in the\ndocumentation and/or other materials provided with the distribution.\nTHIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS \"AS IS\" AND\nANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\nIMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\nARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE\nFOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL\nDAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS\nOR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)\nHOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT\nLIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY\nOUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF\nSUCH DAMAGE.\nC.3.10 SipHash24\nThefilePython/pyhash.ccontainsMarekMajkowski\u2019implementationofDanBernstein\u2019sSipHash24algorithm.\nItcontainsthefollowingnote:\n<MIT License>\nCopyright (c) 2013 Marek Majkowski <marek@popcount.org>\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\nThe above copyright notice and this permission notice shall be included in\nall copies or substantial portions of the Software.\n</MIT License>\nOriginal location:\nhttps://github.com/majek/csiphash/\nSolution inspired by code from:\nSamuel Neves (supercop/crypto_auth/siphash24/little)\ndjb (supercop/crypto_auth/siphash24/little2)\nJean-Philippe Aumasson (https://131002.net/siphash/siphash24.c)\n96 AppendixC. HistoryandLicense\nExtendingandEmbeddingPython,Release3.13.3\nC.3.11 strtod and dtoa\nThefilePython/dtoa.c,whichsuppliesCfunctionsdtoaandstrtodforconversionofCdoublestoandfromstrings,\nisderivedfromthefileofthesamenamebyDavidM.Gay, currentlyavailablefromhttps://web.archive.org/web/\n20220517033456/http://www.netlib.org/fp/dtoa.c. The original file, as retrieved on March 16, 2009, contains the\nfollowingcopyrightandlicensingnotice:\n/****************************************************************\n*\n* The author of this software is David M. Gay.\n*\n* Copyright (c) 1991, 2000, 2001 by Lucent Technologies.\n*\n* Permission to use, copy, modify, and distribute this software for any\n* purpose without fee is hereby granted, provided that this entire notice\n* is included in all copies of any software which is or includes a copy\n* or modification of this software and in all copies of the supporting\n* documentation for such software.\n*\n* THIS SOFTWARE IS BEING PROVIDED \"AS IS\", WITHOUT ANY EXPRESS OR IMPLIED\n* WARRANTY. IN PARTICULAR, NEITHER THE AUTHOR NOR LUCENT MAKES ANY\n* REPRESENTATION OR WARRANTY OF ANY KIND CONCERNING THE MERCHANTABILITY\n* OF THIS SOFTWARE OR ITS FITNESS FOR ANY PARTICULAR PURPOSE.\n*\n***************************************************************/\nC.3.12 OpenSSL\nThemoduleshashlib,posixandsslusetheOpenSSLlibraryforaddedperformanceifmadeavailablebythe\noperatingsystem. Additionally,theWindowsandmacOSinstallersforPythonmayincludeacopyoftheOpenSSL\nlibraries,soweincludeacopyoftheOpenSSLlicensehere. FortheOpenSSL3.0release,andlaterreleasesderived\nfromthat,theApacheLicensev2applies:\nApache License\nVersion 2.0, January 2004\nhttps://www.apache.org/licenses/\nTERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION\n1. Definitions.\n\"License\" shall mean the terms and conditions for use, reproduction,\nand distribution as defined by Sections 1 through 9 of this document.\n\"Licensor\" shall mean the copyright owner or entity authorized by\nthe copyright owner that is granting the License.\n\"Legal Entity\" shall mean the union of the acting entity and all\nother entities that control, are controlled by, or are under common\ncontrol with that entity. For the purposes of this definition,\n\"control\" means (i) the power, direct or indirect, to cause the\ndirection or management of such entity, whether by contract or\notherwise, or (ii) ownership of fifty percent (50%) or more of the\noutstanding shares, or (iii) beneficial ownership of such entity.\n\"You\" (or \"Your\") shall mean an individual or Legal Entity\nexercising permissions granted by this License.\n(continuesonnextpage)\nC.3. LicensesandAcknowledgementsforIncorporatedSoftware 97\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\n\"Source\" form shall mean the preferred form for making modifications,\nincluding but not limited to software source code, documentation\nsource, and configuration files.\n\"Object\" form shall mean any form resulting from mechanical\ntransformation or translation of a Source form, including but\nnot limited to compiled object code, generated documentation,\nand conversions to other media types.\n\"Work\" shall mean the work of authorship, whether in Source or\nObject form, made available under the License, as indicated by a\ncopyright notice that is included in or attached to the work\n(an example is provided in the Appendix below).\n\"Derivative Works\" shall mean any work, whether in Source or Object\nform, that is based on (or derived from) the Work and for which the\neditorial revisions, annotations, elaborations, or other modifications\nrepresent, as a whole, an original work of authorship. For the purposes\nof this License, Derivative Works shall not include works that remain\nseparable from, or merely link (or bind by name) to the interfaces of,\nthe Work and Derivative Works thereof.\n\"Contribution\" shall mean any work of authorship, including\nthe original version of the Work and any modifications or additions\nto that Work or Derivative Works thereof, that is intentionally\nsubmitted to Licensor for inclusion in the Work by the copyright owner\nor by an individual or Legal Entity authorized to submit on behalf of\nthe copyright owner. For the purposes of this definition, \"submitted\"\nmeans any form of electronic, verbal, or written communication sent\nto the Licensor or its representatives, including but not limited to\ncommunication on electronic mailing lists, source code control systems,\nand issue tracking systems that are managed by, or on behalf of, the\nLicensor for the purpose of discussing and improving the Work, but\nexcluding communication that is conspicuously marked or otherwise\ndesignated in writing by the copyright owner as \"Not a Contribution.\"\n\"Contributor\" shall mean Licensor and any individual or Legal Entity\non behalf of whom a Contribution has been received by Licensor and\nsubsequently incorporated within the Work.\n2. Grant of Copyright License. Subject to the terms and conditions of\nthis License, each Contributor hereby grants to You a perpetual,\nworldwide, non-exclusive, no-charge, royalty-free, irrevocable\ncopyright license to reproduce, prepare Derivative Works of,\npublicly display, publicly perform, sublicense, and distribute the\nWork and such Derivative Works in Source or Object form.\n3. Grant of Patent License. Subject to the terms and conditions of\nthis License, each Contributor hereby grants to You a perpetual,\nworldwide, non-exclusive, no-charge, royalty-free, irrevocable\n(except as stated in this section) patent license to make, have made,\nuse, offer to sell, sell, import, and otherwise transfer the Work,\nwhere such license applies only to those patent claims licensable\nby such Contributor that are necessarily infringed by their\nContribution(s) alone or by combination of their Contribution(s)\nwith the Work to which such Contribution(s) was submitted. If You\n(continuesonnextpage)\n98 AppendixC. HistoryandLicense\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\ninstitute patent litigation against any entity (including a\ncross-claim or counterclaim in a lawsuit) alleging that the Work\nor a Contribution incorporated within the Work constitutes direct\nor contributory patent infringement, then any patent licenses\ngranted to You under this License for that Work shall terminate\nas of the date such litigation is filed.\n4. Redistribution. You may reproduce and distribute copies of the\nWork or Derivative Works thereof in any medium, with or without\nmodifications, and in Source or Object form, provided that You\nmeet the following conditions:\n(a) You must give any other recipients of the Work or\nDerivative Works a copy of this License; and\n(b) You must cause any modified files to carry prominent notices\nstating that You changed the files; and\n(c) You must retain, in the Source form of any Derivative Works\nthat You distribute, all copyright, patent, trademark, and\nattribution notices from the Source form of the Work,\nexcluding those notices that do not pertain to any part of\nthe Derivative Works; and\n(d) If the Work includes a \"NOTICE\" text file as part of its\ndistribution, then any Derivative Works that You distribute must\ninclude a readable copy of the attribution notices contained\nwithin such NOTICE file, excluding those notices that do not\npertain to any part of the Derivative Works, in at least one\nof the following places: within a NOTICE text file distributed\nas part of the Derivative Works; within the Source form or\ndocumentation, if provided along with the Derivative Works; or,\nwithin a display generated by the Derivative Works, if and\nwherever such third-party notices normally appear. The contents\nof the NOTICE file are for informational purposes only and\ndo not modify the License. You may add Your own attribution\nnotices within Derivative Works that You distribute, alongside\nor as an addendum to the NOTICE text from the Work, provided\nthat such additional attribution notices cannot be construed\nas modifying the License.\nYou may add Your own copyright statement to Your modifications and\nmay provide additional or different license terms and conditions\nfor use, reproduction, or distribution of Your modifications, or\nfor any such Derivative Works as a whole, provided Your use,\nreproduction, and distribution of the Work otherwise complies with\nthe conditions stated in this License.\n5. Submission of Contributions. Unless You explicitly state otherwise,\nany Contribution intentionally submitted for inclusion in the Work\nby You to the Licensor shall be under the terms and conditions of\nthis License, without any additional terms or conditions.\nNotwithstanding the above, nothing herein shall supersede or modify\nthe terms of any separate license agreement you may have executed\nwith Licensor regarding such Contributions.\n(continuesonnextpage)\nC.3. LicensesandAcknowledgementsforIncorporatedSoftware 99\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\n6. Trademarks. This License does not grant permission to use the trade\nnames, trademarks, service marks, or product names of the Licensor,\nexcept as required for reasonable and customary use in describing the\norigin of the Work and reproducing the content of the NOTICE file.\n7. Disclaimer of Warranty. Unless required by applicable law or\nagreed to in writing, Licensor provides the Work (and each\nContributor provides its Contributions) on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or\nimplied, including, without limitation, any warranties or conditions\nof TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A\nPARTICULAR PURPOSE. You are solely responsible for determining the\nappropriateness of using or redistributing the Work and assume any\nrisks associated with Your exercise of permissions under this License.\n8. Limitation of Liability. In no event and under no legal theory,\nwhether in tort (including negligence), contract, or otherwise,\nunless required by applicable law (such as deliberate and grossly\nnegligent acts) or agreed to in writing, shall any Contributor be\nliable to You for damages, including any direct, indirect, special,\nincidental, or consequential damages of any character arising as a\nresult of this License or out of the use or inability to use the\nWork (including but not limited to damages for loss of goodwill,\nwork stoppage, computer failure or malfunction, or any and all\nother commercial damages or losses), even if such Contributor\nhas been advised of the possibility of such damages.\n9. Accepting Warranty or Additional Liability. While redistributing\nthe Work or Derivative Works thereof, You may choose to offer,\nand charge a fee for, acceptance of support, warranty, indemnity,\nor other liability obligations and/or rights consistent with this\nLicense. However, in accepting such obligations, You may act only\non Your own behalf and on Your sole responsibility, not on behalf\nof any other Contributor, and only if You agree to indemnify,\ndefend, and hold each Contributor harmless for any liability\nincurred by, or claims asserted against, such Contributor by reason\nof your accepting any such warranty or additional liability.\nEND OF TERMS AND CONDITIONS\nC.3.13 expat\nThe pyexpat extension is built using an included copy of the expat sources unless the build is configured\n--with-system-expat:\nCopyright (c) 1998, 1999, 2000 Thai Open Source Software Center Ltd\nand Clark Cooper\nPermission is hereby granted, free of charge, to any person obtaining\na copy of this software and associated documentation files (the\n\"Software\"), to deal in the Software without restriction, including\nwithout limitation the rights to use, copy, modify, merge, publish,\ndistribute, sublicense, and/or sell copies of the Software, and to\npermit persons to whom the Software is furnished to do so, subject to\nthe following conditions:\n(continuesonnextpage)\n100 AppendixC. HistoryandLicense\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nThe above copyright notice and this permission notice shall be included\nin all copies or substantial portions of the Software.\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\nMERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.\nIN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY\nCLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,\nTORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\nSOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\nC.3.14 libffi\nThe_ctypesCextensionunderlyingthectypesmoduleisbuiltusinganincludedcopyofthelibffisourcesunless\nthebuildisconfigured--with-system-libffi:\nCopyright (c) 1996-2008 Red Hat, Inc and others.\nPermission is hereby granted, free of charge, to any person obtaining\na copy of this software and associated documentation files (the\n\"Software\"), to deal in the Software without restriction, including\nwithout limitation the rights to use, copy, modify, merge, publish,\ndistribute, sublicense, and/or sell copies of the Software, and to\npermit persons to whom the Software is furnished to do so, subject to\nthe following conditions:\nThe above copyright notice and this permission notice shall be included\nin all copies or substantial portions of the Software.\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\nMERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\nHOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\nWHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER\nDEALINGS IN THE SOFTWARE.\nC.3.15 zlib\nThezlibextensionisbuiltusinganincludedcopyofthezlibsourcesifthezlibversionfoundonthesystemistoo\noldtobeusedforthebuild:\nCopyright (C) 1995-2011 Jean-loup Gailly and Mark Adler\nThis software is provided 'as-is', without any express or implied\nwarranty. In no event will the authors be held liable for any damages\narising from the use of this software.\nPermission is granted to anyone to use this software for any purpose,\nincluding commercial applications, and to alter it and redistribute it\nfreely, subject to the following restrictions:\n1. The origin of this software must not be misrepresented; you must not\nclaim that you wrote the original software. If you use this software\nin a product, an acknowledgment in the product documentation would be\n(continuesonnextpage)\nC.3. LicensesandAcknowledgementsforIncorporatedSoftware 101\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nappreciated but is not required.\n2. Altered source versions must be plainly marked as such, and must not be\nmisrepresented as being the original software.\n3. This notice may not be removed or altered from any source distribution.\nJean-loup Gailly Mark Adler\njloup@gzip.org madler@alumni.caltech.edu\nC.3.16 cfuhash\nTheimplementationofthehashtableusedbythetracemallocisbasedonthecfuhashproject:\nCopyright (c) 2005 Don Owens\nAll rights reserved.\nThis code is released under the BSD license:\nRedistribution and use in source and binary forms, with or without\nmodification, are permitted provided that the following conditions\nare met:\n* Redistributions of source code must retain the above copyright\nnotice, this list of conditions and the following disclaimer.\n* Redistributions in binary form must reproduce the above\ncopyright notice, this list of conditions and the following\ndisclaimer in the documentation and/or other materials provided\nwith the distribution.\n* Neither the name of the author nor the names of its\ncontributors may be used to endorse or promote products derived\nfrom this software without specific prior written permission.\nTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n\"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\nLIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS\nFOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE\nCOPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,\nINCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR\nSERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)\nHOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,\nSTRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\nARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED\nOF THE POSSIBILITY OF SUCH DAMAGE.\nC.3.17 libmpdec\nThe_decimalCextensionunderlyingthedecimalmoduleisbuiltusinganincludedcopyofthelibmpdeclibrary\nunlessthebuildisconfigured--with-system-libmpdec:\nCopyright (c) 2008-2020 Stefan Krah. All rights reserved.\nRedistribution and use in source and binary forms, with or without\n(continuesonnextpage)\n102 AppendixC. HistoryandLicense\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nmodification, are permitted provided that the following conditions\nare met:\n1. Redistributions of source code must retain the above copyright\nnotice, this list of conditions and the following disclaimer.\n2. Redistributions in binary form must reproduce the above copyright\nnotice, this list of conditions and the following disclaimer in the\ndocumentation and/or other materials provided with the distribution.\nTHIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS \"AS IS\" AND\nANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\nIMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\nARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE\nFOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL\nDAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS\nOR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)\nHOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT\nLIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY\nOUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF\nSUCH DAMAGE.\nC.3.18 W3C C14N test suite\nTheC14N2.0testsuiteinthetestpackage(Lib/test/xmltestdata/c14n-20/)wasretrievedfromtheW3C\nwebsiteathttps://www.w3.org/TR/xml-c14n2-testcases/andisdistributedunderthe3-clauseBSDlicense:\nCopyright (c) 2013 W3C(R) (MIT, ERCIM, Keio, Beihang),\nAll Rights Reserved.\nRedistribution and use in source and binary forms, with or without\nmodification, are permitted provided that the following conditions\nare met:\n* Redistributions of works must retain the original copyright notice,\nthis list of conditions and the following disclaimer.\n* Redistributions in binary form must reproduce the original copyright\nnotice, this list of conditions and the following disclaimer in the\ndocumentation and/or other materials provided with the distribution.\n* Neither the name of the W3C nor the names of its contributors may be\nused to endorse or promote products derived from this work without\nspecific prior written permission.\nTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n\"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\nLIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\nA PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\nOWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\nSPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\nLIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\nDATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\nTHEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\nOF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\nC.3. LicensesandAcknowledgementsforIncorporatedSoftware 103\nExtendingandEmbeddingPython,Release3.13.3\nC.3.19 mimalloc\nMITLicense:\nCopyright (c) 2018-2021 Microsoft Corporation, Daan Leijen\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\nThe above copyright notice and this permission notice shall be included in all\ncopies or substantial portions of the Software.\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\nSOFTWARE.\nC.3.20 asyncio\nPartsoftheasynciomoduleareincorporatedfromuvloop0.16,whichisdistributedundertheMITlicense:\nCopyright (c) 2015-2021 MagicStack Inc. http://magic.io\nPermission is hereby granted, free of charge, to any person obtaining\na copy of this software and associated documentation files (the\n\"Software\"), to deal in the Software without restriction, including\nwithout limitation the rights to use, copy, modify, merge, publish,\ndistribute, sublicense, and/or sell copies of the Software, and to\npermit persons to whom the Software is furnished to do so, subject to\nthe following conditions:\nThe above copyright notice and this permission notice shall be\nincluded in all copies or substantial portions of the Software.\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\nEXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\nMERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\nNONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE\nLIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\nOF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION\nWITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\nC.3.21 Global Unbounded Sequences (GUS)\nThe file Python/qsbr.c is adapted from FreeBSD\u2019s \u201cGlobal Unbounded Sequences\u201d safe memory reclamation\nschemeinsubr_smr.c. Thefileisdistributedunderthe2-ClauseBSDLicense:\nCopyright (c) 2019,2020 Jeffrey Roberson <jeff@FreeBSD.org>\nRedistribution and use in source and binary forms, with or without\nmodification, are permitted provided that the following conditions\n(continuesonnextpage)\n104 AppendixC. HistoryandLicense\nExtendingandEmbeddingPython,Release3.13.3\n(continuedfrompreviouspage)\nare met:\n1. Redistributions of source code must retain the above copyright\nnotice unmodified, this list of conditions, and the following\ndisclaimer.\n2. Redistributions in binary form must reproduce the above copyright\nnotice, this list of conditions and the following disclaimer in the\ndocumentation and/or other materials provided with the distribution.\nTHIS SOFTWARE IS PROVIDED BY THE AUTHOR \"AS IS\" AND ANY EXPRESS OR\nIMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES\nOF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\nIN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,\nINCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\nNOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\nDATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\nTHEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF\nTHIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\nC.3. LicensesandAcknowledgementsforIncorporatedSoftware 105\nExtendingandEmbeddingPython,Release3.13.3\n106 AppendixC. HistoryandLicense\nAPPENDIX\nD\nCOPYRIGHT\nPythonandthisdocumentationis:\nCopyright\u00a92001-2024PythonSoftwareFoundation. Allrightsreserved.\nCopyright\u00a92000BeOpen.com. Allrightsreserved.\nCopyright\u00a91995-2000CorporationforNationalResearchInitiatives. Allrightsreserved.\nCopyright\u00a91991-1995StichtingMathematischCentrum. Allrightsreserved.\nSeeHistoryandLicenseforcompletelicenseandpermissionsinformation.\n107\nExtendingandEmbeddingPython,Release3.13.3\n108 AppendixD. Copyright\nINDEX\nNon-alphabetical\ndecorator,70\n...,67\ndescriptor,71\n>>>,67\ndictionary,71\n__future__,73 dictionary comprehension,71\n__slots__,80 dictionary view,71\ndocstring,71\nA\nduck-typing,71\nabstract base class,67\nE\nannotation,67\nargument,67 EAFP,71\nasynchronous context manager,68 environment variable\nasynchronous generator,68 PYTHON_GIL,74\nasynchronous generator iterator,68 PYTHONPATH,56\nasynchronous iterable,68 expression,71\nasynchronous iterator,68 extension module,72\nattribute,68\nF\nawaitable,68\nB f-string,72\nfile object,72\nBDFL,68 file-like object,72\nbinary file,68 filesystem encoding and error handler,72\nborrowed reference,68 finalization, of objects,49\nbuilt-in function finder,72\nrepr,50 floor division,72\nbytecode,69 Fortran contiguous,70\nbytes-like object,69 free threading,72\nC free variable,72\nfunction,72\ncallable,69\nfunction annotation,72\ncallback,69\nC-contiguous,70 G\nclass,69\ngarbage collection,73\nclass variable,69\ngenerator,73\nclosure variable,69\ngenerator expression,73\ncomplex number,70\ngenerator iterator,73\ncontext,70\ngeneric function,73\ncontext management protocol,70\ngeneric type,73\ncontext manager,70\nGIL,73\ncontext variable,70\nglobal interpreter lock,74\ncontiguous,70\ncoroutine,70 H\ncoroutine function,70\nhash-based pyc,74\nCPython,70\nhashable,74\ncurrent context,70\nD I\ndeallocation, object,49 IDLE,74\n109\nExtendingandEmbeddingPython,Release3.13.3\nimmortal,74 path entry finder,79\nimmutable,74 path entry hook,79\nimport path,74 path-like object,79\nimporter,74 PEP,79\nimporting,74 Philbrick, Geoff,15\ninteractive,74 portion,79\ninterpreted,75 positional argument,79\ninterpreter shutdown,75 provisional API,79\niterable,75 provisional package,79\niterator,75 PyArg_ParseTuple(Cfunction),13\nPyArg_ParseTupleAndKeywords(Cfunction),14\nK\nPyErr_Fetch(Cfunction),49\nkey function,75 PyErr_Restore(Cfunction),49\nkeyword argument,75 PyInit_modulename(Cfunction),56\nPyObject_CallObject(Cfunction),12\nL\nPython 3000,79\nlambda,76 Python Enhancement Proposals\nLBYL,76 PEP 1,79\nlexical analyzer,76 PEP 238,72\nlist,76 PEP 278,82\nlist comprehension,76 PEP 302,76\nloader,76 PEP 343,70\nlocale encoding,76 PEP 362,68,79\nPEP 411,79\nM\nPEP 420,78,79\nPEP 442,50\nmagic\nmethod,76 PEP 443,73\nmagic method,76 PEP 483,73\nmapping,76 PEP 484,67,73,82,83\nmeta path finder,76 PEP 489,11,56\nmetaclass,76 PEP 492,68,70\nmethod,77 PEP 498,72\nmagic,76 PEP 519,79\nspecial,81 PEP 525,68\nmethod resolution order,77 PEP 526,67,83\nmodule,77 PEP 585,73\nmodule spec,77 PEP 683,74\nMRO,77 PEP 703,72,74\nmutable,77 PEP 3116,82\nPEP 3155,80\nN PYTHON_GIL,74\nnamed tuple,77\nPythonic,80\nnamespace,77\nPYTHONPATH,56\nnamespace package,77\nQ\nnested scope,78\nnew-style class,78 qualified name,80\nO R\nobject,78 reference count,80\ndeallocation,49 regular package,80\nfinalization,49 REPL,80\noptimized scope,78 repr\nbuilt-in function,50\nP\nS\npackage,78\nparameter,78 sequence,80\npath based finder,79 set comprehension,81\npath entry,79 single dispatch,81\n110 Index\nExtendingandEmbeddingPython,Release3.13.3\nslice,81\nsoft deprecated,81\nspecial\nmethod,81\nspecial method,81\nstatement,81\nstatic type checker,81\nstring\nobject representation,50\nstrong reference,81\nT\ntext encoding,81\ntext file,81\ntoken,82\ntriple-quoted string,82\ntype,82\ntype alias,82\ntype hint,82\nU\nuniversal newlines,82\nV\nvariable annotation,82\nvirtual environment,83\nvirtual machine,83\nZ\nZen of Python,83\nIndex 111\n",
  "context": "2.1.1 ASimpleExample . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 5\n2.1.2 Intermezzo: ErrorsandExceptions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 6\n2.1.3 BacktotheExample . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 8",
  "source_file": "resources\\Year 3\\Python\\extending.pdf",
  "line_numbers": [
    15,
    4842
  ]
}